# 🤖 AI Agent 工作指南

## 📋 項目概覽
**項目名稱：** Notion Smart Clipper  
**項目類型：** Chrome Extension (Manifest V3)  
**主要語言：** JavaScript, HTML, CSS  
**核心功能：** 網頁內容保存到 Notion，智能文本標記

---

## 🎯 AI Agent 工作原則

### 🚀 **核心工作模式**
1. **漸進式問題解決**
   - 優先修復當前問題，再考慮功能擴展
   - 每次更改都要確保向後兼容
   - 先實現基本功能，再優化用戶體驗

2. **調試優先原則**
   - 所有新功能都要包含詳細的調試日誌
   - 錯誤處理要友好且信息豐富
   - 使用漸進式回退機制處理複雜情況

3. **文檔同步更新**
   - 代碼更改後立即更新相關文檔
   - 版本號更新要同步到所有相關文件
   - 保持 README、help.html、manifest.json 的一致性

4. **項目計劃遵循**
   - 按照 PROJECT_ROADMAP.md 中的優先級開發
   - 高優先級功能優先實現
   - 考慮功能間的依賴關係

---

## 🏗️ 項目架構理解

### 📁 **文件結構和職責**
```
notion-chrome/
├── manifest.json          # 擴展配置和權限
├── scripts/
│   ├── background.js      # 背景腳本，API 調用和數據處理
│   ├── content.js         # 內容腳本，頁面內容提取
│   └── highlighter.js     # 文本標記核心邏輯
├── popup/
│   ├── popup.html         # 彈出窗口界面
│   ├── popup.js           # 彈出窗口邏輯
│   └── popup.css          # 彈出窗口樣式
├── options/
│   ├── options.html       # 設置頁面
│   ├── options.js         # 設置頁面邏輯
│   └── options.css        # 設置頁面樣式
└── lib/
    └── Readability.js     # 第三方內容提取庫
```

### 🔧 **核心組件理解**

#### `scripts/highlighter.js` - 文本標記系統
- **核心方法：** `handleSelection()` - 主要入口
- **選擇策略：** 簡單選擇 vs 複雜選擇
- **回退機制：** 6層漸進式處理
  1. 標準 `surroundContents()`
  2. 內容提取法 `extractContents()`
  3. 克隆內容法 `cloneContents()`
  4. 文本替換法
  5. 片段重建法 `fragmentReconstructionHighlight()`
  6. 分割節點法 `splitNodeHighlight()`
  7. 超級安全模式 `superSafeHighlight()`

#### `scripts/background.js` - 後台處理
- **API 集成：** Notion API 調用和錯誤處理
- **圖片處理：** URL 清理和驗證
- **數據管理：** 存儲、優化、備份

#### `scripts/content.js` - 內容提取
- **智能提取：** Readability.js 集成
- **圖片處理：** 懶加載、響應式、代理URL
- **DOM 操作：** 安全的頁面內容讀取

---

## 💻 編程規範和偏好

### 🎨 **代碼風格**
1. **命名約定**
   - 使用駝峰命名法 (camelCase)
   - 函數名要描述性強：`handleSelection()`, `wrapComplexSelection()`
   - 變量名要清晰：`selectedText`, `highlightSpan`, `commonAncestor`

2. **註釋規範**
   - 中文註釋，清晰易懂
   - 每個重要方法都要有功能描述
   - 複雜邏輯要有步驟說明
   - 錯誤處理要說明原因

3. **錯誤處理**
   - 使用 try-catch 包裹可能失敗的操作
   - 錯誤信息要具體且可操作
   - 提供多層回退方案
   - 記錄詳細的調試信息

### 🔧 **技術偏好**

#### DOM 操作
- **優先使用：** 原生 JavaScript API
- **避免使用：** jQuery 或其他大型庫
- **安全原則：** 所有 DOM 操作都要有錯誤處理
- **性能考慮：** 批量操作勝過多次單個操作

#### 異步處理
- **優先使用：** async/await 語法
- **錯誤處理：** try-catch 配合 Promise.catch()
- **超時處理：** 重要操作都要設置超時

#### 存儲管理
- **優先使用：** Chrome Extension Storage API
- **數據結構：** JSON 格式，保持向後兼容
- **清理策略：** 定期清理無效數據

---

## 🛠️ 開發工作流程

### 🔄 **標準修改流程**
1. **問題分析**
   - 理解用戶報告的具體問題
   - 檢查現有代碼的相關部分
   - 確定影響範圍和兼容性需求

2. **解決方案設計**
   - 設計多層回退方案
   - 考慮邊緣情況和錯誤處理
   - 保證現有功能不受影響

3. **代碼實現**
   - 添加詳細的調試日誌
   - 實現主要功能和回退機制
   - 包含完善的錯誤處理

4. **測試和驗證**
   - 在不同網站測試功能
   - 檢查控制台日誌
   - 驗證邊緣情況處理

5. **文檔更新**
   - 更新版本號
   - 修改相關文檔和幫助
   - 提交清晰的 Git 消息

### 📝 **Git 提交規範**
```
v2.4.x: 功能描述

- 具體修改項目1
- 具體修改項目2  
- 修復的問題描述
- 增強的功能說明
```

### 📄 **Release Notes 編寫規範**
1. **貢獻者說明**
   - ❌ 不要加入 "AI Assistant" 或 "User" 作為貢獻者
   - ✅ 只列出實際的人類開發者或貢獻者名字（如有）
   - ✅ 如果是個人項目，可以省略貢獻者部分

2. **功能狀態說明**
   - ❌ 不要列出"用戶決定不實現的功能"
   - ✅ 只列出已實現（✅）或計劃實現（🎯）的功能
   - ✅ 未實現且無計劃的功能應從列表中移除

3. **內容焦點**
   - 專注於用戶可見的功能改進
   - 清楚說明技術實現的用戶價值
   - 提供實際使用場景和示例

---

## 🎯 工作優先級指導

### 🔴 **最高優先級**
1. **修復破壞性bug** - 影響核心功能的問題
2. **安全漏洞** - 可能造成數據洩露的問題  
3. **兼容性問題** - 導致擴展無法使用的問題

### 🟡 **高優先級**
1. **用戶體驗改進** - 讓功能更易用
2. **性能優化** - 提升響應速度
3. **功能增強** - 在現有基礎上擴展

### 🟢 **中等優先級**
1. **代碼重構** - 提高維護性
2. **文檔完善** - 改進使用說明
3. **測試覆蓋** - 增加自動化測試

### 🔵 **低優先級** 
1. **新功能開發** - 全新的功能模塊
2. **UI 美化** - 視覺效果改進
3. **實驗性功能** - 探索性的新技術

---

## 🧠 問題解決策略

### 📊 **跨元素標記問題**
**當前狀況：** 需要先進行單元素標記，再進行跨元素標記  
**根本原因：** `range.surroundContents()` 無法處理跨兄弟節點的選擇  
**解決方向：** 
1. DOM 片段提取和重建
2. 自定義範圍分割算法  
3. 虛擬節點包裝技術

### 🖼️ **圖片處理問題**
**核心策略：** URL 清理 + 格式驗證 + 錯誤回退  
**處理步驟：**
1. 清理代理 URL 和重複參數
2. 驗證圖片格式和可訪問性
3. 提供友好的錯誤信息

### ⚡ **性能優化策略**
**監控重點：** 大型頁面處理時間、內存使用、響應延遲  
**優化方向：**
1. 分批處理大量內容
2. 懶加載非關鍵資源
3. 緩存重複計算結果

---

## 📋 常用代碼模式

### 🎨 **標準錯誤處理模式**
```javascript
try {
    // 主要邏輯
    console.log('執行主要操作');
    // ... 操作代碼
    console.log('操作成功完成');
} catch (error) {
    console.log('操作失敗，嘗試備用方案:', error.message);
    // 備用邏輯
}
```

### 🔧 **DOM 操作安全模式**
```javascript
if (element && element.nodeType === Node.ELEMENT_NODE) {
    try {
        // DOM 操作
    } catch (error) {
        console.warn('DOM操作失敗:', error.message);
        // 回退方案
    }
}
```

### 📡 **API 調用模式**
```javascript
async function callNotionAPI(data) {
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { /* headers */ },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`API 調用失敗: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API 錯誤:', error.message);
        throw error;
    }
}
```

---

## 🎯 預期工作成果

### 📈 **代碼質量標準**
- **可讀性：** 註釋清楚，邏輯結構清晰
- **穩定性：** 完善的錯誤處理和回退機制
- **可維護性：** 模塊化設計，職責分離
- **性能：** 響應時間 < 2秒，內存使用合理

### 📚 **文檔標準**
- **完整性：** 所有功能都有使用說明
- **準確性：** 文檔與實際功能一致
- **友好性：** 面向用戶，語言通俗易懂
- **及時性：** 與代碼更新同步

### 🔄 **更新頻率**
- **緊急修復：** 1-2 天內發布
- **功能改進：** 1-2 週內發布  
- **大版本更新：** 1-2 月內發布
- **文檔同步：** 每次代碼更改後立即更新

---

## 📝 備註和提醒

### ⚠️ **重要提醒**
1. **向後兼容：** 新版本必須能處理舊版本的數據
2. **權限最小化：** 只申請必需的 Chrome 權限
3. **用戶隱私：** 不收集不必要的用戶數據
4. **錯誤上報：** 提供清晰的錯誤信息，但不暴露敏感信息

### 🎯 **成功指標**
- 用戶能夠不查看文檔就使用核心功能
- 錯誤情況下有明確的解決指導
- 新功能不破壞現有工作流程  
- 代碼修改後功能更穩定而不是更不穩定

---

## 🗺️ **項目發展計劃**

### 📊 **開發優先級參考**
參見 `PROJECT_ROADMAP.md` 文檔中的詳細計劃：

#### 🔴 **高優先級 (v2.5.x)**
1. **保存後提供打開頁面** - 極大提升用戶體驗
2. **按鈕顯示保存狀態** - 防止重複保存，狀態清晰
3. **擷取網站 Icon** - 視覺體驗改善
4. **商店更新說明彈出** - 用戶溝通改善

#### 🟡 **中優先級 (v2.6.x)**
1. **內容快取機制** - 性能提升
2. **改善錯誤處理** - 系統穩定性
3. **Notion OAuth 授權** - 簡化用戶設置
4. **Google Drive 雲端備份** - 跨設備同步，零運營成本

#### 🔵 **長期計劃 (v2.7.x+)**
1. **圖片上載功能** - 完整內容保存，需考慮商業模式

### 🎯 **開發指導原則**
1. **短期優先**：優先實現高價值、低風險的功能
2. **用戶反饋**：每個版本後收集反饋調整計劃
3. **技術可行性**：評估資源需求和技術風險
4. **商業考量**：長期功能需考慮運營成本

---

*🤖 此文檔幫助 AI Agent 更好地理解項目背景和工作要求，提高工作效率和成果質量。*

---

**最後更新：** 2025年9月29日  
**文檔版本：** v1.1  
**對應項目版本：** v2.4.8