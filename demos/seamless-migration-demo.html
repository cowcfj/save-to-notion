<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç—›é·ç§»æ¼”ç¤º - Notion Smart Clipper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #0c5460;
        }
        
        .demo-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        
        .demo-section h2 {
            margin-top: 0;
            color: #007bff;
        }
        
        .content-box {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin: 15px 0;
            min-height: 150px;
        }
        
        .content-box p {
            margin: 10px 0;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .status {
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #007bff;
        }
        
        .timeline-item {
            position: relative;
            padding: 10px 0;
        }
        
        .timeline-item::before {
            content: 'â—';
            position: absolute;
            left: -24px;
            color: #007bff;
            font-size: 20px;
        }
        
        .timeline-item.completed::before {
            color: #28a745;
        }
        
        .timeline-item.active::before {
            color: #ffc107;
        }
        
        /* èˆŠç‰ˆæ¨™è¨»æ¨£å¼ */
        .simple-highlight {
            cursor: pointer;
        }
        
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ ç„¡ç—›è‡ªå‹•é·ç§»æ¼”ç¤º</h1>
    
    <div class="info-box">
        <strong>æ¼”ç¤ºèªªæ˜ï¼š</strong>
        <p>æœ¬é é¢æ¼”ç¤ºæ–°ç‰ˆæ¨™è¨»åŠŸèƒ½çš„ã€Œç„¡ç—›è‡ªå‹•é·ç§»ã€æ©Ÿåˆ¶ã€‚</p>
        <ul>
            <li>âœ¨ <strong>ç”¨æˆ¶é›¶æ„ŸçŸ¥</strong>ï¼šå®Œå…¨è‡ªå‹•åŒ–ï¼Œç„¡éœ€ä»»ä½•æ“ä½œ</li>
            <li>ğŸ›¡ï¸ <strong>åˆ†éšæ®µé·ç§»</strong>ï¼šå®‰å…¨é©—è­‰ï¼Œæ™ºèƒ½å›é€€</li>
            <li>ğŸ’¾ <strong>é›¶æ•¸æ“šä¸Ÿå¤±</strong>ï¼šæ–°èˆŠå…±å­˜ï¼Œç¢ºèªç„¡èª¤æ‰æ¸…ç†</li>
        </ul>
    </div>

    <!-- æ¼”ç¤ºæ­¥é©Ÿ -->
    <div class="demo-section">
        <h2>ğŸ“ æ¼”ç¤ºæ­¥é©Ÿ</h2>
        
        <div class="controls">
            <h3>æ­¥é©Ÿ 1: å‰µå»ºèˆŠç‰ˆæ¨™è¨»</h3>
            <button onclick="createOldHighlights()">å‰µå»º5å€‹èˆŠç‰ˆæ¨™è¨»</button>
            <button class="secondary" onclick="showDOM()">æŸ¥çœ‹DOMçµæ§‹</button>
        </div>
        
        <div class="controls">
            <h3>æ­¥é©Ÿ 2: æ¨¡æ“¬é é¢é¦–æ¬¡åŠ è¼‰ï¼ˆéšæ®µ1ï¼‰</h3>
            <button class="success" onclick="simulatePhase1()">åŸ·è¡Œéšæ®µ1é·ç§»</button>
            <button class="secondary" onclick="showDOM()">æŸ¥çœ‹DOMè®ŠåŒ–</button>
            <div id="phase1-status" class="status" style="display:none;"></div>
        </div>
        
        <div class="controls">
            <h3>æ­¥é©Ÿ 3: æ¨¡æ“¬ç¬¬äºŒæ¬¡åŠ è¼‰ï¼ˆéšæ®µ2+3ï¼‰</h3>
            <button class="success" onclick="simulatePhase2()">åŸ·è¡Œéšæ®µ2é©—è­‰</button>
            <button class="success" onclick="simulatePhase3()">åŸ·è¡Œéšæ®µ3æ¸…ç†</button>
            <button class="secondary" onclick="showDOM()">æŸ¥çœ‹æœ€çµ‚çµæœ</button>
            <div id="phase2-status" class="status" style="display:none;"></div>
        </div>
        
        <div class="controls">
            <h3>é‡ç½®æ¼”ç¤º</h3>
            <button class="danger" onclick="resetDemo()">æ¸…é™¤æ‰€æœ‰ä¸¦é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <!-- æ¸¬è©¦å…§å®¹ -->
    <div class="demo-section">
        <h2>ğŸ“„ æ¸¬è©¦å…§å®¹</h2>
        <div class="content-box" id="test-content">
            <h3>ç¤ºä¾‹æ–‡ç« </h3>
            <p>é€™æ˜¯ç¬¬ä¸€æ®µæ–‡æœ¬ï¼ŒåŒ…å«ä¸€äº›<strong>é‡è¦å…§å®¹</strong>å¯ä»¥è¢«æ¨™è¨»ã€‚</p>
            <p>é€™æ˜¯ç¬¬äºŒæ®µï¼Œæœ‰<em>ä¸åŒçš„æ ¼å¼</em>å’Œ<code>ä»£ç¢¼ç‰‡æ®µ</code>éœ€è¦æ¸¬è©¦ã€‚</p>
            <blockquote style="border-left: 4px solid #007bff; padding-left: 15px; color: #666;">
                é€™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡å­—ï¼Œæ¸¬è©¦åœ¨ç‰¹æ®Šå…ƒç´ ä¸­çš„æ¨™è¨»æ•ˆæœã€‚
            </blockquote>
            <p>é€™æ˜¯ç¬¬ä¸‰æ®µï¼Œç”¨æ–¼æ¸¬è©¦è·¨æ®µè½æ¨™è¨»çš„æƒ…æ³ã€‚</p>
        </div>
    </div>

    <!-- é·ç§»æ™‚é–“ç·š -->
    <div class="demo-section">
        <h2>ğŸ“Š é·ç§»é€²åº¦</h2>
        <div class="timeline" id="timeline">
            <div class="timeline-item" id="timeline-0">
                â³ ç­‰å¾…é–‹å§‹...
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆä¿¡æ¯ -->
    <div class="demo-section">
        <h2>ğŸ“ˆ çµ±è¨ˆä¿¡æ¯</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">èˆŠæ¨™è¨»æ•¸é‡</div>
                <div class="number" id="stat-old">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æ–°æ¨™è¨»æ•¸é‡</div>
                <div class="number" id="stat-new">0</div>
            </div>
            <div class="stat-card">
                <div class="label">éš±è—çš„èˆŠæ¨™è¨»</div>
                <div class="number" id="stat-hidden">0</div>
            </div>
            <div class="stat-card">
                <div class="label">é·ç§»éšæ®µ</div>
                <div class="number" id="stat-phase" style="font-size: 18px;">æœªé–‹å§‹</div>
            </div>
        </div>
    </div>

    <!-- DOMæŸ¥çœ‹å™¨ -->
    <div class="demo-section" style="display:none;" id="dom-viewer">
        <h2>ğŸ” DOMçµæ§‹æŸ¥çœ‹å™¨</h2>
        <button onclick="closeDOMViewer()" class="secondary">é—œé–‰</button>
        <div class="code-block" id="dom-content"></div>
    </div>

    <!-- Mock Storage -->
    <script>
        window.StorageUtil = {
            saveHighlights: async function(url, data) {
                localStorage.setItem(`highlights_${url}`, JSON.stringify(data));
            },
            loadHighlights: async function(url) {
                const data = localStorage.getItem(`highlights_${url}`);
                return data ? JSON.parse(data) : null;
            },
            clearHighlights: function(url) {
                localStorage.removeItem(`highlights_${url}`);
            }
        };

        // å…¨å±€ç‹€æ…‹
        let demoState = {
            phase: 0,
            oldHighlights: [],
            newHighlights: [],
            hiddenSpans: []
        };

        // å‰µå»ºèˆŠç‰ˆæ¨™è¨»
        function createOldHighlights() {
            const content = document.getElementById('test-content');
            const paragraphs = content.querySelectorAll('p');
            
            // æ¸…é™¤ç¾æœ‰æ¨™è¨»
            content.querySelectorAll('.simple-highlight').forEach(s => {
                const parent = s.parentNode;
                while (s.firstChild) parent.insertBefore(s.firstChild, s);
                parent.removeChild(s);
            });
            
            let count = 0;
            paragraphs.forEach((p, index) => {
                if (index < 3) {
                    const text = p.textContent;
                    const start = Math.floor(text.length * 0.2);
                    const end = Math.floor(text.length * 0.6);
                    
                    const range = document.createRange();
                    const textNode = p.firstChild;
                    if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                        range.setStart(textNode, start);
                        range.setEnd(textNode, end);
                        
                        try {
                            const span = document.createElement('span');
                            span.className = 'simple-highlight';
                            span.style.backgroundColor = '#fff3cd';
                            span.style.cursor = 'pointer';
                            
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                            
                            demoState.oldHighlights.push(span);
                            count++;
                        } catch (e) {
                            console.log('æ¨™è¨»å¤±æ•—:', e);
                        }
                    }
                }
            });
            
            updateTimeline([
                `âœ… å‰µå»ºäº† ${count} å€‹èˆŠç‰ˆæ¨™è¨»`,
                `ğŸ“ ä½¿ç”¨äº† DOM æ“ä½œï¼ˆ<span> å…ƒç´ ï¼‰`
            ]);
            updateStats();
            showStatus('phase1', `æˆåŠŸå‰µå»º ${count} å€‹èˆŠç‰ˆæ¨™è¨»`, 'success');
        }

        // æ¨¡æ“¬éšæ®µ1
        async function simulatePhase1() {
            showStatus('phase1', 'â³ æ­£åœ¨åŸ·è¡Œéšæ®µ1é·ç§»...', 'info');
            
            await sleep(500);
            
            const oldSpans = document.querySelectorAll('.simple-highlight');
            let created = 0;
            
            demoState.newHighlights = [];
            
            oldSpans.forEach(span => {
                // æ¨¡æ“¬å‰µå»ºæ–°Rangeï¼ˆå¯¦éš›ä¸Šåªæ˜¯æ¨™è¨˜ï¼‰
                span.setAttribute('data-migrated', 'true');
                span.setAttribute('data-new-id', `highlight-${++created}`);
                span.style.opacity = '0';
                span.style.pointerEvents = 'none';
                
                demoState.hiddenSpans.push(span);
                demoState.newHighlights.push({
                    id: `highlight-${created}`,
                    text: span.textContent
                });
            });
            
            updateTimeline([
                `âœ… éšæ®µ1å®Œæˆ`,
                `ğŸ“¦ å‰µå»ºäº† ${created} å€‹æ–°æ¨™è¨»ï¼ˆCSS Highlight APIï¼‰`,
                `ğŸ‘» éš±è—äº† ${created} å€‹èˆŠspanï¼ˆopacity:0ï¼‰`,
                `ğŸ’¾ èˆŠspanä¿ç•™åœ¨DOMä¸­ï¼Œä»¥å‚™å›é€€`
            ]);
            
            demoState.phase = 1;
            updateStats();
            showStatus('phase1', `âœ… éšæ®µ1å®Œæˆï¼å‰µå»ºäº† ${created} å€‹æ–°æ¨™è¨»ï¼ŒèˆŠæ¨™è¨»å·²éš±è—`, 'success');
        }

        // æ¨¡æ“¬éšæ®µ2
        async function simulatePhase2() {
            if (demoState.phase < 1) {
                showStatus('phase2', 'âŒ è«‹å…ˆåŸ·è¡Œéšæ®µ1', 'error');
                return;
            }
            
            showStatus('phase2', 'â³ æ­£åœ¨é©—è­‰æ–°æ¨™è¨»...', 'info');
            
            await sleep(500);
            
            // æ¨¡æ“¬é©—è­‰
            const verified = demoState.newHighlights.length;
            
            updateTimeline([
                `âœ… éšæ®µ2å®Œæˆ`,
                `ğŸ” é©—è­‰äº† ${verified} å€‹æ–°æ¨™è¨»`,
                `âœ“ æ‰€æœ‰æ–°æ¨™è¨»æ¢å¾©æ­£å¸¸`,
                `â¡ï¸ å¯ä»¥å®‰å…¨é€²å…¥éšæ®µ3`
            ]);
            
            demoState.phase = 2;
            updateStats();
            showStatus('phase2', `âœ… éšæ®µ2å®Œæˆï¼é©—è­‰äº† ${verified} å€‹æ–°æ¨™è¨»`, 'success');
        }

        // æ¨¡æ“¬éšæ®µ3
        async function simulatePhase3() {
            if (demoState.phase < 2) {
                showStatus('phase2', 'âŒ è«‹å…ˆå®Œæˆéšæ®µ2é©—è­‰', 'error');
                return;
            }
            
            showStatus('phase2', 'â³ æ­£åœ¨ç§»é™¤èˆŠæ¨™è¨»...', 'info');
            
            await sleep(500);
            
            // ç§»é™¤èˆŠspan
            let removed = 0;
            demoState.hiddenSpans.forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
                parent.normalize();
                removed++;
            });
            
            demoState.hiddenSpans = [];
            demoState.oldHighlights = [];
            
            updateTimeline([
                `ğŸ‰ éšæ®µ3å®Œæˆ`,
                `ğŸ—‘ï¸ ç§»é™¤äº† ${removed} å€‹èˆŠspanå…ƒç´ `,
                `âœ¨ DOMçµæ§‹å·²å®Œå…¨æ¢å¾©ä¹¾æ·¨`,
                `âœ… é·ç§»å…¨éƒ¨å®Œæˆï¼`
            ]);
            
            demoState.phase = 3;
            updateStats();
            showStatus('phase2', `ğŸ‰ é·ç§»å®Œæˆï¼DOMå·²æ¸…ç†ï¼Œå…±ç§»é™¤ ${removed} å€‹èˆŠæ¨™è¨»`, 'success');
        }

        // é‡ç½®æ¼”ç¤º
        function resetDemo() {
            const content = document.getElementById('test-content');
            content.querySelectorAll('.simple-highlight').forEach(s => {
                const parent = s.parentNode;
                while (s.firstChild) parent.insertBefore(s.firstChild, s);
                parent.removeChild(s);
                parent.normalize();
            });
            
            demoState = {
                phase: 0,
                oldHighlights: [],
                newHighlights: [],
                hiddenSpans: []
            };
            
            updateTimeline(['â³ ç­‰å¾…é–‹å§‹...']);
            updateStats();
            document.getElementById('phase1-status').style.display = 'none';
            document.getElementById('phase2-status').style.display = 'none';
        }

        // é¡¯ç¤ºDOM
        function showDOM() {
            const content = document.getElementById('test-content');
            const html = content.innerHTML
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            document.getElementById('dom-content').innerHTML = html;
            document.getElementById('dom-viewer').style.display = 'block';
        }

        function closeDOMViewer() {
            document.getElementById('dom-viewer').style.display = 'none';
        }

        // æ›´æ–°æ™‚é–“ç·š
        function updateTimeline(items) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = items.map((item, index) => 
                `<div class="timeline-item completed">${item}</div>`
            ).join('');
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            document.getElementById('stat-old').textContent = 
                document.querySelectorAll('.simple-highlight:not([data-migrated])').length;
            document.getElementById('stat-new').textContent = demoState.newHighlights.length;
            document.getElementById('stat-hidden').textContent = demoState.hiddenSpans.length;
            
            const phases = ['æœªé–‹å§‹', 'éšæ®µ1', 'éšæ®µ2', 'å·²å®Œæˆ'];
            document.getElementById('stat-phase').textContent = phases[demoState.phase] || 'æœªé–‹å§‹';
        }

        // é¡¯ç¤ºç‹€æ…‹
        function showStatus(id, message, type) {
            const el = document.getElementById(`${id}-status`);
            el.textContent = message;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }

        // å»¶é²å‡½æ•¸
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆå§‹åŒ–
        updateStats();
    </script>
</body>
</html>
