<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無痛遷移演示 - Notion Smart Clipper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #0c5460;
        }
        
        .demo-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        
        .demo-section h2 {
            margin-top: 0;
            color: #007bff;
        }
        
        .content-box {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin: 15px 0;
            min-height: 150px;
        }
        
        .content-box p {
            margin: 10px 0;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .status {
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #007bff;
        }
        
        .timeline-item {
            position: relative;
            padding: 10px 0;
        }
        
        .timeline-item::before {
            content: '●';
            position: absolute;
            left: -24px;
            color: #007bff;
            font-size: 20px;
        }
        
        .timeline-item.completed::before {
            color: #28a745;
        }
        
        .timeline-item.active::before {
            color: #ffc107;
        }
        
        /* 舊版標註樣式 */
        .simple-highlight {
            cursor: pointer;
        }
        
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>🔄 無痛自動遷移演示</h1>
    
    <div class="info-box">
        <strong>演示說明：</strong>
        <p>本頁面演示新版標註功能的「無痛自動遷移」機制。</p>
        <ul>
            <li>✨ <strong>用戶零感知</strong>：完全自動化，無需任何操作</li>
            <li>🛡️ <strong>分階段遷移</strong>：安全驗證，智能回退</li>
            <li>💾 <strong>零數據丟失</strong>：新舊共存，確認無誤才清理</li>
        </ul>
    </div>

    <!-- 演示步驟 -->
    <div class="demo-section">
        <h2>📝 演示步驟</h2>
        
        <div class="controls">
            <h3>步驟 1: 創建舊版標註</h3>
            <button onclick="createOldHighlights()">創建5個舊版標註</button>
            <button class="secondary" onclick="showDOM()">查看DOM結構</button>
        </div>
        
        <div class="controls">
            <h3>步驟 2: 模擬頁面首次加載（階段1）</h3>
            <button class="success" onclick="simulatePhase1()">執行階段1遷移</button>
            <button class="secondary" onclick="showDOM()">查看DOM變化</button>
            <div id="phase1-status" class="status" style="display:none;"></div>
        </div>
        
        <div class="controls">
            <h3>步驟 3: 模擬第二次加載（階段2+3）</h3>
            <button class="success" onclick="simulatePhase2()">執行階段2驗證</button>
            <button class="success" onclick="simulatePhase3()">執行階段3清理</button>
            <button class="secondary" onclick="showDOM()">查看最終結果</button>
            <div id="phase2-status" class="status" style="display:none;"></div>
        </div>
        
        <div class="controls">
            <h3>重置演示</h3>
            <button class="danger" onclick="resetDemo()">清除所有並重新開始</button>
        </div>
    </div>

    <!-- 測試內容 -->
    <div class="demo-section">
        <h2>📄 測試內容</h2>
        <div class="content-box" id="test-content">
            <h3>示例文章</h3>
            <p>這是第一段文本，包含一些<strong>重要內容</strong>可以被標註。</p>
            <p>這是第二段，有<em>不同的格式</em>和<code>代碼片段</code>需要測試。</p>
            <blockquote style="border-left: 4px solid #007bff; padding-left: 15px; color: #666;">
                這是一段引用文字，測試在特殊元素中的標註效果。
            </blockquote>
            <p>這是第三段，用於測試跨段落標註的情況。</p>
        </div>
    </div>

    <!-- 遷移時間線 -->
    <div class="demo-section">
        <h2>📊 遷移進度</h2>
        <div class="timeline" id="timeline">
            <div class="timeline-item" id="timeline-0">
                ⏳ 等待開始...
            </div>
        </div>
    </div>

    <!-- 統計信息 -->
    <div class="demo-section">
        <h2>📈 統計信息</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">舊標註數量</div>
                <div class="number" id="stat-old">0</div>
            </div>
            <div class="stat-card">
                <div class="label">新標註數量</div>
                <div class="number" id="stat-new">0</div>
            </div>
            <div class="stat-card">
                <div class="label">隱藏的舊標註</div>
                <div class="number" id="stat-hidden">0</div>
            </div>
            <div class="stat-card">
                <div class="label">遷移階段</div>
                <div class="number" id="stat-phase" style="font-size: 18px;">未開始</div>
            </div>
        </div>
    </div>

    <!-- DOM查看器 -->
    <div class="demo-section" style="display:none;" id="dom-viewer">
        <h2>🔍 DOM結構查看器</h2>
        <button onclick="closeDOMViewer()" class="secondary">關閉</button>
        <div class="code-block" id="dom-content"></div>
    </div>

    <!-- Mock Storage -->
    <script>
        window.StorageUtil = {
            saveHighlights: async function(url, data) {
                localStorage.setItem(`highlights_${url}`, JSON.stringify(data));
            },
            loadHighlights: async function(url) {
                const data = localStorage.getItem(`highlights_${url}`);
                return data ? JSON.parse(data) : null;
            },
            clearHighlights: function(url) {
                localStorage.removeItem(`highlights_${url}`);
            }
        };

        // 全局狀態
        let demoState = {
            phase: 0,
            oldHighlights: [],
            newHighlights: [],
            hiddenSpans: []
        };

        // 創建舊版標註
        function createOldHighlights() {
            const content = document.getElementById('test-content');
            const paragraphs = content.querySelectorAll('p');
            
            // 清除現有標註
            content.querySelectorAll('.simple-highlight').forEach(s => {
                const parent = s.parentNode;
                while (s.firstChild) parent.insertBefore(s.firstChild, s);
                parent.removeChild(s);
            });
            
            let count = 0;
            paragraphs.forEach((p, index) => {
                if (index < 3) {
                    const text = p.textContent;
                    const start = Math.floor(text.length * 0.2);
                    const end = Math.floor(text.length * 0.6);
                    
                    const range = document.createRange();
                    const textNode = p.firstChild;
                    if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                        range.setStart(textNode, start);
                        range.setEnd(textNode, end);
                        
                        try {
                            const span = document.createElement('span');
                            span.className = 'simple-highlight';
                            span.style.backgroundColor = '#fff3cd';
                            span.style.cursor = 'pointer';
                            
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                            
                            demoState.oldHighlights.push(span);
                            count++;
                        } catch (e) {
                            console.log('標註失敗:', e);
                        }
                    }
                }
            });
            
            updateTimeline([
                `✅ 創建了 ${count} 個舊版標註`,
                `📝 使用了 DOM 操作（<span> 元素）`
            ]);
            updateStats();
            showStatus('phase1', `成功創建 ${count} 個舊版標註`, 'success');
        }

        // 模擬階段1
        async function simulatePhase1() {
            showStatus('phase1', '⏳ 正在執行階段1遷移...', 'info');
            
            await sleep(500);
            
            const oldSpans = document.querySelectorAll('.simple-highlight');
            let created = 0;
            
            demoState.newHighlights = [];
            
            oldSpans.forEach(span => {
                // 模擬創建新Range（實際上只是標記）
                span.setAttribute('data-migrated', 'true');
                span.setAttribute('data-new-id', `highlight-${++created}`);
                span.style.opacity = '0';
                span.style.pointerEvents = 'none';
                
                demoState.hiddenSpans.push(span);
                demoState.newHighlights.push({
                    id: `highlight-${created}`,
                    text: span.textContent
                });
            });
            
            updateTimeline([
                `✅ 階段1完成`,
                `📦 創建了 ${created} 個新標註（CSS Highlight API）`,
                `👻 隱藏了 ${created} 個舊span（opacity:0）`,
                `💾 舊span保留在DOM中，以備回退`
            ]);
            
            demoState.phase = 1;
            updateStats();
            showStatus('phase1', `✅ 階段1完成！創建了 ${created} 個新標註，舊標註已隱藏`, 'success');
        }

        // 模擬階段2
        async function simulatePhase2() {
            if (demoState.phase < 1) {
                showStatus('phase2', '❌ 請先執行階段1', 'error');
                return;
            }
            
            showStatus('phase2', '⏳ 正在驗證新標註...', 'info');
            
            await sleep(500);
            
            // 模擬驗證
            const verified = demoState.newHighlights.length;
            
            updateTimeline([
                `✅ 階段2完成`,
                `🔍 驗證了 ${verified} 個新標註`,
                `✓ 所有新標註恢復正常`,
                `➡️ 可以安全進入階段3`
            ]);
            
            demoState.phase = 2;
            updateStats();
            showStatus('phase2', `✅ 階段2完成！驗證了 ${verified} 個新標註`, 'success');
        }

        // 模擬階段3
        async function simulatePhase3() {
            if (demoState.phase < 2) {
                showStatus('phase2', '❌ 請先完成階段2驗證', 'error');
                return;
            }
            
            showStatus('phase2', '⏳ 正在移除舊標註...', 'info');
            
            await sleep(500);
            
            // 移除舊span
            let removed = 0;
            demoState.hiddenSpans.forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
                parent.normalize();
                removed++;
            });
            
            demoState.hiddenSpans = [];
            demoState.oldHighlights = [];
            
            updateTimeline([
                `🎉 階段3完成`,
                `🗑️ 移除了 ${removed} 個舊span元素`,
                `✨ DOM結構已完全恢復乾淨`,
                `✅ 遷移全部完成！`
            ]);
            
            demoState.phase = 3;
            updateStats();
            showStatus('phase2', `🎉 遷移完成！DOM已清理，共移除 ${removed} 個舊標註`, 'success');
        }

        // 重置演示
        function resetDemo() {
            const content = document.getElementById('test-content');
            content.querySelectorAll('.simple-highlight').forEach(s => {
                const parent = s.parentNode;
                while (s.firstChild) parent.insertBefore(s.firstChild, s);
                parent.removeChild(s);
                parent.normalize();
            });
            
            demoState = {
                phase: 0,
                oldHighlights: [],
                newHighlights: [],
                hiddenSpans: []
            };
            
            updateTimeline(['⏳ 等待開始...']);
            updateStats();
            document.getElementById('phase1-status').style.display = 'none';
            document.getElementById('phase2-status').style.display = 'none';
        }

        // 顯示DOM
        function showDOM() {
            const content = document.getElementById('test-content');
            const html = content.innerHTML
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            document.getElementById('dom-content').innerHTML = html;
            document.getElementById('dom-viewer').style.display = 'block';
        }

        function closeDOMViewer() {
            document.getElementById('dom-viewer').style.display = 'none';
        }

        // 更新時間線
        function updateTimeline(items) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = items.map((item, index) => 
                `<div class="timeline-item completed">${item}</div>`
            ).join('');
        }

        // 更新統計
        function updateStats() {
            document.getElementById('stat-old').textContent = 
                document.querySelectorAll('.simple-highlight:not([data-migrated])').length;
            document.getElementById('stat-new').textContent = demoState.newHighlights.length;
            document.getElementById('stat-hidden').textContent = demoState.hiddenSpans.length;
            
            const phases = ['未開始', '階段1', '階段2', '已完成'];
            document.getElementById('stat-phase').textContent = phases[demoState.phase] || '未開始';
        }

        // 顯示狀態
        function showStatus(id, message, type) {
            const el = document.getElementById(`${id}-status`);
            el.textContent = message;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }

        // 延遲函數
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 初始化
        updateStats();
    </script>
</body>
</html>
