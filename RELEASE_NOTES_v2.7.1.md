# 🐛 Release Notes - v2.7.1

**發布日期：** 2025年10月3日  
**版本類型：** Bug Fix Release（錯誤修復版本）

---

## 📋 版本總結

v2.7.1 是一個重要的數據清理機制修復版本。修復了 Notion 頁面刪除後標註數據未被清理的問題，並在「數據優化」功能中新增了主動清理選項。

---

## 🐛 核心修復

### 完善已刪除頁面的數據清理機制

**問題背景：**
- 當 Notion 中的頁面被刪除後，擴展會清除保存狀態（`saved_${pageUrl}`）
- 但標註數據（`highlights_${pageUrl}`）未被清除，長期累積可能造成存儲壓力

**影響評估：**
- **輕度用戶**（50頁/月）：> 5年才有問題（低風險） ✅
- **重度用戶**（500頁/月）：6-12個月可能有問題 ⚠️
- **極端用戶**（2000頁/月）：< 6個月就會有問題 ❌

**解決方案：**

#### 1. 自動清理（核心修復）
- 修改 `clearPageState()` 函數
- 頁面刪除時同時清除：
  - ✅ 保存狀態（`saved_${pageUrl}`）
  - ✅ 標註數據（`highlights_${pageUrl}`）
- **性能影響**：極小（只多一個存儲刪除操作）

#### 2. 手動清理（用戶主動）
- 在「數據優化」功能中新增選項：**「清理已刪除頁面的標註數據」**
- **功能特點**：
  - 🔍 批量檢查所有已保存的頁面
  - ✅ 通過 Notion API 驗證頁面是否存在
  - 🗑️ 清理已刪除頁面的所有相關數據
  - 📊 提供詳細的清理預覽和統計
  - ⚡ 自動控制 API 請求速率（避免觸發限制）

**清理效果：**
- 減少 90%+ 的無效數據累積
- 輕度/中度用戶完全無壓力
- 重度用戶可定期手動清理

---

## 🎯 使用指南

### 自動清理
- **無需操作**：訪問已保存的頁面時自動觸發
- **清理條件**：檢測到 Notion 頁面已刪除
- **清理內容**：保存狀態 + 標註數據

### 手動清理
1. 打開擴展設置頁面（右鍵圖標 → 選項）
2. 找到「📊 數據優化」區域
3. 勾選「清理已刪除頁面的標註數據」
4. 點擊「👀 預覽清理效果」
5. 查看預覽後點擊「🗑️ 執行清理」

**注意事項：**
- ⏱️ 檢查過程可能需要幾分鐘（取決於頁面數量）
- 🔄 Notion API 速率限制：約 350ms/頁
- ✅ 清理過程安全可靠，只刪除已確認不存在的頁面數據
- 💾 建議重度用戶每 3-6 個月執行一次

---

## 📊 數據優化選項對比

| 選項 | 清理內容 | 檢查方式 | 適用場景 |
|------|----------|----------|----------|
| **清理空白頁面記錄** | 沒有任何標記的空白頁面 | 本地檢查 | 日常維護 ✅ |
| **清理已刪除頁面數據** | 已刪除頁面的保存狀態+標註 | API 檢查 | 重度用戶定期清理 ⚠️ |

---

## 🔧 技術實現

### 修改的文件

#### `scripts/background.js`
- **clearPageState()** 函數：
  ```javascript
  // v2.7.1: 同時刪除保存狀態和標註數據
  chrome.storage.local.remove([savedKey, highlightsKey]);
  ```
- **handleCheckNotionPageExistsMessage()**：新增消息處理器，支持批量檢查

#### `options/options.html`
- 新增「清理已刪除頁面的標註數據」複選框
- 更新說明文字，清楚解釋兩種清理功能的區別

#### `options/options.js`
- **previewSafeCleanup()**：支持兩種清理模式選擇
- **generateSafeCleanupPlan()**：
  - 支持清理空白頁面記錄
  - 支持清理已刪除頁面的標註數據
  - 批量 API 檢查並自動控制速率（350ms/次）
- **checkNotionPageExists()**：新增輔助函數
- **displayCleanupPreview()**：顯示兩種清理類型的統計

---

## 📖 相關文檔

- **完整分析報告**：`DATA_CLEANUP_ANALYSIS.md`
  - 詳細的數據壓力評估
  - 3個實施方案對比
  - 性能影響分析
  - 最佳實踐建議

- **用戶指南**：`USER_GUIDE_v2.7.0.md`
  - 圖標徽章使用指南
  - Open in Notion 按鈕使用說明
  - 已知延遲情況說明

---

## 🎯 建議

### 輕度用戶（< 100頁/月）
- ✅ 自動清理已足夠
- ❌ 無需手動清理

### 中度用戶（100-300頁/月）
- ✅ 自動清理為主
- 🔄 可選擇每年清理一次

### 重度用戶（> 300頁/月）
- ✅ 自動清理 + 定期手動清理
- 🔄 **建議每 3-6 個月執行一次手動清理**

### 極端用戶（> 1000頁/月）
- ✅ 自動清理 + 頻繁手動清理
- 🔄 **建議每 1-2 個月執行一次手動清理**

---

## 🔄 升級指南

### 從 v2.7.0 升級
1. 直接安裝 v2.7.1
2. 無需額外配置
3. 如果是重度用戶，建議首次執行一次「清理已刪除頁面數據」

### 數據兼容性
- ✅ 完全向後兼容
- ✅ 不影響現有功能
- ✅ 已保存的頁面和標註數據完全保留

---

## 🐛 已知問題

無

---

## 📞 問題反饋

如有任何問題或建議，請通過以下方式反饋：
- GitHub Issues（推薦）
- Chrome Web Store 評論

---

**感謝您的使用和支持！** 🙏

---

**上一版本：** [v2.7.0 Release Notes](RELEASE_NOTES_v2.7.0.md)  
**變更日誌：** [CHANGELOG.md](CHANGELOG.md)
