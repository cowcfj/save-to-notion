# 🧪 v2.7.1 測試指南

**版本：** v2.7.1  
**測試類型：** 數據清理機制修復  
**預計測試時間：** 15-20 分鐘

---

## 📋 測試前準備

### 1. 更新擴展
1. 在 Chrome 中打開 `chrome://extensions/`
2. 啟用「開發者模式」
3. 點擊「載入未封裝項目」
4. 選擇項目根目錄
5. 確認版本號顯示為 **2.7.1**

### 2. 準備測試環境
- ✅ 確保 Notion API Key 已配置
- ✅ 至少有 2-3 個已保存的測試頁面
- ✅ 打開瀏覽器控制台（F12）查看日誌

---

## 🧪 測試項目

### ✅ 測試 1：自動清理機制（核心修復）

**目標：** 驗證頁面刪除後，保存狀態和標註數據都被清除

#### 步驟：
1. **保存一個測試頁面**
   - 打開任意網頁
   - 使用擴展保存到 Notion
   - 添加一些文本標註（選擇文本按 `Alt+H`）
   - 確認圖標顯示綠色徽章 "✓"

2. **在 Notion 中刪除該頁面**
   - 打開 Notion
   - 找到剛保存的頁面
   - 刪除該頁面（移到回收站）

3. **重新訪問原網頁**
   - 刷新或重新打開該網頁
   - 等待 1-2 秒（自動檢查）

4. **檢查結果**
   - ✅ 綠色徽章 "✓" 應該消失
   - ✅ 頁面上的標註高亮應該消失
   - ✅ 打開控制台，查看日誌：
     ```
     ✅ Cleared all data for: [頁面URL]
       - Saved state: saved_[URL]
       - Highlights: highlights_[URL]
     ```

5. **驗證存儲數據**
   - 打開控制台，執行：
     ```javascript
     chrome.storage.local.get(null, (data) => {
         const url = '[頁面URL]';
         console.log('saved_:', data[`saved_${url}`]);  // 應該是 undefined
         console.log('highlights_:', data[`highlights_${url}`]);  // 應該是 undefined
     });
     ```

**預期結果：**
- ✅ `saved_${url}` = undefined
- ✅ `highlights_${url}` = undefined
- ✅ 兩個鍵都被清除

---

### ✅ 測試 2：數據優化界面（新功能）

**目標：** 驗證「清理已刪除頁面數據」功能正常工作

#### 步驟：
1. **準備測試數據**
   - 保存 3-5 個測試頁面到 Notion
   - 在 Notion 中刪除其中 2-3 個頁面
   - 保留 1-2 個頁面不刪除（用於對比）

2. **打開設置頁面**
   - 右鍵點擊擴展圖標
   - 選擇「選項」
   - 滾動到「📊 數據優化」區域

3. **檢查界面**
   - ✅ 應該看到兩個複選框：
     * ☑️ 清理空白頁面記錄
     * ☑️ **清理已刪除頁面的標註數據** ← 新增
   - ✅ 新選項有說明文字：
     > "🔍 檢查所有已保存的頁面，清理在 Notion 中已刪除的頁面的標註數據..."

4. **預覽清理效果**
   - 勾選「清理已刪除頁面的標註數據」
   - 點擊「👀 預覽清理效果」
   - 等待檢查完成（可能需要 1-2 分鐘）

5. **檢查預覽結果**
   - ✅ 應該顯示預覽面板
   - ✅ 統計信息應該顯示：
     * "X 個已刪除頁面的數據"
     * 釋放空間大小
   - ✅ 列出的頁面應該是你刪除的那些
   - ✅ 保留的頁面不應該在列表中

6. **執行清理**
   - 點擊「🗑️ 執行清理」
   - 等待清理完成
   - ✅ 應該顯示成功消息

7. **驗證清理結果**
   - 打開控制台，檢查存儲：
     ```javascript
     chrome.storage.local.get(null, (data) => {
         const deletedUrl = '[已刪除頁面的URL]';
         const keptUrl = '[保留頁面的URL]';
         
         console.log('Deleted page - saved:', data[`saved_${deletedUrl}`]);  // undefined
         console.log('Deleted page - highlights:', data[`highlights_${deletedUrl}`]);  // undefined
         console.log('Kept page - saved:', data[`saved_${keptUrl}`]);  // 應該有數據
         console.log('Kept page - highlights:', data[`highlights_${keptUrl}`]);  // 應該有數據
     });
     ```

**預期結果：**
- ✅ 已刪除頁面的數據被清除
- ✅ 保留頁面的數據完整無損
- ✅ 存儲使用量減少

---

### ✅ 測試 3：API 速率限制控制

**目標：** 驗證批量檢查不會觸發 Notion API 速率限制

#### 步驟：
1. **準備大量測試頁面**（可選，如果時間充足）
   - 保存 10+ 個頁面
   - 刪除其中 5+ 個

2. **執行批量清理**
   - 打開設置頁面
   - 勾選「清理已刪除頁面的標註數據」
   - 點擊「預覽清理效果」
   - 打開控制台查看日誌

3. **檢查日誌**
   - ✅ 應該看到：
     ```
     🔍 檢查 X 個已保存的頁面...
     ❌ 頁面已刪除: [URL] (X KB)
     ...
     ```
   - ✅ 不應該看到 API 錯誤（如 429 Too Many Requests）
   - ✅ 請求間隔應該約 350ms（通過時間戳觀察）

**預期結果：**
- ✅ 所有頁面都被正確檢查
- ✅ 無 API 速率限制錯誤
- ✅ 處理速度穩定

---

### ✅ 測試 4：兼容性測試

**目標：** 確保新功能不影響現有功能

#### 步驟：
1. **測試保存功能**
   - 保存一個新頁面
   - ✅ 應該正常工作
   - ✅ 圖標徽章正常顯示

2. **測試標註功能**
   - 選擇文本並標註
   - ✅ 標註正常工作
   - ✅ 標註數據正常保存

3. **測試「清理空白頁面」功能**
   - 只勾選「清理空白頁面記錄」
   - 點擊預覽和執行
   - ✅ 功能正常工作
   - ✅ 不影響其他數據

4. **測試 Open in Notion 按鈕**
   - 打開已保存的頁面
   - 點擊擴展圖標
   - ✅ 應該看到「🔗 Open in Notion」按鈕
   - ✅ 點擊後正確打開 Notion 頁面

**預期結果：**
- ✅ 所有現有功能正常工作
- ✅ 無回歸錯誤

---

## 🐛 已知行為

### 延遲行為（正常）
- Open in Notion 按鈕可能有 1-2 秒延遲才顯示（正常現象）
- 批量清理可能需要幾分鐘（取決於頁面數量）

### 安全策略
- API 檢查失敗時，假設頁面存在（不清理）
- 避免誤刪有效數據

---

## 📊 測試結果記錄

### 測試 1：自動清理機制
- [ ] ✅ 通過
- [ ] ⚠️ 部分通過（說明）
- [ ] ❌ 失敗（說明）

### 測試 2：數據優化界面
- [ ] ✅ 通過
- [ ] ⚠️ 部分通過（說明）
- [ ] ❌ 失敗（說明）

### 測試 3：API 速率限制控制
- [ ] ✅ 通過
- [ ] ⚠️ 部分通過（說明）
- [ ] ❌ 失敗（說明）

### 測試 4：兼容性測試
- [ ] ✅ 通過
- [ ] ⚠️ 部分通過（說明）
- [ ] ❌ 失敗（說明）

---

## 🔧 問題排查

### 如果自動清理不工作
1. 檢查控制台是否有錯誤
2. 確認 API Key 正確配置
3. 確認頁面確實在 Notion 中被刪除

### 如果手動清理不工作
1. 檢查 API Key 是否有效
2. 檢查網絡連接
3. 查看控制台日誌

### 如果 API 速率限制錯誤
- 等待幾分鐘後重試
- 分批清理（減少每次清理的頁面數量）

---

## ✅ 測試完成檢查清單

- [ ] 所有測試項目都已完成
- [ ] 核心功能正常工作
- [ ] 無回歸錯誤
- [ ] 性能表現符合預期
- [ ] 文檔準確反映功能

---

**測試完成後請將結果反饋給開發團隊！** 🙏
