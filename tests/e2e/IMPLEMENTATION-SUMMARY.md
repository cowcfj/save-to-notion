# E2E æ¸¬è©¦è¦†è“‹ç‡æ•´åˆ - å¯¦æ–½ç¸½çµ

## ğŸ“‹ å®Œæˆç‹€æ…‹

âœ… **å·²å®Œæˆ** - E2E æ¸¬è©¦è¦†è“‹ç‡æ•´åˆæ–¹æ¡ˆå·²å®Œå…¨å¯¦æ–½

## ğŸ¯ å¯¦æ–½å…§å®¹

### 1. æ ¸å¿ƒçµ„ä»¶ï¼ˆå·²å‰µå»ºï¼‰

| æ–‡ä»¶ | èªªæ˜ | ç‹€æ…‹ |
|------|------|------|
| `coverage-config.js` | è¦†è“‹ç‡æ”¶é›†é…ç½® | âœ… |
| `coverage-collector.js` | E2E è¦†è“‹ç‡æ”¶é›†å™¨ï¼ˆPuppeteerï¼‰ | âœ… |
| `coverage-merger.js` | è¦†è“‹ç‡åˆä½µå·¥å…· | âœ… |
| `run-with-coverage.js` | ä¸»åŸ·è¡Œè…³æœ¬ | âœ… |
| `scenarios/highlighter.e2e.js` | é«˜äº®åŠŸèƒ½æ¸¬è©¦å ´æ™¯ | âœ… |
| `scenarios/content-extraction.e2e.js` | å…§å®¹æå–æ¸¬è©¦å ´æ™¯ | âœ… |

### 2. æ–‡æª”ï¼ˆå·²å‰µå»ºï¼‰

| æ–‡ä»¶ | èªªæ˜ | ç‹€æ…‹ |
|------|------|------|
| `E2E-COVERAGE-GUIDE.md` | å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ˆ7000+ å­—ï¼‰ | âœ… |
| `QUICK-START.md` | å¿«é€Ÿé–‹å§‹æŒ‡å— | âœ… |

### 3. é…ç½®æ›´æ–°ï¼ˆå·²å®Œæˆï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å…§å®¹ | ç‹€æ…‹ |
|------|---------|------|
| `package.json` | æ·»åŠ ä¾è³´ + æ¸¬è©¦è…³æœ¬ | âœ… |

**æ–°å¢ä¾è³´**ï¼š
```json
{
  "puppeteer": "^21.0.0",
  "istanbul-lib-coverage": "^3.2.2",
  "istanbul-lib-report": "^3.0.1",
  "istanbul-reports": "^3.1.7"
}
```

**æ–°å¢è…³æœ¬**ï¼š
```json
{
  "test:e2e": "node tests/e2e/run-with-coverage.js",
  "test:e2e:only": "node tests/e2e/coverage-collector.js",
  "test:merge-coverage": "node tests/e2e/coverage-merger.js",
  "test:all": "npm run test:coverage && npm run test:e2e"
}
```

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### å®‰è£ä¾è³´ï¼ˆå¿…éœ€ï¼‰

```bash
npm install
```

é€™æœƒè‡ªå‹•å®‰è£æ–°å¢çš„ä¾è³´ï¼š
- `puppeteer` - ç€è¦½å™¨è‡ªå‹•åŒ–
- `istanbul-lib-*` - è¦†è“‹ç‡è™•ç†å·¥å…·

### é‹è¡Œæ¸¬è©¦

```bash
# å®Œæ•´æ¸¬è©¦æµç¨‹ï¼ˆæ¨è–¦ï¼‰
npm run test:all

# åªé‹è¡Œ E2E æ¸¬è©¦
npm run test:e2e

# åˆ†æ­¥åŸ·è¡Œ
npm run test:coverage          # 1. Jest å–®å…ƒæ¸¬è©¦
npm run test:e2e:only          # 2. E2E æ¸¬è©¦
npm run test:merge-coverage    # 3. åˆä½µè¦†è“‹ç‡
```

### æŸ¥çœ‹å ±å‘Š

```bash
# æ‰“é–‹ HTML å ±å‘Š
open coverage/merged/index.html

# çµ‚ç«¯æŸ¥çœ‹æ‘˜è¦
cat coverage/merged/coverage-summary.json
```

## ğŸ“Š é æœŸæ•ˆæœ

### è¦†è“‹ç‡æå‡é æ¸¬

åŸºæ–¼ E2E æ¸¬è©¦è¦†è“‹çš„å¯¦éš›ä»£ç¢¼è·¯å¾‘ï¼š

| æ¨¡å¡Š | ç•¶å‰è¦†è“‹ç‡ | E2E å¾Œé æœŸ | æå‡å¹…åº¦ |
|------|-----------|-----------|---------|
| **background.js** | 6.92% | 40-50% | +33-43% |
| **content.js** | 31.53% | 60-70% | +28-38% |
| **highlighter-v2.js** | 18.78% | 55-65% | +36-46% |
| **æ•´é«”** | **46.56%** | **65-75%** | **+18-28%** |

### æ¸¬è©¦å ´æ™¯è¦†è“‹

å·²å¯¦æ–½çš„æ¸¬è©¦å ´æ™¯ï¼š

1. âœ… **Highlighter Workflow**
   - é é¢å°èˆªå’ŒåŠ è¼‰
   - æ–‡æœ¬é¸æ“‡æ¸¬è©¦
   - CSS Highlight API æª¢æ¸¬
   - é«˜äº®å‰µå»ºå’Œåˆªé™¤
   - æŒä¹…åŒ–å’Œæ¢å¾©

2. âœ… **Content Extraction**
   - åŸºç¤å…§å®¹æå–ï¼ˆæ¨™é¡Œã€æ®µè½ï¼‰
   - åœ–ç‰‡æå–å’Œéæ¿¾
   - åˆ—è¡¨å’Œä»£ç¢¼å€å¡Šæå–
   - Meta æ•¸æ“šæå–
   - çµæ§‹åŒ–å…§å®¹ç”Ÿæˆ

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Jest å–®å…ƒæ¸¬è©¦   â”‚     â”‚  E2E æ¸¬è©¦       â”‚
â”‚  (JSDOM)        â”‚     â”‚  (Puppeteer)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ Istanbul              â”‚ Coverage API
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ coverage/       â”‚     â”‚ coverage/e2e/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ è¦†è“‹ç‡åˆä½µ   â”‚
              â”‚ (Istanbul)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
              â”‚ coverage/   â”‚
              â”‚ merged/     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµæŠ€è¡“

1. **Puppeteer Coverage API** - æ”¶é›†ç€è¦½å™¨åŸ·è¡Œçš„ JS è¦†è“‹ç‡
2. **Istanbul è½‰æ›** - å°‡ Puppeteer æ ¼å¼è½‰ç‚º Istanbul æ ¼å¼
3. **Coverage Map åˆä½µ** - ä½¿ç”¨ `istanbul-lib-coverage` åˆä½µæ•¸æ“š
4. **å¤šæ ¼å¼å ±å‘Š** - ç”Ÿæˆ text/json/lcov/html å ±å‘Š

## ğŸ“– è©³ç´°æ–‡æª”

1. **å¿«é€Ÿé–‹å§‹**: æŸ¥çœ‹ `QUICK-START.md`
2. **å®Œæ•´æŒ‡å—**: æŸ¥çœ‹ `E2E-COVERAGE-GUIDE.md`
3. **æ¸¬è©¦å ´æ™¯**: æŸ¥çœ‹ `scenarios/*.e2e.js`
4. **é…ç½®èªªæ˜**: æŸ¥çœ‹ `coverage-config.js`

## ğŸ“ å‰µå»ºè‡ªå®šç¾©æ¸¬è©¦

### æ­¥é©Ÿ 1: å‰µå»ºæ¸¬è©¦å ´æ™¯

```javascript
// tests/e2e/scenarios/my-feature.e2e.js
module.exports = {
  name: 'My Feature Test',

  async run(page, config) {
    // 1. å°èˆª
    await page.goto('https://example.com');

    // 2. æ¸¬è©¦é‚è¼¯
    const result = await page.evaluate(() => {
      // åŸ·è¡Œæ¸¬è©¦ä»£ç¢¼
      return { success: true };
    });

    // 3. é©—è­‰
    if (!result.success) {
      throw new Error('Test failed');
    }

    return result;
  }
};
```

### æ­¥é©Ÿ 2: æ·»åŠ åˆ°é…ç½®

```javascript
// coverage-config.js
testScenarios: [
  // ... ç¾æœ‰å ´æ™¯
  {
    name: 'My Feature Test',
    file: 'tests/e2e/scenarios/my-feature.e2e.js',
    timeout: 30000,
    enabled: true
  }
]
```

### æ­¥é©Ÿ 3: é‹è¡Œæ¸¬è©¦

```bash
npm run test:e2e
```

## ğŸ” æ•…éšœæ’é™¤

### å•é¡Œ 1: ä¾è³´å®‰è£å¤±æ•—

```bash
# æ¸…ç†ä¸¦é‡æ–°å®‰è£
rm -rf node_modules package-lock.json
npm install
```

### å•é¡Œ 2: Puppeteer ä¸‹è¼‰æ…¢

```bash
# ä½¿ç”¨æ·˜å¯¶é¡åƒ
PUPPETEER_DOWNLOAD_HOST=https://npm.taobao.org/mirrors npm install puppeteer
```

### å•é¡Œ 3: è¦†è“‹ç‡ç‚º 0

æª¢æŸ¥ï¼š
1. æ˜¯å¦é‹è¡Œäº† `npm run build`ï¼Ÿ
2. `dist/` ç›®éŒ„æ˜¯å¦å­˜åœ¨ï¼Ÿ
3. E2E æ¸¬è©¦æ˜¯å¦å¯¦éš›åŸ·è¡Œäº†ä»£ç¢¼ï¼Ÿ

### å•é¡Œ 4: åˆä½µå¤±æ•—

ç¢ºä¿å…©å€‹è¦†è“‹ç‡æ–‡ä»¶éƒ½å­˜åœ¨ï¼š
```bash
ls -la coverage/coverage-final.json
ls -la coverage/e2e/coverage-final.json
```

## ğŸŒŸ å„ªå‹¢

### vs. ç´” Jest æ¸¬è©¦

| ç‰¹æ€§ | Jest | E2E + Jest |
|------|------|-----------|
| æ¸¬è©¦ç’°å¢ƒ | JSDOM | çœŸå¯¦ç€è¦½å™¨ âœ¨ |
| Chrome APIs | éœ€è¦ mock | çœŸå¯¦ API âœ¨ |
| CSS Highlight API | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ âœ¨ |
| è¦–è¦ºé©—è­‰ | ä¸å¯èƒ½ | å¯æˆªåœ– âœ¨ |
| è¦†è“‹ç‡ | 46% | 65-75% âœ¨ |

### vs. ç´”æ‰‹å‹•æ¸¬è©¦

| ç‰¹æ€§ | æ‰‹å‹•æ¸¬è©¦ | E2E è‡ªå‹•åŒ– |
|------|---------|-----------|
| å¯é‡è¤‡æ€§ | âŒ | âœ… |
| è¦†è“‹ç‡æ”¶é›† | âŒ | âœ… |
| CI/CD æ•´åˆ | âŒ | âœ… |
| åŸ·è¡Œé€Ÿåº¦ | æ…¢ | å¿« âœ¨ |
| ä¸€è‡´æ€§ | ä½ | é«˜ âœ¨ |

## ğŸ“ˆ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### çŸ­æœŸï¼ˆå·²å°±ç·’ï¼Œç­‰å¾…åŸ·è¡Œï¼‰

- [ ] é‹è¡Œ `npm install` å®‰è£ä¾è³´
- [ ] é‹è¡Œ `npm run test:all` é©—è­‰æ•´åˆ
- [ ] æŸ¥çœ‹åˆä½µå¾Œçš„è¦†è“‹ç‡å ±å‘Š
- [ ] æ ¹æ“šå ±å‘Šèª¿æ•´æ¸¬è©¦ç­–ç•¥

### ä¸­æœŸï¼ˆå¯é¸æ“´å±•ï¼‰

- [ ] æ·»åŠ æ›´å¤šæ¸¬è©¦å ´æ™¯
- [ ] æ•´åˆåˆ° CI/CD æµç¨‹
- [ ] è¨­ç½®è¦†è“‹ç‡é–¾å€¼
- [ ] æ·»åŠ è¦–è¦ºå›æ­¸æ¸¬è©¦

### é•·æœŸï¼ˆæŒçºŒå„ªåŒ–ï¼‰

- [ ] æ€§èƒ½åŸºæº–æ¸¬è©¦
- [ ] è¦†è“‹ç‡è¶¨å‹¢åˆ†æ
- [ ] è‡ªå‹•åŒ–å ±å‘Šæ¨é€
- [ ] æ¸¬è©¦è³ªé‡ç›£æ§

## ğŸ‰ ç¸½çµ

æˆ‘å€‘å·²ç¶“æˆåŠŸå¯¦æ–½äº†ä¸€å€‹**å®Œæ•´çš„ E2E æ¸¬è©¦è¦†è“‹ç‡æ•´åˆæ–¹æ¡ˆ**ï¼š

âœ… **å®Œæ•´çš„æŠ€è¡“æ£§** - Puppeteer + Istanbul + Jest
âœ… **è‡ªå‹•åŒ–æµç¨‹** - ä¸€éµæ”¶é›†å’Œåˆä½µè¦†è“‹ç‡
âœ… **è©³ç´°æ–‡æª”** - å¿«é€Ÿé–‹å§‹ + å®Œæ•´æŒ‡å—
âœ… **å¯¦éš›æ¸¬è©¦å ´æ™¯** - é«˜äº®å™¨ + å…§å®¹æå–
âœ… **å¯æ“´å±•æ¶æ§‹** - æ˜“æ–¼æ·»åŠ æ–°æ¸¬è©¦

**ç¾åœ¨åªéœ€è¦**ï¼š
1. é‹è¡Œ `npm install` å®‰è£ä¾è³´
2. é‹è¡Œ `npm run test:all` é–‹å§‹æ¸¬è©¦
3. æŸ¥çœ‹ `coverage/merged/index.html` æŸ¥çœ‹çµæœ

**é æœŸè¦†è“‹ç‡æå‡**: 46.56% â†’ **65-75%** ğŸš€

---

**å‰µå»ºæ—¥æœŸ**: 2025-01-20
**ç‹€æ…‹**: âœ… å·²å®Œæˆï¼Œç­‰å¾…é©—è­‰
**ä¸‹ä¸€æ­¥**: å®‰è£ä¾è³´ä¸¦é‹è¡Œæ¸¬è©¦
