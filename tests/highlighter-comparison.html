<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨™è¨»åŠŸèƒ½å°æ¯”æ¸¬è©¦ - Notion Smart Clipper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        
        .panel h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .test-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            min-height: 200px;
        }
        
        .test-content p {
            margin: 10px 0;
        }
        
        .test-content ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .test-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }
        
        .controls {
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }
        
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .controls button.danger {
            background: #dc3545;
        }
        
        .controls button.danger:hover {
            background: #c82333;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 12px;
            margin: 15px 0;
            color: #0c5460;
        }
        
        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* èˆŠç‰ˆæ¨™è¨»æ¨£å¼ */
        .simple-highlight {
            cursor: pointer;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #007bff;
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .feature-yes {
            color: #28a745;
            font-weight: bold;
        }
        
        .feature-no {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ Notion Smart Clipper - æ¨™è¨»åŠŸèƒ½å°æ¯”æ¸¬è©¦</h1>
    
    <div class="info-box">
        <strong>æ¸¬è©¦èªªæ˜ï¼š</strong>
        æœ¬é é¢å°æ¯”å…©ç¨®æ¨™è¨»å¯¦ç¾æ–¹æ¡ˆï¼š
        <ul>
            <li><strong>èˆŠç‰ˆ (DOMæ“ä½œ)</strong>: ä¿®æ”¹é é¢DOMçµæ§‹å¯¦ç¾æ¨™è¨»</li>
            <li><strong>æ–°ç‰ˆ (CSS Highlight API)</strong>: ä½¿ç”¨ç€è¦½å™¨åŸç”ŸAPIï¼Œä¸ä¿®æ”¹DOM</li>
        </ul>
    </div>

    <table class="comparison-table">
        <thead>
            <tr>
                <th>ç‰¹æ€§</th>
                <th>èˆŠç‰ˆ (DOMæ“ä½œ)</th>
                <th>æ–°ç‰ˆ (CSS Highlight API)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>è·¨å…ƒç´ æ¨™è¨»</td>
                <td class="feature-no">âŒ éœ€è¦è¤‡é›œå›é€€æ©Ÿåˆ¶</td>
                <td class="feature-yes">âœ… åŸç”Ÿæ”¯æŒ</td>
            </tr>
            <tr>
                <td>DOMçµæ§‹</td>
                <td class="feature-no">âŒ æœƒä¿®æ”¹é é¢çµæ§‹</td>
                <td class="feature-yes">âœ… å®Œå…¨ä¸ä¿®æ”¹</td>
            </tr>
            <tr>
                <td>è¦–è¦ºåé¥‹</td>
                <td class="feature-no">âŒ å¯èƒ½å¤±æ•—</td>
                <td class="feature-yes">âœ… å¯é é¡¯ç¤º</td>
            </tr>
            <tr>
                <td>æ€§èƒ½</td>
                <td class="feature-no">âŒ è¼ƒæ…¢ï¼ˆDOMæ“ä½œï¼‰</td>
                <td class="feature-yes">âœ… æ›´å¿«ï¼ˆç€è¦½å™¨åŸç”Ÿï¼‰</td>
            </tr>
            <tr>
                <td>æŒä¹…åŒ–</td>
                <td class="feature-no">âŒ è¤‡é›œï¼ˆéœ€ä¿å­˜HTMLï¼‰</td>
                <td class="feature-yes">âœ… ç°¡å–®ï¼ˆä¿å­˜Rangeï¼‰</td>
            </tr>
            <tr>
                <td>é‡è¤‡æ¨™è¨»å•é¡Œ</td>
                <td class="feature-no">âŒ å­˜åœ¨</td>
                <td class="feature-yes">âœ… ä¸å­˜åœ¨</td>
            </tr>
            <tr>
                <td>ç€è¦½å™¨æ”¯æŒ</td>
                <td class="feature-yes">âœ… æ‰€æœ‰ç€è¦½å™¨</td>
                <td class="feature-no">âš ï¸ Chrome 105+, Safari 17.2+</td>
            </tr>
        </tbody>
    </table>

    <div class="container">
        <!-- èˆŠç‰ˆæ¸¬è©¦ -->
        <div class="panel">
            <h2>ğŸ”´ èˆŠç‰ˆ (DOMæ“ä½œ)</h2>
            
            <div class="controls">
                <button onclick="initOldHighlighter()">å•Ÿå‹•æ¨™è¨»å·¥å…·</button>
                <button class="danger" onclick="clearOldHighlights()">æ¸…é™¤æ‰€æœ‰æ¨™è¨»</button>
            </div>
            
            <div id="old-status" class="status" style="display:none;"></div>
            
            <div class="test-content" id="old-content">
                <h3>æ¸¬è©¦å…§å®¹</h3>
                <p>é€™æ˜¯ä¸€æ®µ<strong>æ™®é€šæ–‡æœ¬</strong>ï¼Œå¯ä»¥æ¸¬è©¦<em>ç°¡å–®æ¨™è¨»</em>ã€‚</p>
                
                <p>é€™æ˜¯ç¬¬äºŒæ®µï¼Œ<span style="color: blue;">åŒ…å«ä¸åŒçš„</span>æ ¼å¼å’Œ<code>ä»£ç¢¼</code>å…ƒç´ ã€‚</p>
                
                <blockquote>
                    é€™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡å­—ï¼Œæ¸¬è©¦åœ¨å¼•ç”¨å¡Šä¸­çš„æ¨™è¨»æ•ˆæœã€‚
                </blockquote>
                
                <ul>
                    <li>åˆ—è¡¨é …ç›®ä¸€ï¼šæ¸¬è©¦åˆ—è¡¨å…§æ¨™è¨»</li>
                    <li>åˆ—è¡¨é …ç›®äºŒï¼š<strong>è·¨å…ƒç´ æ–‡æœ¬</strong>æ¨™è¨»æ¸¬è©¦</li>
                    <li>åˆ—è¡¨é …ç›®ä¸‰ï¼šå¤šå±¤åµŒå¥—æ¸¬è©¦</li>
                </ul>
                
                <p>è·¨æ®µè½æ¨™è¨»æ¸¬è©¦ï¼šé€™æ˜¯ç¬¬ä¸€æ®µçš„çµå°¾éƒ¨åˆ†...</p>
                <p>...é€™æ˜¯ç¬¬äºŒæ®µçš„é–‹å§‹éƒ¨åˆ†ã€‚é¸æ“‡è·¨è¶Šå…©æ®µçš„æ–‡æœ¬æ¸¬è©¦ã€‚</p>
            </div>
        </div>

        <!-- æ–°ç‰ˆæ¸¬è©¦ -->
        <div class="panel">
            <h2>ğŸŸ¢ æ–°ç‰ˆ (CSS Highlight API)</h2>
            
            <div class="controls">
                <button onclick="initNewHighlighter()">å•Ÿå‹•æ¨™è¨»å·¥å…·</button>
                <button class="danger" onclick="clearNewHighlights()">æ¸…é™¤æ‰€æœ‰æ¨™è¨»</button>
                <button onclick="testHighlightAPI()">æª¢æ¸¬APIæ”¯æŒ</button>
            </div>
            
            <div id="new-status" class="status" style="display:none;"></div>
            
            <div class="test-content" id="new-content">
                <h3>æ¸¬è©¦å…§å®¹</h3>
                <p>é€™æ˜¯ä¸€æ®µ<strong>æ™®é€šæ–‡æœ¬</strong>ï¼Œå¯ä»¥æ¸¬è©¦<em>ç°¡å–®æ¨™è¨»</em>ã€‚</p>
                
                <p>é€™æ˜¯ç¬¬äºŒæ®µï¼Œ<span style="color: blue;">åŒ…å«ä¸åŒçš„</span>æ ¼å¼å’Œ<code>ä»£ç¢¼</code>å…ƒç´ ã€‚</p>
                
                <blockquote>
                    é€™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡å­—ï¼Œæ¸¬è©¦åœ¨å¼•ç”¨å¡Šä¸­çš„æ¨™è¨»æ•ˆæœã€‚
                </blockquote>
                
                <ul>
                    <li>åˆ—è¡¨é …ç›®ä¸€ï¼šæ¸¬è©¦åˆ—è¡¨å…§æ¨™è¨»</li>
                    <li>åˆ—è¡¨é …ç›®äºŒï¼š<strong>è·¨å…ƒç´ æ–‡æœ¬</strong>æ¨™è¨»æ¸¬è©¦</li>
                    <li>åˆ—è¡¨é …ç›®ä¸‰ï¼šå¤šå±¤åµŒå¥—æ¸¬è©¦</li>
                </ul>
                
                <p>è·¨æ®µè½æ¨™è¨»æ¸¬è©¦ï¼šé€™æ˜¯ç¬¬ä¸€æ®µçš„çµå°¾éƒ¨åˆ†...</p>
                <p>...é€™æ˜¯ç¬¬äºŒæ®µçš„é–‹å§‹éƒ¨åˆ†ã€‚é¸æ“‡è·¨è¶Šå…©æ®µçš„æ–‡æœ¬æ¸¬è©¦ã€‚</p>
            </div>
        </div>
    </div>

    <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border-radius: 8px;">
        <h3>ğŸ“ æ¸¬è©¦æ­¥é©Ÿ</h3>
        <ol>
            <li>é»æ“Š"å•Ÿå‹•æ¨™è¨»å·¥å…·"æŒ‰éˆ•</li>
            <li>åœ¨æ¸¬è©¦å…§å®¹ä¸­é¸æ“‡æ–‡æœ¬</li>
            <li>è§€å¯Ÿæ¨™è¨»æ•ˆæœå’ŒConsoleæ—¥èªŒ</li>
            <li>å˜—è©¦ä»¥ä¸‹æ¸¬è©¦å ´æ™¯ï¼š
                <ul>
                    <li>å–®æ®µè½å…§æ–‡æœ¬æ¨™è¨»</li>
                    <li>è·¨æ ¼å¼æ¨™è¨»ï¼ˆç²—é«”ã€æ–œé«”ç­‰ï¼‰</li>
                    <li>è·¨æ®µè½æ¨™è¨»</li>
                    <li>åˆ—è¡¨é …å…§æ¨™è¨»</li>
                    <li>å¼•ç”¨å¡Šå…§æ¨™è¨»</li>
                    <li>é‡è¤‡æ¨™è¨»åŒä¸€æ–‡æœ¬</li>
                </ul>
            </li>
            <li>å°æ¯”å…©å´çš„æ•ˆæœå·®ç•°</li>
        </ol>
    </div>

    <!-- Mock Storage Utility -->
    <script>
        // Mock StorageUtil for testing
        window.StorageUtil = {
            saveHighlights: async function(url, data) {
                console.log('ğŸ’¾ ä¿å­˜æ¨™è¨»:', data);
                localStorage.setItem(`highlights_${url}`, JSON.stringify(data));
            },
            loadHighlights: async function(url) {
                const data = localStorage.getItem(`highlights_${url}`);
                return data ? JSON.parse(data) : null;
            },
            clearHighlights: function(url) {
                localStorage.removeItem(`highlights_${url}`);
            }
        };
    </script>

    <!-- èˆŠç‰ˆæ¨™è¨»è…³æœ¬ (ç°¡åŒ–ç‰ˆï¼Œåªä¿ç•™æ ¸å¿ƒé‚è¼¯) -->
    <script>
        let oldHighlighter = null;
        
        function initOldHighlighter() {
            showStatus('old', 'èˆŠç‰ˆæ¨™è¨»å·¥å…·å·²å•Ÿå‹•', 'success');
            
            if (oldHighlighter) {
                return;
            }
            
            oldHighlighter = {
                currentColor: 'yellow',
                colors: {
                    yellow: '#fff3cd',
                    green: '#d4edda',
                    blue: '#cce7ff',
                    red: '#f8d7da'
                }
            };
            
            // ç›£è½é¸æ“‡äº‹ä»¶
            document.getElementById('old-content').addEventListener('mouseup', function(e) {
                const selection = window.getSelection();
                if (!selection.isCollapsed && selection.toString().trim()) {
                    const range = selection.getRangeAt(0);
                    
                    // åªæ¨™è¨»åœ¨old-contentå…§çš„é¸æ“‡
                    if (this.contains(range.commonAncestorContainer)) {
                        try {
                            applyOldHighlight(range);
                            showStatus('old', `âœ… æ¨™è¨»æˆåŠŸ: "${selection.toString().substring(0, 30)}..."`, 'success');
                        } catch (error) {
                            showStatus('old', `âŒ æ¨™è¨»å¤±æ•—: ${error.message}`, 'error');
                        }
                        selection.removeAllRanges();
                    }
                }
            });
        }
        
        function applyOldHighlight(range) {
            console.log('èˆŠç‰ˆæ¨™è¨» - é–‹å§‹', {
                text: range.toString(),
                startContainer: range.startContainer,
                endContainer: range.endContainer
            });
            
            const span = document.createElement('span');
            span.className = 'simple-highlight';
            span.style.backgroundColor = oldHighlighter.colors[oldHighlighter.currentColor];
            span.style.cursor = 'pointer';
            span.title = 'é›™æ“Šåˆªé™¤';
            
            // å˜—è©¦å¤šç¨®æ–¹æ³•
            try {
                // æ–¹æ³•1: æ¨™æº–æ–¹æ³•
                console.log('å˜—è©¦ surroundContents...');
                range.surroundContents(span);
                console.log('âœ… surroundContents æˆåŠŸ');
            } catch (e1) {
                console.log('âŒ surroundContents å¤±æ•—:', e1.message);
                try {
                    // æ–¹æ³•2: æå–å…§å®¹
                    console.log('å˜—è©¦ extractContents...');
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                    console.log('âœ… extractContents æˆåŠŸ');
                } catch (e2) {
                    console.log('âŒ extractContents å¤±æ•—:', e2.message);
                    try {
                        // æ–¹æ³•3: å…‹éš†å…§å®¹
                        console.log('å˜—è©¦ cloneContents...');
                        const contents = range.cloneContents();
                        span.appendChild(contents);
                        range.deleteContents();
                        range.insertNode(span);
                        console.log('âœ… cloneContents æˆåŠŸ');
                    } catch (e3) {
                        console.log('âŒ cloneContents å¤±æ•—:', e3.message);
                        // æ–¹æ³•4: æ–‡æœ¬æ›¿æ›
                        console.log('å˜—è©¦ textContent...');
                        span.textContent = range.toString();
                        range.deleteContents();
                        range.insertNode(span);
                        console.log('âš ï¸ textContent æˆåŠŸï¼ˆä¸Ÿå¤±æ ¼å¼ï¼‰');
                    }
                }
            }
            
            // æ·»åŠ åˆªé™¤äº‹ä»¶
            span.addEventListener('dblclick', function(e) {
                e.preventDefault();
                if (confirm('åˆªé™¤é€™å€‹æ¨™è¨»ï¼Ÿ')) {
                    const parent = this.parentNode;
                    while (this.firstChild) {
                        parent.insertBefore(this.firstChild, this);
                    }
                    parent.removeChild(this);
                    parent.normalize();
                }
            });
        }
        
        function clearOldHighlights() {
            const highlights = document.querySelectorAll('#old-content .simple-highlight');
            highlights.forEach(h => {
                const parent = h.parentNode;
                while (h.firstChild) {
                    parent.insertBefore(h.firstChild, h);
                }
                parent.removeChild(h);
                parent.normalize();
            });
            showStatus('old', 'å·²æ¸…é™¤æ‰€æœ‰æ¨™è¨»', 'success');
        }
    </script>

    <!-- æ–°ç‰ˆæ¨™è¨»è…³æœ¬ (ç°¡åŒ–ç‰ˆ) -->
    <script>
        let newHighlightManager = null;
        
        function testHighlightAPI() {
            if ('highlights' in CSS && CSS.highlights !== undefined) {
                showStatus('new', 'âœ… ç€è¦½å™¨æ”¯æŒ CSS Custom Highlight API', 'success');
            } else {
                showStatus('new', 'âŒ ç€è¦½å™¨ä¸æ”¯æŒ CSS Custom Highlight API\néœ€è¦ Chrome 105+, Edge 105+, Safari 17.2+', 'error');
            }
        }
        
        function initNewHighlighter() {
            testHighlightAPI();
            
            if (!('highlights' in CSS)) {
                return;
            }
            
            if (newHighlightManager) {
                return;
            }
            
            newHighlightManager = {
                highlights: new Map(),
                nextId: 1,
                currentColor: 'yellow',
                colors: {
                    yellow: '#fff3cd',
                    green: '#d4edda',
                    blue: '#cce7ff',
                    red: '#f8d7da'
                }
            };
            
            // åˆå§‹åŒ–æ¨£å¼
            Object.keys(newHighlightManager.colors).forEach(color => {
                const style = document.createElement('style');
                style.textContent = `
                    ::highlight(new-highlight-${color}) {
                        background-color: ${newHighlightManager.colors[color]};
                    }
                `;
                document.head.appendChild(style);
            });
            
            // ç›£è½é¸æ“‡äº‹ä»¶
            document.getElementById('new-content').addEventListener('mouseup', function(e) {
                const selection = window.getSelection();
                if (!selection.isCollapsed && selection.toString().trim()) {
                    const range = selection.getRangeAt(0);
                    
                    // åªæ¨™è¨»åœ¨new-contentå…§çš„é¸æ“‡
                    if (this.contains(range.commonAncestorContainer)) {
                        try {
                            applyNewHighlight(range);
                            showStatus('new', `âœ… æ¨™è¨»æˆåŠŸ: "${selection.toString().substring(0, 30)}..."`, 'success');
                        } catch (error) {
                            showStatus('new', `âŒ æ¨™è¨»å¤±æ•—: ${error.message}`, 'error');
                        }
                        selection.removeAllRanges();
                    }
                }
            });
            
            showStatus('new', 'æ–°ç‰ˆæ¨™è¨»å·¥å…·å·²å•Ÿå‹•', 'success');
        }
        
        function applyNewHighlight(range) {
            const id = `highlight-${newHighlightManager.nextId++}`;
            const color = newHighlightManager.currentColor;
            
            console.log('æ–°ç‰ˆæ¨™è¨» - é–‹å§‹', {
                id: id,
                text: range.toString(),
                startContainer: range.startContainer,
                endContainer: range.endContainer
            });
            
            // ä¿å­˜æ¨™è¨»
            newHighlightManager.highlights.set(id, {
                range: range.cloneRange(),
                color: color,
                text: range.toString()
            });
            
            // æ‡‰ç”¨CSS Highlight
            const highlight = new Highlight(range.cloneRange());
            CSS.highlights.set(`new-highlight-${color}-${id}`, highlight);
            
            console.log('âœ… CSS Highlight æ‡‰ç”¨æˆåŠŸ');
            console.log('DOMçµæ§‹æœªæ”¹è®Š âœ“');
        }
        
        function clearNewHighlights() {
            if (!newHighlightManager) {
                return;
            }
            
            // æ¸…é™¤æ‰€æœ‰CSS Highlights
            newHighlightManager.highlights.forEach((data, id) => {
                CSS.highlights.delete(`new-highlight-${data.color}-${id}`);
            });
            
            newHighlightManager.highlights.clear();
            showStatus('new', 'å·²æ¸…é™¤æ‰€æœ‰æ¨™è¨»', 'success');
        }
        
        function showStatus(side, message, type) {
            const statusEl = document.getElementById(`${side}-status`);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
