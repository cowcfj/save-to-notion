<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遷移方案完整測試 - Notion Smart Clipper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            min-height: 200px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .log-console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .log-info { color: #4ec9b0; }
        .log-success { color: #6a9955; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f48771; }
        
        .status-card {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .dom-inspector {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
        }
        
        .highlight-old {
            background-color: #fff3cd;
            cursor: pointer;
        }
        
        .highlight-new {
            background-color: #d4edda;
        }
        
        .phase-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .phase {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin: 0 5px;
            background: white;
            border: 2px solid #e0e0e0;
        }
        
        .phase.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .phase.completed {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔬 無痛遷移方案 - 完整測試套件</h1>
        <p>自動化測試新版標註功能的三階段遷移流程</p>
    </div>

    <!-- 測試控制面板 -->
    <div class="test-section">
        <h2>🎮 測試控制面板</h2>
        
        <div class="controls">
            <button class="btn-primary" onclick="runFullTest()">🚀 運行完整測試</button>
            <button class="btn-success" onclick="runPhase1Test()">測試階段1</button>
            <button class="btn-success" onclick="runPhase2Test()">測試階段2</button>
            <button class="btn-success" onclick="runPhase3Test()">測試階段3</button>
            <button class="btn-warning" onclick="testRollback()">測試回滾</button>
            <button class="btn-danger" onclick="resetAll()">重置全部</button>
            <button class="btn-secondary" onclick="inspectDOM()">檢查DOM</button>
        </div>
    </div>

    <!-- 階段指示器 -->
    <div class="test-section">
        <h2>📊 遷移階段</h2>
        <div class="phase-indicator">
            <div class="phase" id="phase-0">
                <h3>準備</h3>
                <p>創建舊標註</p>
            </div>
            <div class="phase" id="phase-1">
                <h3>階段 1</h3>
                <p>創建新標註</p>
            </div>
            <div class="phase" id="phase-2">
                <h3>階段 2</h3>
                <p>驗證</p>
            </div>
            <div class="phase" id="phase-3">
                <h3>階段 3</h3>
                <p>清理</p>
            </div>
            <div class="phase" id="phase-4">
                <h3>完成</h3>
                <p>✓</p>
            </div>
        </div>
    </div>

    <!-- 測試內容區域 -->
    <div class="test-section">
        <h2>📄 測試內容</h2>
        <div class="test-content" id="test-content">
            <h3>Notion Smart Clipper 測試文章</h3>
            
            <p>這是第一段測試文本。Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
            這段文本將被用來測試<strong>跨元素標註</strong>功能。</p>
            
            <p>第二段包含<em>不同格式</em>的文本，包括<code>代碼片段</code>和其他<span style="color: blue;">彩色文字</span>。
            這對於測試複雜DOM結構中的標註非常重要。</p>
            
            <blockquote style="border-left: 4px solid #667eea; padding-left: 15px; color: #666;">
                這是一段引用文字。引用塊是測試標註功能的重要場景之一，
                因為它涉及到不同的DOM層級和樣式。
            </blockquote>
            
            <ul>
                <li>列表項目一：測試列表內的標註功能</li>
                <li>列表項目二：包含<strong>粗體文字</strong>的項目</li>
                <li>列表項目三：多層嵌套結構測試</li>
            </ul>
            
            <p>第三段用於測試跨段落標註。這段文字的結尾部分...</p>
            <p>...將與這段文字的開始部分形成跨段落選擇，這是最具挑戰性的測試場景之一。</p>
            
            <div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin: 10px 0;">
                <p><strong>特殊容器中的文本：</strong>這段文字在一個特殊的div容器中，
                用於測試在不同容器層級中的標註行為。</p>
            </div>
        </div>
    </div>

    <!-- 性能指標 -->
    <div class="test-section">
        <h2>📈 性能指標</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">舊標註數量</div>
                <div class="metric-value" id="metric-old">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">新標註數量</div>
                <div class="metric-value" id="metric-new">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">隱藏的標註</div>
                <div class="metric-value" id="metric-hidden">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">測試通過</div>
                <div class="metric-value" id="metric-passed">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">測試失敗</div>
                <div class="metric-value" id="metric-failed">0</div>
            </div>
        </div>
    </div>

    <!-- 測試日誌 -->
    <div class="test-section">
        <h2>📝 測試日誌</h2>
        <button class="btn-secondary" onclick="clearLog()">清除日誌</button>
        <div class="log-console" id="log-console">
            <div class="log-entry log-info">等待測試開始...</div>
        </div>
    </div>

    <!-- DOM檢查器 -->
    <div class="test-section" style="display:none;" id="dom-inspector-section">
        <h2>🔍 DOM 結構檢查器</h2>
        <button class="btn-secondary" onclick="closeDOMInspector()">關閉</button>
        <button class="btn-primary" onclick="refreshDOMInspector()">刷新</button>
        <div class="dom-inspector" id="dom-inspector"></div>
    </div>

    <script>
        // 測試狀態
        let testState = {
            currentPhase: 0,
            oldHighlights: [],
            newHighlights: [],
            hiddenSpans: [],
            testsPassed: 0,
            testsFailed: 0,
            startTime: 0
        };

        // 日誌函數
        function log(message, type = 'info') {
            const console = document.getElementById('log-console');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const icon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            }[type] || 'ℹ️';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-console').innerHTML = '';
            log('日誌已清除');
        }

        // 更新階段指示器
        function updatePhaseIndicator(phase) {
            for (let i = 0; i <= 4; i++) {
                const el = document.getElementById(`phase-${i}`);
                el.classList.remove('active', 'completed');
                if (i < phase) {
                    el.classList.add('completed');
                } else if (i === phase) {
                    el.classList.add('active');
                }
            }
        }

        // 更新指標
        function updateMetrics() {
            const oldCount = document.querySelectorAll('.highlight-old:not([data-migrated])').length;
            const hiddenCount = document.querySelectorAll('.highlight-old[data-migrated]').length;
            
            document.getElementById('metric-old').textContent = oldCount;
            document.getElementById('metric-new').textContent = testState.newHighlights.length;
            document.getElementById('metric-hidden').textContent = hiddenCount;
            document.getElementById('metric-passed').textContent = testState.testsPassed;
            document.getElementById('metric-failed').textContent = testState.testsFailed;
        }

        // 創建舊版標註
        function createOldHighlights() {
            log('=== 創建舊版標註 ===', 'info');
            
            const content = document.getElementById('test-content');
            const paragraphs = content.querySelectorAll('p');
            
            let created = 0;
            paragraphs.forEach((p, index) => {
                if (index < 4) {
                    try {
                        const text = p.textContent;
                        const words = text.split(' ');
                        const start = Math.floor(words.length * 0.2);
                        const end = Math.floor(words.length * 0.6);
                        
                        const textToHighlight = words.slice(start, end).join(' ');
                        const startIndex = text.indexOf(textToHighlight);
                        
                        if (startIndex >= 0) {
                            const range = document.createRange();
                            const textNode = p.childNodes[0];
                            
                            if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                                range.setStart(textNode, startIndex);
                                range.setEnd(textNode, startIndex + textToHighlight.length);
                                
                                const span = document.createElement('span');
                                span.className = 'highlight-old';
                                span.style.backgroundColor = '#fff3cd';
                                span.style.cursor = 'pointer';
                                
                                const contents = range.extractContents();
                                span.appendChild(contents);
                                range.insertNode(span);
                                
                                testState.oldHighlights.push(span);
                                created++;
                                log(`創建標註 ${created}: "${textToHighlight.substring(0, 30)}..."`, 'success');
                            }
                        }
                    } catch (e) {
                        log(`創建標註失敗: ${e.message}`, 'error');
                        testState.testsFailed++;
                    }
                }
            });
            
            log(`✅ 共創建 ${created} 個舊版標註`, 'success');
            testState.currentPhase = 0;
            updatePhaseIndicator(0);
            updateMetrics();
            testState.testsPassed++;
        }

        // 階段1：創建新標註
        async function phase1_CreateNewHighlights() {
            log('=== 階段1：創建新標註 ===', 'info');
            testState.currentPhase = 1;
            updatePhaseIndicator(1);
            
            const oldSpans = document.querySelectorAll('.highlight-old:not([data-migrated])');
            if (oldSpans.length === 0) {
                log('沒有發現舊標註', 'warning');
                return false;
            }
            
            log(`發現 ${oldSpans.length} 個舊標註`, 'info');
            
            let created = 0;
            oldSpans.forEach((span, index) => {
                try {
                    const text = span.textContent;
                    const id = `highlight-new-${Date.now()}-${index}`;
                    
                    // 模擬創建新標註
                    span.setAttribute('data-migrated', 'true');
                    span.setAttribute('data-new-id', id);
                    span.style.opacity = '0';
                    span.style.pointerEvents = 'none';
                    
                    testState.newHighlights.push({
                        id: id,
                        text: text,
                        element: span
                    });
                    
                    testState.hiddenSpans.push(span);
                    created++;
                    
                    log(`✓ 創建新標註 ${created}: ${text.substring(0, 30)}...`, 'success');
                } catch (e) {
                    log(`✗ 創建失敗: ${e.message}`, 'error');
                    testState.testsFailed++;
                }
            });
            
            await sleep(500);
            
            log(`✅ 階段1完成！創建了 ${created} 個新標註`, 'success');
            log(`💡 舊標註已隱藏（opacity:0）但保留在DOM中`, 'info');
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // 階段2：驗證新標註
        async function phase2_VerifyHighlights() {
            log('=== 階段2：驗證新標註 ===', 'info');
            testState.currentPhase = 2;
            updatePhaseIndicator(2);
            
            await sleep(300);
            
            const newCount = testState.newHighlights.length;
            const hiddenCount = testState.hiddenSpans.length;
            
            log(`檢查 ${hiddenCount} 個隱藏的舊標註`, 'info');
            log(`驗證 ${newCount} 個新標註`, 'info');
            
            if (newCount === 0) {
                log('❌ 驗證失敗：沒有新標註', 'error');
                log('執行回滾...', 'warning');
                await rollback('verification_failed');
                testState.testsFailed++;
                return false;
            }
            
            if (newCount !== hiddenCount) {
                log(`⚠️ 警告：新標註數量(${newCount})與舊標註數量(${hiddenCount})不匹配`, 'warning');
            }
            
            await sleep(500);
            
            log(`✅ 階段2完成！驗證成功`, 'success');
            log(`✓ ${newCount} 個新標註正常工作`, 'success');
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // 階段3：移除舊標註
        async function phase3_RemoveOldHighlights() {
            log('=== 階段3：移除舊標註 ===', 'info');
            testState.currentPhase = 3;
            updatePhaseIndicator(3);
            
            const toRemove = testState.hiddenSpans.length;
            log(`準備移除 ${toRemove} 個舊標註`, 'info');
            
            await sleep(300);
            
            let removed = 0;
            testState.hiddenSpans.forEach(span => {
                try {
                    const parent = span.parentNode;
                    while (span.firstChild) {
                        parent.insertBefore(span.firstChild, span);
                    }
                    parent.removeChild(span);
                    parent.normalize();
                    removed++;
                    log(`✓ 移除舊標註 ${removed}/${toRemove}`, 'success');
                } catch (e) {
                    log(`✗ 移除失敗: ${e.message}`, 'error');
                    testState.testsFailed++;
                }
            });
            
            await sleep(500);
            
            testState.hiddenSpans = [];
            testState.oldHighlights = [];
            
            log(`🎉 階段3完成！移除了 ${removed} 個舊標註`, 'success');
            log(`✨ DOM結構已完全恢復乾淨`, 'success');
            
            testState.currentPhase = 4;
            updatePhaseIndicator(4);
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // 回滾
        async function rollback(reason) {
            log(`⚠️ 執行回滾，原因: ${reason}`, 'warning');
            
            testState.hiddenSpans.forEach(span => {
                span.style.opacity = '1';
                span.style.pointerEvents = 'auto';
                span.removeAttribute('data-migrated');
                span.removeAttribute('data-new-id');
            });
            
            testState.newHighlights = [];
            
            await sleep(500);
            
            log('✓ 回滾完成，舊標註已恢復', 'success');
            updateMetrics();
        }

        // 測試函數
        async function runPhase1Test() {
            if (testState.oldHighlights.length === 0) {
                createOldHighlights();
                await sleep(1000);
            }
            await phase1_CreateNewHighlights();
        }

        async function runPhase2Test() {
            if (testState.currentPhase < 1) {
                log('請先執行階段1', 'error');
                return;
            }
            await phase2_VerifyHighlights();
        }

        async function runPhase3Test() {
            if (testState.currentPhase < 2) {
                log('請先完成階段2', 'error');
                return;
            }
            await phase3_RemoveOldHighlights();
        }

        async function runFullTest() {
            log('🚀 開始完整測試流程', 'info');
            log('==========================================', 'info');
            testState.startTime = Date.now();
            
            // 重置
            resetAll();
            await sleep(500);
            
            // 創建舊標註
            createOldHighlights();
            await sleep(1000);
            
            // 階段1
            const phase1Success = await phase1_CreateNewHighlights();
            if (!phase1Success) {
                log('❌ 測試失敗：階段1未完成', 'error');
                return;
            }
            await sleep(1000);
            
            // 階段2
            const phase2Success = await phase2_VerifyHighlights();
            if (!phase2Success) {
                log('❌ 測試失敗：階段2驗證失敗', 'error');
                return;
            }
            await sleep(1000);
            
            // 階段3
            const phase3Success = await phase3_RemoveOldHighlights();
            if (!phase3Success) {
                log('❌ 測試失敗：階段3未完成', 'error');
                return;
            }
            
            const elapsed = ((Date.now() - testState.startTime) / 1000).toFixed(2);
            log('==========================================', 'info');
            log(`🎉 完整測試通過！耗時 ${elapsed} 秒`, 'success');
            log(`✅ 通過: ${testState.testsPassed} | ❌ 失敗: ${testState.testsFailed}`, 'info');
        }

        async function testRollback() {
            log('測試回滾機制', 'warning');
            if (testState.hiddenSpans.length === 0) {
                log('沒有隱藏的標註可以回滾', 'warning');
                return;
            }
            await rollback('manual_test');
        }

        function resetAll() {
            log('重置所有測試狀態', 'info');
            
            // 清除所有標註
            const content = document.getElementById('test-content');
            content.querySelectorAll('.highlight-old').forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            });
            
            testState = {
                currentPhase: 0,
                oldHighlights: [],
                newHighlights: [],
                hiddenSpans: [],
                testsPassed: 0,
                testsFailed: 0,
                startTime: 0
            };
            
            updatePhaseIndicator(0);
            updateMetrics();
            log('✓ 重置完成', 'success');
        }

        // DOM檢查器
        function inspectDOM() {
            const content = document.getElementById('test-content');
            const html = formatHTML(content.innerHTML);
            document.getElementById('dom-inspector').innerHTML = html;
            document.getElementById('dom-inspector-section').style.display = 'block';
            log('DOM檢查器已打開', 'info');
        }

        function closeDOMInspector() {
            document.getElementById('dom-inspector-section').style.display = 'none';
        }

        function refreshDOMInspector() {
            inspectDOM();
            log('DOM檢查器已刷新', 'info');
        }

        function formatHTML(html) {
            return html
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/data-migrated="true"/g, '<span style="color: #28a745; font-weight: bold;">data-migrated="true"</span>')
                .replace(/opacity: 0/g, '<span style="color: #ffc107; font-weight: bold;">opacity: 0</span>')
                .replace(/highlight-old/g, '<span style="color: #dc3545; font-weight: bold;">highlight-old</span>');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 初始化
        log('測試套件已就緒', 'success');
        log('點擊「運行完整測試」開始自動化測試', 'info');
        updateMetrics();
    </script>
</body>
</html>
