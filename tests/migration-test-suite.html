<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é·ç§»æ–¹æ¡ˆå®Œæ•´æ¸¬è©¦ - Notion Smart Clipper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            min-height: 200px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .log-console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .log-info { color: #4ec9b0; }
        .log-success { color: #6a9955; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f48771; }
        
        .status-card {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .dom-inspector {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
        }
        
        .highlight-old {
            background-color: #fff3cd;
            cursor: pointer;
        }
        
        .highlight-new {
            background-color: #d4edda;
        }
        
        .phase-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .phase {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin: 0 5px;
            background: white;
            border: 2px solid #e0e0e0;
        }
        
        .phase.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .phase.completed {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¬ ç„¡ç—›é·ç§»æ–¹æ¡ˆ - å®Œæ•´æ¸¬è©¦å¥—ä»¶</h1>
        <p>è‡ªå‹•åŒ–æ¸¬è©¦æ–°ç‰ˆæ¨™è¨»åŠŸèƒ½çš„ä¸‰éšæ®µé·ç§»æµç¨‹</p>
    </div>

    <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
    <div class="test-section">
        <h2>ğŸ® æ¸¬è©¦æ§åˆ¶é¢æ¿</h2>
        
        <div class="controls">
            <button class="btn-primary" onclick="runFullTest()">ğŸš€ é‹è¡Œå®Œæ•´æ¸¬è©¦</button>
            <button class="btn-success" onclick="runPhase1Test()">æ¸¬è©¦éšæ®µ1</button>
            <button class="btn-success" onclick="runPhase2Test()">æ¸¬è©¦éšæ®µ2</button>
            <button class="btn-success" onclick="runPhase3Test()">æ¸¬è©¦éšæ®µ3</button>
            <button class="btn-warning" onclick="testRollback()">æ¸¬è©¦å›æ»¾</button>
            <button class="btn-danger" onclick="resetAll()">é‡ç½®å…¨éƒ¨</button>
            <button class="btn-secondary" onclick="inspectDOM()">æª¢æŸ¥DOM</button>
        </div>
    </div>

    <!-- éšæ®µæŒ‡ç¤ºå™¨ -->
    <div class="test-section">
        <h2>ğŸ“Š é·ç§»éšæ®µ</h2>
        <div class="phase-indicator">
            <div class="phase" id="phase-0">
                <h3>æº–å‚™</h3>
                <p>å‰µå»ºèˆŠæ¨™è¨»</p>
            </div>
            <div class="phase" id="phase-1">
                <h3>éšæ®µ 1</h3>
                <p>å‰µå»ºæ–°æ¨™è¨»</p>
            </div>
            <div class="phase" id="phase-2">
                <h3>éšæ®µ 2</h3>
                <p>é©—è­‰</p>
            </div>
            <div class="phase" id="phase-3">
                <h3>éšæ®µ 3</h3>
                <p>æ¸…ç†</p>
            </div>
            <div class="phase" id="phase-4">
                <h3>å®Œæˆ</h3>
                <p>âœ“</p>
            </div>
        </div>
    </div>

    <!-- æ¸¬è©¦å…§å®¹å€åŸŸ -->
    <div class="test-section">
        <h2>ğŸ“„ æ¸¬è©¦å…§å®¹</h2>
        <div class="test-content" id="test-content">
            <h3>Notion Smart Clipper æ¸¬è©¦æ–‡ç« </h3>
            
            <p>é€™æ˜¯ç¬¬ä¸€æ®µæ¸¬è©¦æ–‡æœ¬ã€‚Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
            é€™æ®µæ–‡æœ¬å°‡è¢«ç”¨ä¾†æ¸¬è©¦<strong>è·¨å…ƒç´ æ¨™è¨»</strong>åŠŸèƒ½ã€‚</p>
            
            <p>ç¬¬äºŒæ®µåŒ…å«<em>ä¸åŒæ ¼å¼</em>çš„æ–‡æœ¬ï¼ŒåŒ…æ‹¬<code>ä»£ç¢¼ç‰‡æ®µ</code>å’Œå…¶ä»–<span style="color: blue;">å½©è‰²æ–‡å­—</span>ã€‚
            é€™å°æ–¼æ¸¬è©¦è¤‡é›œDOMçµæ§‹ä¸­çš„æ¨™è¨»éå¸¸é‡è¦ã€‚</p>
            
            <blockquote style="border-left: 4px solid #667eea; padding-left: 15px; color: #666;">
                é€™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡å­—ã€‚å¼•ç”¨å¡Šæ˜¯æ¸¬è©¦æ¨™è¨»åŠŸèƒ½çš„é‡è¦å ´æ™¯ä¹‹ä¸€ï¼Œ
                å› ç‚ºå®ƒæ¶‰åŠåˆ°ä¸åŒçš„DOMå±¤ç´šå’Œæ¨£å¼ã€‚
            </blockquote>
            
            <ul>
                <li>åˆ—è¡¨é …ç›®ä¸€ï¼šæ¸¬è©¦åˆ—è¡¨å…§çš„æ¨™è¨»åŠŸèƒ½</li>
                <li>åˆ—è¡¨é …ç›®äºŒï¼šåŒ…å«<strong>ç²—é«”æ–‡å­—</strong>çš„é …ç›®</li>
                <li>åˆ—è¡¨é …ç›®ä¸‰ï¼šå¤šå±¤åµŒå¥—çµæ§‹æ¸¬è©¦</li>
            </ul>
            
            <p>ç¬¬ä¸‰æ®µç”¨æ–¼æ¸¬è©¦è·¨æ®µè½æ¨™è¨»ã€‚é€™æ®µæ–‡å­—çš„çµå°¾éƒ¨åˆ†...</p>
            <p>...å°‡èˆ‡é€™æ®µæ–‡å­—çš„é–‹å§‹éƒ¨åˆ†å½¢æˆè·¨æ®µè½é¸æ“‡ï¼Œé€™æ˜¯æœ€å…·æŒ‘æˆ°æ€§çš„æ¸¬è©¦å ´æ™¯ä¹‹ä¸€ã€‚</p>
            
            <div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin: 10px 0;">
                <p><strong>ç‰¹æ®Šå®¹å™¨ä¸­çš„æ–‡æœ¬ï¼š</strong>é€™æ®µæ–‡å­—åœ¨ä¸€å€‹ç‰¹æ®Šçš„divå®¹å™¨ä¸­ï¼Œ
                ç”¨æ–¼æ¸¬è©¦åœ¨ä¸åŒå®¹å™¨å±¤ç´šä¸­çš„æ¨™è¨»è¡Œç‚ºã€‚</p>
            </div>
        </div>
    </div>

    <!-- æ€§èƒ½æŒ‡æ¨™ -->
    <div class="test-section">
        <h2>ğŸ“ˆ æ€§èƒ½æŒ‡æ¨™</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">èˆŠæ¨™è¨»æ•¸é‡</div>
                <div class="metric-value" id="metric-old">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æ–°æ¨™è¨»æ•¸é‡</div>
                <div class="metric-value" id="metric-new">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">éš±è—çš„æ¨™è¨»</div>
                <div class="metric-value" id="metric-hidden">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æ¸¬è©¦é€šé</div>
                <div class="metric-value" id="metric-passed">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">æ¸¬è©¦å¤±æ•—</div>
                <div class="metric-value" id="metric-failed">0</div>
            </div>
        </div>
    </div>

    <!-- æ¸¬è©¦æ—¥èªŒ -->
    <div class="test-section">
        <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
        <button class="btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        <div class="log-console" id="log-console">
            <div class="log-entry log-info">ç­‰å¾…æ¸¬è©¦é–‹å§‹...</div>
        </div>
    </div>

    <!-- DOMæª¢æŸ¥å™¨ -->
    <div class="test-section" style="display:none;" id="dom-inspector-section">
        <h2>ğŸ” DOM çµæ§‹æª¢æŸ¥å™¨</h2>
        <button class="btn-secondary" onclick="closeDOMInspector()">é—œé–‰</button>
        <button class="btn-primary" onclick="refreshDOMInspector()">åˆ·æ–°</button>
        <div class="dom-inspector" id="dom-inspector"></div>
    </div>

    <script>
        // æ¸¬è©¦ç‹€æ…‹
        let testState = {
            currentPhase: 0,
            oldHighlights: [],
            newHighlights: [],
            hiddenSpans: [],
            testsPassed: 0,
            testsFailed: 0,
            startTime: 0
        };

        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const console = document.getElementById('log-console');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const icon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            }[type] || 'â„¹ï¸';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-console').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤');
        }

        // æ›´æ–°éšæ®µæŒ‡ç¤ºå™¨
        function updatePhaseIndicator(phase) {
            for (let i = 0; i <= 4; i++) {
                const el = document.getElementById(`phase-${i}`);
                el.classList.remove('active', 'completed');
                if (i < phase) {
                    el.classList.add('completed');
                } else if (i === phase) {
                    el.classList.add('active');
                }
            }
        }

        // æ›´æ–°æŒ‡æ¨™
        function updateMetrics() {
            const oldCount = document.querySelectorAll('.highlight-old:not([data-migrated])').length;
            const hiddenCount = document.querySelectorAll('.highlight-old[data-migrated]').length;
            
            document.getElementById('metric-old').textContent = oldCount;
            document.getElementById('metric-new').textContent = testState.newHighlights.length;
            document.getElementById('metric-hidden').textContent = hiddenCount;
            document.getElementById('metric-passed').textContent = testState.testsPassed;
            document.getElementById('metric-failed').textContent = testState.testsFailed;
        }

        // å‰µå»ºèˆŠç‰ˆæ¨™è¨»
        function createOldHighlights() {
            log('=== å‰µå»ºèˆŠç‰ˆæ¨™è¨» ===', 'info');
            
            const content = document.getElementById('test-content');
            const paragraphs = content.querySelectorAll('p');
            
            let created = 0;
            paragraphs.forEach((p, index) => {
                if (index < 4) {
                    try {
                        const text = p.textContent;
                        const words = text.split(' ');
                        const start = Math.floor(words.length * 0.2);
                        const end = Math.floor(words.length * 0.6);
                        
                        const textToHighlight = words.slice(start, end).join(' ');
                        const startIndex = text.indexOf(textToHighlight);
                        
                        if (startIndex >= 0) {
                            const range = document.createRange();
                            const textNode = p.childNodes[0];
                            
                            if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                                range.setStart(textNode, startIndex);
                                range.setEnd(textNode, startIndex + textToHighlight.length);
                                
                                const span = document.createElement('span');
                                span.className = 'highlight-old';
                                span.style.backgroundColor = '#fff3cd';
                                span.style.cursor = 'pointer';
                                
                                const contents = range.extractContents();
                                span.appendChild(contents);
                                range.insertNode(span);
                                
                                testState.oldHighlights.push(span);
                                created++;
                                log(`å‰µå»ºæ¨™è¨» ${created}: "${textToHighlight.substring(0, 30)}..."`, 'success');
                            }
                        }
                    } catch (e) {
                        log(`å‰µå»ºæ¨™è¨»å¤±æ•—: ${e.message}`, 'error');
                        testState.testsFailed++;
                    }
                }
            });
            
            log(`âœ… å…±å‰µå»º ${created} å€‹èˆŠç‰ˆæ¨™è¨»`, 'success');
            testState.currentPhase = 0;
            updatePhaseIndicator(0);
            updateMetrics();
            testState.testsPassed++;
        }

        // éšæ®µ1ï¼šå‰µå»ºæ–°æ¨™è¨»
        async function phase1_CreateNewHighlights() {
            log('=== éšæ®µ1ï¼šå‰µå»ºæ–°æ¨™è¨» ===', 'info');
            testState.currentPhase = 1;
            updatePhaseIndicator(1);
            
            const oldSpans = document.querySelectorAll('.highlight-old:not([data-migrated])');
            if (oldSpans.length === 0) {
                log('æ²’æœ‰ç™¼ç¾èˆŠæ¨™è¨»', 'warning');
                return false;
            }
            
            log(`ç™¼ç¾ ${oldSpans.length} å€‹èˆŠæ¨™è¨»`, 'info');
            
            let created = 0;
            oldSpans.forEach((span, index) => {
                try {
                    const text = span.textContent;
                    const id = `highlight-new-${Date.now()}-${index}`;
                    
                    // æ¨¡æ“¬å‰µå»ºæ–°æ¨™è¨»
                    span.setAttribute('data-migrated', 'true');
                    span.setAttribute('data-new-id', id);
                    span.style.opacity = '0';
                    span.style.pointerEvents = 'none';
                    
                    testState.newHighlights.push({
                        id: id,
                        text: text,
                        element: span
                    });
                    
                    testState.hiddenSpans.push(span);
                    created++;
                    
                    log(`âœ“ å‰µå»ºæ–°æ¨™è¨» ${created}: ${text.substring(0, 30)}...`, 'success');
                } catch (e) {
                    log(`âœ— å‰µå»ºå¤±æ•—: ${e.message}`, 'error');
                    testState.testsFailed++;
                }
            });
            
            await sleep(500);
            
            log(`âœ… éšæ®µ1å®Œæˆï¼å‰µå»ºäº† ${created} å€‹æ–°æ¨™è¨»`, 'success');
            log(`ğŸ’¡ èˆŠæ¨™è¨»å·²éš±è—ï¼ˆopacity:0ï¼‰ä½†ä¿ç•™åœ¨DOMä¸­`, 'info');
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // éšæ®µ2ï¼šé©—è­‰æ–°æ¨™è¨»
        async function phase2_VerifyHighlights() {
            log('=== éšæ®µ2ï¼šé©—è­‰æ–°æ¨™è¨» ===', 'info');
            testState.currentPhase = 2;
            updatePhaseIndicator(2);
            
            await sleep(300);
            
            const newCount = testState.newHighlights.length;
            const hiddenCount = testState.hiddenSpans.length;
            
            log(`æª¢æŸ¥ ${hiddenCount} å€‹éš±è—çš„èˆŠæ¨™è¨»`, 'info');
            log(`é©—è­‰ ${newCount} å€‹æ–°æ¨™è¨»`, 'info');
            
            if (newCount === 0) {
                log('âŒ é©—è­‰å¤±æ•—ï¼šæ²’æœ‰æ–°æ¨™è¨»', 'error');
                log('åŸ·è¡Œå›æ»¾...', 'warning');
                await rollback('verification_failed');
                testState.testsFailed++;
                return false;
            }
            
            if (newCount !== hiddenCount) {
                log(`âš ï¸ è­¦å‘Šï¼šæ–°æ¨™è¨»æ•¸é‡(${newCount})èˆ‡èˆŠæ¨™è¨»æ•¸é‡(${hiddenCount})ä¸åŒ¹é…`, 'warning');
            }
            
            await sleep(500);
            
            log(`âœ… éšæ®µ2å®Œæˆï¼é©—è­‰æˆåŠŸ`, 'success');
            log(`âœ“ ${newCount} å€‹æ–°æ¨™è¨»æ­£å¸¸å·¥ä½œ`, 'success');
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // éšæ®µ3ï¼šç§»é™¤èˆŠæ¨™è¨»
        async function phase3_RemoveOldHighlights() {
            log('=== éšæ®µ3ï¼šç§»é™¤èˆŠæ¨™è¨» ===', 'info');
            testState.currentPhase = 3;
            updatePhaseIndicator(3);
            
            const toRemove = testState.hiddenSpans.length;
            log(`æº–å‚™ç§»é™¤ ${toRemove} å€‹èˆŠæ¨™è¨»`, 'info');
            
            await sleep(300);
            
            let removed = 0;
            testState.hiddenSpans.forEach(span => {
                try {
                    const parent = span.parentNode;
                    while (span.firstChild) {
                        parent.insertBefore(span.firstChild, span);
                    }
                    parent.removeChild(span);
                    parent.normalize();
                    removed++;
                    log(`âœ“ ç§»é™¤èˆŠæ¨™è¨» ${removed}/${toRemove}`, 'success');
                } catch (e) {
                    log(`âœ— ç§»é™¤å¤±æ•—: ${e.message}`, 'error');
                    testState.testsFailed++;
                }
            });
            
            await sleep(500);
            
            testState.hiddenSpans = [];
            testState.oldHighlights = [];
            
            log(`ğŸ‰ éšæ®µ3å®Œæˆï¼ç§»é™¤äº† ${removed} å€‹èˆŠæ¨™è¨»`, 'success');
            log(`âœ¨ DOMçµæ§‹å·²å®Œå…¨æ¢å¾©ä¹¾æ·¨`, 'success');
            
            testState.currentPhase = 4;
            updatePhaseIndicator(4);
            updateMetrics();
            testState.testsPassed++;
            
            return true;
        }

        // å›æ»¾
        async function rollback(reason) {
            log(`âš ï¸ åŸ·è¡Œå›æ»¾ï¼ŒåŸå› : ${reason}`, 'warning');
            
            testState.hiddenSpans.forEach(span => {
                span.style.opacity = '1';
                span.style.pointerEvents = 'auto';
                span.removeAttribute('data-migrated');
                span.removeAttribute('data-new-id');
            });
            
            testState.newHighlights = [];
            
            await sleep(500);
            
            log('âœ“ å›æ»¾å®Œæˆï¼ŒèˆŠæ¨™è¨»å·²æ¢å¾©', 'success');
            updateMetrics();
        }

        // æ¸¬è©¦å‡½æ•¸
        async function runPhase1Test() {
            if (testState.oldHighlights.length === 0) {
                createOldHighlights();
                await sleep(1000);
            }
            await phase1_CreateNewHighlights();
        }

        async function runPhase2Test() {
            if (testState.currentPhase < 1) {
                log('è«‹å…ˆåŸ·è¡Œéšæ®µ1', 'error');
                return;
            }
            await phase2_VerifyHighlights();
        }

        async function runPhase3Test() {
            if (testState.currentPhase < 2) {
                log('è«‹å…ˆå®Œæˆéšæ®µ2', 'error');
                return;
            }
            await phase3_RemoveOldHighlights();
        }

        async function runFullTest() {
            log('ğŸš€ é–‹å§‹å®Œæ•´æ¸¬è©¦æµç¨‹', 'info');
            log('==========================================', 'info');
            testState.startTime = Date.now();
            
            // é‡ç½®
            resetAll();
            await sleep(500);
            
            // å‰µå»ºèˆŠæ¨™è¨»
            createOldHighlights();
            await sleep(1000);
            
            // éšæ®µ1
            const phase1Success = await phase1_CreateNewHighlights();
            if (!phase1Success) {
                log('âŒ æ¸¬è©¦å¤±æ•—ï¼šéšæ®µ1æœªå®Œæˆ', 'error');
                return;
            }
            await sleep(1000);
            
            // éšæ®µ2
            const phase2Success = await phase2_VerifyHighlights();
            if (!phase2Success) {
                log('âŒ æ¸¬è©¦å¤±æ•—ï¼šéšæ®µ2é©—è­‰å¤±æ•—', 'error');
                return;
            }
            await sleep(1000);
            
            // éšæ®µ3
            const phase3Success = await phase3_RemoveOldHighlights();
            if (!phase3Success) {
                log('âŒ æ¸¬è©¦å¤±æ•—ï¼šéšæ®µ3æœªå®Œæˆ', 'error');
                return;
            }
            
            const elapsed = ((Date.now() - testState.startTime) / 1000).toFixed(2);
            log('==========================================', 'info');
            log(`ğŸ‰ å®Œæ•´æ¸¬è©¦é€šéï¼è€—æ™‚ ${elapsed} ç§’`, 'success');
            log(`âœ… é€šé: ${testState.testsPassed} | âŒ å¤±æ•—: ${testState.testsFailed}`, 'info');
        }

        async function testRollback() {
            log('æ¸¬è©¦å›æ»¾æ©Ÿåˆ¶', 'warning');
            if (testState.hiddenSpans.length === 0) {
                log('æ²’æœ‰éš±è—çš„æ¨™è¨»å¯ä»¥å›æ»¾', 'warning');
                return;
            }
            await rollback('manual_test');
        }

        function resetAll() {
            log('é‡ç½®æ‰€æœ‰æ¸¬è©¦ç‹€æ…‹', 'info');
            
            // æ¸…é™¤æ‰€æœ‰æ¨™è¨»
            const content = document.getElementById('test-content');
            content.querySelectorAll('.highlight-old').forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            });
            
            testState = {
                currentPhase: 0,
                oldHighlights: [],
                newHighlights: [],
                hiddenSpans: [],
                testsPassed: 0,
                testsFailed: 0,
                startTime: 0
            };
            
            updatePhaseIndicator(0);
            updateMetrics();
            log('âœ“ é‡ç½®å®Œæˆ', 'success');
        }

        // DOMæª¢æŸ¥å™¨
        function inspectDOM() {
            const content = document.getElementById('test-content');
            const html = formatHTML(content.innerHTML);
            document.getElementById('dom-inspector').innerHTML = html;
            document.getElementById('dom-inspector-section').style.display = 'block';
            log('DOMæª¢æŸ¥å™¨å·²æ‰“é–‹', 'info');
        }

        function closeDOMInspector() {
            document.getElementById('dom-inspector-section').style.display = 'none';
        }

        function refreshDOMInspector() {
            inspectDOM();
            log('DOMæª¢æŸ¥å™¨å·²åˆ·æ–°', 'info');
        }

        function formatHTML(html) {
            return html
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/data-migrated="true"/g, '<span style="color: #28a745; font-weight: bold;">data-migrated="true"</span>')
                .replace(/opacity: 0/g, '<span style="color: #ffc107; font-weight: bold;">opacity: 0</span>')
                .replace(/highlight-old/g, '<span style="color: #dc3545; font-weight: bold;">highlight-old</span>');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆå§‹åŒ–
        log('æ¸¬è©¦å¥—ä»¶å·²å°±ç·’', 'success');
        log('é»æ“Šã€Œé‹è¡Œå®Œæ•´æ¸¬è©¦ã€é–‹å§‹è‡ªå‹•åŒ–æ¸¬è©¦', 'info');
        updateMetrics();
    </script>
</body>
</html>
