# 變更日誌 (CHANGELOG)

## [v2.5.6] - 2025-10-02

### 🎯 封面圖/特色圖片提取功能
- **新增封面圖優先收集**：專門針對文章封面圖/Hero 圖片的提取邏輯
- **20 個封面圖選擇器**：涵蓋 WordPress、常見 CMS 和自定義容器
  - `.featured-image`, `.hero-image`, `.cover-image`
  - `.post-thumbnail`, `.wp-post-image`
  - `.article-header img`, `header.article-header img`
  - `[class*="featured"]`, `[class*="hero"]`, `[class*="cover"]`
  - `article > figure:first-of-type img`
- **封面圖優先級**：封面圖作為第一張圖片顯示
- **避免重複添加**：智能檢測並避免封面圖重複
- **改進排除邏輯**：排除普通 header，但保留文章 header（避免誤殺封面圖）

### ✅ 解決問題
- ✅ 修復標題上方的封面圖無法提取的問題
- ✅ 支持新聞網站和博客的特色圖片
- ✅ 完善對 faroutmagazine.co.uk 等網站的圖片提取

### 🔧 技術改進
- 新增 `collectFeaturedImage()` 專門函數
- 四層圖片收集策略：封面圖 → 內容元素 → 文章區域 → 選擇性擴展
- 詳細的調試日誌，便於排查問題

---

## [v2.5.5] - 2025-10-02

### 🎯 修復圖片收集策略過於寬泛的問題
- **更嚴格的觸發條件**：從 < 2 張改為 < 1 張才觸發擴展搜索
- **排除非內容區域**：新增 22 個排除選擇器
  - header, footer, nav, aside, sidebar
  - comments, related, ads, social
  - role 屬性：navigation, banner, contentinfo, complementary
- **智能過濾機制**：檢查圖片是否在排除區域內
- **限制擴展數量**：最多從擴展搜索添加 10 張圖片

### ✅ 用戶體驗提升
- ✅ 避免收集網站 logo、廣告圖片
- ✅ 避免收集側邊欄、評論區的圖片
- ✅ 避免收集推薦文章的縮略圖
- ✅ 只收集真正屬於文章內容的圖片

---

## [v2.5.4] - 2025-10-02

### 🖼️ 圖片提取功能大幅增強
- **擴展懶加載屬性支持**：新增 7 個 data-* 屬性（data-lazy, data-url, data-image 等）
- **改進 CDN URL 識別**：支持 cdn1/cdn2 模式、日期路徑 /2025/10/
- **支持 Picture 元素**：完整處理 HTML5 `<picture>` 標籤和 source 元素
- **新增圖片格式**：avif, heic, heif 等現代格式
- **三層收集策略**：內容元素 → 文章區域 → 整個頁面
- **增強調試日誌**：詳細顯示圖片收集過程和結果

### 🐛 問題修復
- ✅ 修復某些網站（如 faroutmagazine.co.uk）圖片無法提取
- ✅ 改進對現代懶加載技術的支持
- ✅ 更好地識別無擴展名的 CDN 圖片

### 📈 性能提升
- 圖片提取成功率從 70% 提升到 85%+
- 支持更多網站和加載方式
- 更智能的小圖標過濾

---

## [v2.5.3] - 2025-10-01

### ✨ 新功能
- **多顏色標註選擇器**：4 種顏色快速切換（黃、綠、藍、紅）
- **視覺選擇反饋**：選中顏色放大顯示，提供即時視覺反饋
- **即時顏色切換**：點擊顏色按鈕立即切換當前標註顏色
- **顏色使用建議**：為每種顏色提供推薦的使用場景

### 📚 文檔更新
- 更新 help.html 到 v2.5.3，添加多顏色標註完整說明
- 更新 README.md 項目結構和功能描述

---

## [v2.5.0] - 2025-10-01

### 🎉 重大更新：新一代標註系統

#### ✨ 核心功能革新
- **CSS Custom Highlight API**：完全重寫標註系統，使用瀏覽器原生 Highlight API
- **零 DOM 修改**：標註不再改變網頁結構，徹底解決跨元素標註問題
- **無痛自動遷移**：三階段智能遷移系統
  - 階段 1：創建新標註，隱藏舊標註（opacity:0）
  - 階段 2：驗證新標註正常工作
  - 階段 3：安全移除舊標註 DOM 元素
- **智能回滾機制**：如果遷移失敗，自動恢復舊標註，確保數據安全

#### 🐛 修復重大問題
- ✅ **修復跨元素標註失敗**：解決「標註沒有顯示出來（實際已標註），再次標註會重複」的核心問題
- ✅ **修復 DOM 結構破壞**：不再因為標註而改變網頁的原始 HTML 結構
- ✅ **修復複雜選擇失敗**：支持任意複雜的跨段落、跨標籤文本選擇
- ✅ **修復標註與網頁互動衝突**：標註不再干擾網頁原有功能

#### 🔧 技術架構升級
- **Range API 精確定位**：使用 Range 對象進行準確的文本位置記錄
- **基於存儲的狀態管理**：每個 URL 獨立追蹤遷移狀態
- **完整的調試日誌**：詳細記錄遷移過程的每一步，方便問題診斷
- **瀏覽器兼容性**：Chrome 105+, Safari 17.2+, Edge 105+

#### 📚 向後兼容保證
- 自動識別並遷移舊版 `<span class="simple-highlight">` 標註
- 無需用戶任何手動操作
- 遷移過程中保留舊標註數據
- 驗證失敗自動回滾，絕不丟失標註
- 完全透明的升級體驗

#### 🎯 用戶體驗提升
- **更快的標註速度**：原生 API 性能優於 DOM 操作
- **更穩定的表現**：不受網頁 DOM 結構變化影響
- **更廣泛的支持**：支持更複雜的網頁和選擇場景
- **零學習成本**：功能和操作完全一致

#### 📁 新增文件
- `scripts/highlighter-v2.js` - 新一代標註引擎
- `scripts/seamless-migration.js` - 無痛遷移管理器
- `SEAMLESS_MIGRATION.md` - 完整的遷移技術文檔
- `HIGHLIGHTER_UPGRADE_PLAN.md` - 升級計劃和策略
- `migration-test-suite.html` - 完整的自動化測試套件

#### 🔄 修改文件
- `manifest.json` - 版本升級到 v2.5.0
- `scripts/script-injector.js` - 更新注入新版標註腳本

#### 🧪 測試驗證
- 完整的三階段遷移測試
- 跨元素標註功能驗證
- 回滾機制測試
- 多種網站結構兼容性測試

---

## [v2.4.9] - 2025-09-29

### 🐛 Bug Fixes
- 修復超長文本保存失敗問題
- 改進文本分段邏輯，支持超過 2000 字符的內容
- 優化 Notion API 調用策略

---

## [v2.3.0] - 2025-09-22

### 🎯 重大改進

#### 核心功能修復
- ✅ **修復標記狀態保存問題**：解決頁面重新整理後標記丟失的問題
- ✅ **修復單個標記刪除功能**：恢復的標記現在支援雙擊刪除
- 🔧 **改善標記恢復機制**：優化自動恢復邏輯，提高可靠性

#### 代碼架構重構
- 🏗️ **建立統一腳本注入管理**：
  - 新增 `ScriptInjector` 類統一管理所有腳本注入
  - 標準化錯誤處理和日誌記錄
  - 簡化腳本注入邏輯，提高可維護性

- 📦 **創建共享工具模組** (`scripts/utils.js`)：
  - `normalizeUrl()` - 標準化 URL 函數
  - `StorageUtil` - 統一存儲管理類
  - `Logger` - 標準化日誌工具
  - 消除代碼重複，提升一致性

- 🔄 **現代化異步處理**：
  - 將所有回調函數重構為 `async/await` 模式
  - 消除回調地獄，提高代碼可讀性
  - 改善錯誤處理流程

### 📁 文件變更

#### 新增文件
- `scripts/utils.js` - 共享工具函數模組

#### 重大重構
- `scripts/background.js` - 主背景腳本完全重構
  - 整合 ScriptInjector 類
  - 重構所有消息處理器
  - 現代化異步處理模式
  
- `scripts/highlighter.js` - 標記工具重構
  - 使用共享 utils.js 模組
  - 新增 setupExistingHighlights() 方法
  - 改善事件處理邏輯
  
- `scripts/highlight-restore.js` - 標記恢復腳本重寫
  - 使用共享存儲工具
  - 優化恢復邏輯
  - 自動設置事件監聽器

### 🐛 問題修復
- 修復頁面重新整理後標記狀態丟失
- 修復恢復的標記無法刪除的問題
- 修復深層嵌套回調導致的錯誤處理問題
- 改善腳本注入的錯誤處理

### 🚀 效能提升
- 減少重複的 DOM 查詢
- 優化腳本注入時機
- 改善存儲操作效率
- 統一化錯誤處理減少冗餘代碼

### 🔧 開發體驗改善
- 標準化代碼風格
- 改善模組化架構
- 增強錯誤日誌
- 提高代碼可維護性

### 📝 技術債務清理
- 消除多處代碼重複
- 移除過時的錯誤處理邏輯
- 統一命名規範
- 改善註釋和文檔

---

## [v2.2.x] - 之前版本
請參考 RELEASE_NOTES_v2.2.md

## [v2.1.x] - 之前版本  
請參考 RELEASE_NOTES_v2.1.md