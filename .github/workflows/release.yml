name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (e.g., v2.9.11)'
        required: true
      draft:
        description: 'Create as draft'
        required: false
        default: 'false'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set release variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag_name }}"
            IS_DRAFT_INPUT="${{ github.event.inputs.draft }}"
          else
            TAG="${{ github.ref_name }}"
            IS_DRAFT_INPUT="false"
          fi
          echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
          echo "is_draft=${IS_DRAFT_INPUT}" >> $GITHUB_OUTPUT
          echo "zip_name=notion-smart-clipper-${TAG}.zip" >> $GITHUB_OUTPUT
          echo "release_notes_file=RELEASE_NOTES_${TAG}.md" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: |
          echo "Building production bundle with Terser compression..."
          npm run build:prod
          echo "Verifying bundle was created..."
          ls -lh dist/highlighter-v2.bundle.js
          
          # Verify bundle exists
          if [ ! -f "dist/highlighter-v2.bundle.js" ]; then
            echo "❌ Build failed: bundle not found!"
            exit 1
          fi
          
          echo "✅ Bundle created successfully"

      - name: Prepare release dist
        run: |
          # Create releases directory (keep dist/ from build)
          mkdir -p releases
          
          # Create temporary packaging directory
          mkdir -p release-package
          
          # Copy all required files for Chrome Web Store
          cp -a manifest.json release-package/
          cp -a icons release-package/
          cp -a options release-package/
          cp -a popup release-package/
          cp -a lib release-package/
          cp -a update-notification release-package/
          cp -a help.html release-package/
          
          # Copy dist folder (contains compressed bundle)
          cp -a dist release-package/
          
          # Copy scripts folder but exclude highlighter source modules
          # (they're already bundled in dist/highlighter-v2.bundle.js)
          mkdir -p release-package/scripts
          cp -a scripts/*.js release-package/scripts/
          cp -a scripts/imageExtraction release-package/scripts/
          cp -a scripts/performance release-package/scripts/
          cp -a scripts/errorHandling release-package/scripts/
          cp -a scripts/utils release-package/scripts/
          
          # Note: scripts/highlighter/ source files are NOT included
          # Only the bundled version in dist/ is needed
          
          echo "✅ Release package prepared"
          ls -la release-package/

      - name: Create zip
        run: |
          cd release-package
          zip -r "../releases/${{ steps.vars.outputs.zip_name }}" .
          
          echo "✅ Release zip created"
          ls -lh "../releases/${{ steps.vars.outputs.zip_name }}"

      - name: Detect release notes file
        id: notes
        run: |
          if [ -f "${{ steps.vars.outputs.release_notes_file }}" ]; then
            echo "has_notes=true" >> $GITHUB_OUTPUT
          else
            echo "has_notes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          name: ${{ steps.vars.outputs.tag_name }}
          draft: ${{ steps.vars.outputs.is_draft == 'true' }}
          body_path: ${{ steps.notes.outputs.has_notes == 'true' && steps.vars.outputs.release_notes_file || '' }}
          generate_release_notes: ${{ steps.notes.outputs.has_notes == 'false' }}
          files: |
            releases/${{ steps.vars.outputs.zip_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}