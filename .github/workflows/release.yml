name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (e.g., v2.9.11)'
        required: true
      draft:
        description: 'Create as draft'
        required: false
        default: 'false'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set release variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag_name }}"
            IS_DRAFT_INPUT="${{ github.event.inputs.draft }}"
          else
            TAG="${{ github.ref_name }}"
            IS_DRAFT_INPUT="false"
          fi
          echo "TAG_NAME=${TAG}" >> $GITHUB_ENV
          echo "IS_DRAFT=${IS_DRAFT_INPUT}" >> $GITHUB_ENV
          echo "ZIP_NAME=notion-smart-clipper-${TAG}.zip" >> $GITHUB_ENV
          echo "RELEASE_NOTES_FILE=RELEASE_NOTES_${TAG}.md" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: |
          echo "Building production bundle with Terser compression..."
          npm run build:prod
          echo "Verifying bundle was created..."
          ls -lh dist/highlighter-v2.bundle.js
          
          # Verify bundle exists
          if [ ! -f "dist/highlighter-v2.bundle.js" ]; then
            echo "❌ Build failed: bundle not found!"
            exit 1
          fi
          
          echo "✅ Bundle created successfully"

      - name: Prepare release dist
        run: |
          # Create releases directory (keep dist/ from build)
          mkdir -p releases
          
          # Create temporary packaging directory
          mkdir -p release-package
          
          # Copy all required files for Chrome Web Store
          cp -a manifest.json release-package/
          cp -a icons release-package/
          cp -a options release-package/
          cp -a popup release-package/
          cp -a lib release-package/
          cp -a update-notification release-package/
          cp -a help.html release-package/
          
          # Copy dist folder (contains compressed bundle)
          cp -a dist release-package/
          
          # Copy scripts folder but exclude highlighter source modules
          # (they're already bundled in dist/highlighter-v2.bundle.js)
          mkdir -p release-package/scripts
          cp -a scripts/*.js release-package/scripts/
          cp -a scripts/imageExtraction release-package/scripts/
          cp -a scripts/performance release-package/scripts/
          cp -a scripts/errorHandling release-package/scripts/
          cp -a scripts/utils release-package/scripts/
          
          # Note: scripts/highlighter/ source files are NOT included
          # Only the bundled version in dist/ is needed
          
          echo "✅ Release package prepared"
          ls -la release-package/

      - name: Create zip
        run: |
          cd release-package
          zip -r "../releases/${ZIP_NAME}" .
          
          echo "✅ Release zip created"
          ls -lh "../releases/${ZIP_NAME}"

      - name: Detect release notes file
        run: |
          if [ -f "${RELEASE_NOTES_FILE}" ]; then
            echo "HAS_NOTES=true" >> $GITHUB_ENV
          else
            echo "HAS_NOTES=false" >> $GITHUB_ENV
          fi

      - name: Create GitHub Release (with notes file)
        if: env.HAS_NOTES == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          draft: ${{ env.IS_DRAFT == 'true' }}
          body_path: ${{ env.RELEASE_NOTES_FILE }}
          files: |
            releases/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (auto-generated notes)
        if: env.HAS_NOTES == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          draft: ${{ env.IS_DRAFT == 'true' }}
          generate_release_notes: true
          files: |
            releases/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}