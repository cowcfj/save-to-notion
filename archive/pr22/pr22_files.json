[{"sha":"c7ce956f7c9b30e3f78df7869dfa84b3db4afa7a","filename":".github/workflows/test.yml","status":"modified","additions":13,"deletions":9,"changes":22,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/.github%2Fworkflows%2Ftest.yml","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/.github%2Fworkflows%2Ftest.yml","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/.github%2Fworkflows%2Ftest.yml?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -15,7 +15,7 @@ jobs:\n     \n     strategy:\n       matrix:\n-        node-version: [18.x, 20.x]\n+        node-version: [20.x]\n     \n     steps:\n     - name: Checkout repository\n@@ -47,12 +47,16 @@ jobs:\n         name: codecov-umbrella\n         fail_ci_if_error: false\n     \n-    - name: Report test results\n-      if: always()\n+    - name: Report success\n+      if: success()\n+      run: echo \"âœ… All tests passed for Node.js ${{ matrix.node-version }}\"\n+\n+    - name: Report cancelled\n+      if: cancelled()\n+      run: echo \"â¹ï¸ Tests cancelled for Node.js ${{ matrix.node-version }}\"\n+\n+    - name: Report failure\n+      if: ${{ failure() && !cancelled() }}\n       run: |\n-        if [ ${{ job.status }} == 'success' ]; then\n-          echo \"âœ… All tests passed for Node.js ${{ matrix.node-version }}\"\n-        else\n-          echo \"âŒ Tests failed for Node.js ${{ matrix.node-version }}\"\n-          exit 1\n-        fi\n+        echo \"âŒ Tests failed for Node.js ${{ matrix.node-version }}\"\n+        exit 1"},{"sha":"f4af7f7e593c205999ee492f920f8a0ccf1293b6","filename":".qwen/settings.json","status":"added","additions":3,"deletions":0,"changes":3,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/.qwen%2Fsettings.json","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/.qwen%2Fsettings.json","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/.qwen%2Fsettings.json?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -0,0 +1,3 @@\n+{\n+  \"approvalMode\": \"auto-edit\"\n+}\n\\ No newline at end of file"},{"sha":"828c2413fc950904d847a90ac587bdc7ddb408e2","filename":"PR_DESCRIPTION.md","status":"removed","additions":0,"deletions":89,"changes":89,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/d0ac42a48cf3fd8b268dffd5a0ae68bd35809973/PR_DESCRIPTION.md","raw_url":"https://github.com/cowcfj/save-to-notion/raw/d0ac42a48cf3fd8b268dffd5a0ae68bd35809973/PR_DESCRIPTION.md","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/PR_DESCRIPTION.md?ref=d0ac42a48cf3fd8b268dffd5a0ae68bd35809973","patch":"@@ -1,89 +0,0 @@\n-# ğŸ› Fix: Content Extraction Dependency Error\n-\n-## ğŸ“‹ **Problem Description**\n-\n-Users were experiencing content extraction failures with the error message:\n-- **Original**: \"Failed to save: Could not parse the article content.\"\n-- **After initial fix**: \"Failed to save: Content extraction script returned no result.\"\n-\n-## ğŸ” **Root Cause**\n-\n-The issue was caused by **PerformanceOptimizer dependency failures**:\n-- PerformanceOptimizer class failed to load or initialize properly\n-- When PerformanceOptimizer failed, the entire content extraction script would crash\n-- Script returned `null`/`undefined` instead of a valid result structure\n-- No fallback mechanism when optional dependencies were unavailable\n-\n-## âœ… **Solution**\n-\n-### 1. **Made PerformanceOptimizer Optional**\n-- Wrapped PerformanceOptimizer initialization in try-catch blocks\n-- Added graceful fallback when PerformanceOptimizer is unavailable\n-- Content extraction now works with or without optimization\n-\n-### 2. **Created Fallback Query System**\n-- Implemented `cachedQuery()` function with native DOM query fallback\n-- Replaced all `performanceOptimizer.cachedQuery()` calls with fallback function\n-- Ensures content extraction works regardless of dependency status\n-\n-### 3. **Enhanced Error Handling**\n-- Comprehensive try-catch blocks prevent dependency failures from crashing\n-- Detailed logging shows which query system is active\n-- Script always returns valid result structure\n-\n-## ğŸ“ **Files Changed**\n-\n-- **`scripts/background.js`** - Made PerformanceOptimizer optional with fallback queries\n-- **`scripts/content.js`** - Added dependency safety checks and error handling  \n-- **`scripts/utils/imageUtils.js`** - Extracted image utilities for better modularity\n-- **`manifest.json`** - Updated content script includes\n-- **`BUGFIX_CONTENT_PARSING_ERROR.md`** - Complete documentation\n-\n-## ğŸ§ª **Testing**\n-\n-### **Before Fix**\n-```\n-âŒ Error: \"Content extraction script returned no result\"\n-âŒ Extension fails when PerformanceOptimizer doesn't load\n-âŒ No fallback mechanism\n-```\n-\n-### **After Fix**  \n-```\n-âœ… Content extraction works with PerformanceOptimizer (optimized)\n-âœ… Content extraction works without PerformanceOptimizer (fallback)\n-âœ… Clear logging shows which system is active\n-âœ… No more \"script returned no result\" errors\n-```\n-\n-### **Console Output Examples**\n-- **Success**: `âœ“ PerformanceOptimizer initialized successfully`\n-- **Fallback**: `âš ï¸ PerformanceOptimizer not available, using fallback queries`\n-\n-## ğŸš€ **Performance Impact**\n-\n-- **With PerformanceOptimizer**: Full optimization (caching + batching)\n-- **Without PerformanceOptimizer**: Slightly slower but fully functional native queries\n-- **Overhead**: Negligible dependency check cost\n-\n-## ğŸ”„ **Backward Compatibility**\n-\n-âœ… **Fully backward compatible**\n-- Works normally when PerformanceOptimizer loads (optimized performance)\n-- Falls back gracefully when PerformanceOptimizer fails (still functional)\n-- No breaking changes to existing functionality\n-\n-## ğŸ“Š **Benefits**\n-\n-- ğŸ›¡ï¸ **Improved Reliability**: Content extraction works regardless of dependency status\n-- ğŸ”„ **Graceful Degradation**: Automatic fallback to native queries\n-- ğŸ“ **Better Debugging**: Clear logging shows active query system  \n-- ğŸ¯ **Zero Failures**: Script always returns valid results\n-- ğŸš€ **Maintained Performance**: Still optimized when dependencies work\n-\n----\n-\n-**Fixes**: #[issue-number] (if applicable)\n-**Type**: Bug Fix\n-**Priority**: High (affects core functionality)\n-**Testing**: Manual testing completed, no regressions detected\n\\ No newline at end of file"},{"sha":"e66a10ef820e4864b6b7b349216953c67a701b47","filename":"QWEN.md","status":"added","additions":118,"deletions":0,"changes":118,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/QWEN.md","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/QWEN.md","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/QWEN.md?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -0,0 +1,118 @@\n+# QWEN.md - Notion Smart Clipper é …ç›®ä¸Šä¸‹æ–‡\n+\n+## é …ç›®æ¦‚è¿°\n+\n+Notion Smart Clipper æ˜¯ä¸€å€‹ Chrome æ“´å±•ï¼Œç”¨æ–¼å°‡ç¶²é å…§å®¹ä¿å­˜åˆ° Notionï¼Œæ”¯æŒå¤šè‰²æ¨™è¨»å’Œæ™ºèƒ½å…§å®¹æå–ã€‚è©²æ“´å±•ä½¿ç”¨æœ€æ–°çš„ Chrome æ“´å±•æ¨™æº– (Manifest V3)ï¼Œä¸¦å…·æœ‰è±å¯Œçš„åŠŸèƒ½é›†ï¼ŒåŒ…æ‹¬æ™ºèƒ½å…§å®¹æå–ã€åœ–ç‰‡è™•ç†ã€å¤šè‰²æ¨™è¨»ç³»çµ±ã€æ¨¡æ¿è‡ªå®šç¾©ç­‰ã€‚\n+\n+### æ ¸å¿ƒæŠ€è¡“å’Œæ¶æ§‹\n+\n+- **Chrome Extension Manifest V3**: ä½¿ç”¨æœ€æ–°çš„ Chrome æ“´å±•æ¨™æº–\n+- **JavaScript**: ä¸»è¦é–‹ç™¼èªè¨€\n+- **CSS Highlight API**: ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿ API å¯¦ç¾æ¨™è¨»åŠŸèƒ½ï¼Œé›¶ DOM ä¿®æ”¹\n+- **Mozilla Readability**: ç”¨æ–¼æ™ºèƒ½æå–ç¶²é ä¸»è¦å…§å®¹\n+- **Jest**: ç”¨æ–¼å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦\n+\n+### é …ç›®çµæ§‹\n+\n+```\n+notion-chrome/\n+â”œâ”€â”€ manifest.json          # æ“´å±•é…ç½®æ–‡ä»¶\n+â”œâ”€â”€ package.json           # npm é…ç½®æ–‡ä»¶\n+â”œâ”€â”€ README.md              # é …ç›®èªªæ˜æ–‡ä»¶\n+â”œâ”€â”€ USER_GUIDE.md          # ç”¨æˆ¶æŒ‡å—\n+â”œâ”€â”€ CHANGELOG.md           # è®Šæ›´æ—¥èªŒ\n+â”œâ”€â”€ Agents.md              # AI Agent å·¥ä½œæŒ‡å—\n+â”œâ”€â”€ .github/               # GitHub é…ç½®\n+â”‚   â””â”€â”€ workflows/          # GitHub Actions å·¥ä½œæµç¨‹\n+â”œâ”€â”€ popup/                 # å½ˆå‡ºçª—å£ UI\n+â”œâ”€â”€ options/               # è¨­ç½®é é¢ï¼ˆå«æœç´¢å¼æ•¸æ“šåº«é¸æ“‡å™¨ï¼‰\n+â”œâ”€â”€ scripts/               # æ ¸å¿ƒè…³æœ¬\n+â”‚   â”œâ”€â”€ background.js      # å¾Œå°è…³æœ¬ï¼ˆNotion APIã€æ‰¹è™•ç†ï¼‰\n+â”‚   â”œâ”€â”€ content.js         # å…§å®¹è…³æœ¬ï¼ˆæå–ã€åœ–ç‰‡è™•ç†ï¼‰\n+â”‚   â”œâ”€â”€ highlighter-v2.js  # æ–°ä¸€ä»£æ¨™è¨»å¼•æ“ï¼ˆCSS Highlight APIï¼‰\n+â”‚   â”œâ”€â”€ performance/       # æ€§èƒ½å„ªåŒ–æ¨¡çµ„\n+â”‚   â”‚   â”œâ”€â”€ PerformanceOptimizer.js     # æ€§èƒ½å„ªåŒ–å™¨\n+â”‚   â”‚   â””â”€â”€ AdaptivePerformanceManager.js # è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨\n+â”‚   â””â”€â”€ utils.js           # å·¥å…·å‡½æ•¸\n+â”œâ”€â”€ lib/                   # ç¬¬ä¸‰æ–¹åº«\n+â”‚   â””â”€â”€ Readability.js     # Mozilla Readability\n+â”œâ”€â”€ tests/                 # æ¸¬è©¦æ–‡ä»¶ï¼ˆJestï¼‰\n+â”‚   â”œâ”€â”€ unit/              # å–®å…ƒæ¸¬è©¦\n+â”‚   â”‚   â”œâ”€â”€ performance/    # æ€§èƒ½æ¸¬è©¦\n+â”‚   â”‚   â”‚   â”œâ”€â”€ PerformanceOptimizer.test.js        # åŸºæœ¬æ€§èƒ½æ¸¬è©¦\n+â”‚   â”‚   â”‚   â””â”€â”€ PerformanceOptimizerAdvanced.test.js # é€²éšæ€§èƒ½æ¸¬è©¦\n+â”‚   â”‚   â””â”€â”€ ...            # å…¶ä»–å–®å…ƒæ¸¬è©¦\n+â”‚   â””â”€â”€ helpers/           # æ¸¬è©¦è¼”åŠ©æ–‡ä»¶\n+â”‚       â””â”€â”€ performance.testable.js  # å¯æ¸¬è©¦çš„æ€§èƒ½å„ªåŒ–å™¨\n+â””â”€â”€ icons/                 # åœ–æ¨™æ–‡ä»¶\n+```\n+\n+## æ§‹å»ºå’Œé‹è¡Œ\n+\n+### å®‰è£ä¾è³´\n+\n+```bash\n+npm install\n+```\n+\n+### é‹è¡Œæ¸¬è©¦\n+\n+```bash\n+# é‹è¡Œæ‰€æœ‰æ¸¬è©¦\n+npm test\n+\n+# é‹è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š\n+npm run test:coverage\n+\n+# é‹è¡Œæ¸¬è©¦ä¸¦ç›£è½æ–‡ä»¶è®ŠåŒ–\n+npm run test:watch\n+\n+# é‹è¡Œ CI æ¸¬è©¦ï¼ˆç„¡äº¤äº’æ¨¡å¼ï¼‰\n+npm run test:ci\n+```\n+\n+### é–‹ç™¼æ¨¡å¼å®‰è£æ“´å±•\n+\n+1. æ‰“é–‹ Chrome ç€è¦½å™¨ï¼Œè¨ªå• `chrome://extensions/`\n+2. é–‹å•Ÿã€Œé–‹ç™¼è€…æ¨¡å¼ã€\n+3. é»æ“Šã€Œè¼‰å…¥æœªå°è£é …ç›®ã€\n+4. é¸æ“‡é …ç›®æ ¹ç›®éŒ„\n+\n+## é–‹ç™¼ç´„å®š\n+\n+### ç·¨ç¢¼é¢¨æ ¼\n+\n+- **JavaScript**: éµå¾ª ES6+ èªæ³•æ¨™æº–\n+- **æ¨¡çµ„åŒ–**: ä½¿ç”¨ CommonJS æ¨¡çµ„ç³»çµ±\n+- **éŒ¯èª¤è™•ç†**: å®Œå–„çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„\n+- **æ€§èƒ½**: é—œæ³¨æ€§èƒ½å„ªåŒ–ï¼Œç‰¹åˆ¥æ˜¯åœ¨ DOM æ“ä½œå’Œç¶²çµ¡è«‹æ±‚æ–¹é¢\n+\n+### æ¸¬è©¦å¯¦è¸\n+\n+- **æ¸¬è©¦æ¡†æ¶**: Jest\n+- **æ¸¬è©¦é¡å‹**: å–®å…ƒæ¸¬è©¦ã€é›†æˆæ¸¬è©¦\n+- **æ¸¬è©¦è¦†è“‹ç‡**: ç›®æ¨™æ˜¯ä¿æŒé«˜æ¸¬è©¦è¦†è“‹ç‡\n+- **æ¸¬è©¦æ–‡ä»¶**: æ¸¬è©¦æ–‡ä»¶æ”¾åœ¨ `tests/` ç›®éŒ„ä¸‹ï¼Œèˆ‡è¢«æ¸¬æ–‡ä»¶ä¸€ä¸€å°æ‡‰\n+\n+### æ€§èƒ½å„ªåŒ–ç³»çµ±\n+\n+Notion Smart Clipper v2.9.0 å¼•å…¥äº†å…¨æ–°çš„æ€§èƒ½å„ªåŒ–ç³»çµ±ï¼ŒåŒ…æ‹¬ï¼š\n+\n+1. **DOM æŸ¥è©¢ç·©å­˜**: å¯¦æ–½ LRU ç·©å­˜ç­–ç•¥ï¼Œé‡è¤‡æŸ¥è©¢æ€§èƒ½æå‡ 20-50%\n+2. **æ‰¹è™•ç†ç³»çµ±**: åœ–ç‰‡å’Œ DOM æ“ä½œæ™ºèƒ½æ‰¹é‡åŒ–ï¼Œæå‡éŸ¿æ‡‰æ€§å’Œç”¨æˆ¶é«”é©—\n+3. **æ™ºèƒ½é åŠ è¼‰**: é—œéµé¸æ“‡å™¨é åŠ è¼‰æ©Ÿåˆ¶ï¼Œæ¸›å°‘é¦–æ¬¡æŸ¥è©¢å»¶é²\n+4. **URL é©—è­‰ç·©å­˜**: é¿å…é‡è¤‡é©—è­‰ç›¸åŒåœ–ç‰‡ URLï¼Œæå‡åœ–ç‰‡è™•ç†é€Ÿåº¦\n+5. **æ€§èƒ½ç›£æ§**: å¯¦æ™‚æ”¶é›†å’Œé¡¯ç¤ºæ€§èƒ½çµ±è¨ˆï¼ŒåŒ…æ‹¬ç·©å­˜å‘½ä¸­ç‡ã€æŸ¥è©¢æ™‚é–“ç­‰\n+\n+æ–°å¢çš„æ€§èƒ½å„ªåŒ–åŠŸèƒ½åŒ…æ‹¬ï¼š\n+- **ç·©å­˜é ç†±æ©Ÿåˆ¶**: `preloadSelectors` å’Œ `smartPrewarm` æ–¹æ³•\n+- **TTL (Time-To-Live) æ©Ÿåˆ¶**: ç·©å­˜éæœŸæ™‚é–“ç®¡ç†\n+- **è‡ªé©æ‡‰æ€§èƒ½ç­–ç•¥**: `AdaptivePerformanceManager` å‹•æ…‹èª¿æ•´æ€§èƒ½åƒæ•¸\n+- **æ”¹é€²çš„æ‰¹è™•ç†èª¿åº¦ç®—æ³•**: å‹•æ…‹è¨ˆç®—æœ€ä½³æ‰¹è™•ç†å¤§å°ä¸¦éé˜»å¡è™•ç†\n+\n+### è²¢ç»æŒ‡å—\n+\n+- **åˆ†æ”¯å‘½å**: ä½¿ç”¨ `feature/`, `fix/`, `chore/`, `docs/`, `refactor/` ç­‰å‰ç¶´\n+- **æäº¤è¨Šæ¯**: éµå¾ª Conventional Commits è¦ç¯„\n+- **Pull Request**: ä½¿ç”¨æä¾›çš„ PR æ¨¡æ¿\n+- **ä»£ç¢¼å¯©æ ¸**: æ‰€æœ‰ä»£ç¢¼è®Šæ›´éƒ½éœ€è¦é€šéä»£ç¢¼å¯©æ ¸\n\\ No newline at end of file"},{"sha":"e2539404245b0b78882aa0fe579a7114d870c85f","filename":"github-mcp-temp.js","status":"added","additions":115,"deletions":0,"changes":115,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/github-mcp-temp.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/github-mcp-temp.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/github-mcp-temp.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -0,0 +1,115 @@\n+#!/usr/bin/env node\n+import { McpServer } from \"@modelcontextprotocol/sdk/server/mcp.js\";\n+import { StdioServerTransport } from \"@modelcontextprotocol/sdk/server/stdio.js\";\n+import { Octokit } from \"@octokit/rest\";\n+import { z } from \"zod\";\n+\n+const GITHUB_TOKEN = process.env.GITHUB_PERSONAL_ACCESS_TOKEN;\n+if (!GITHUB_TOKEN) {\n+  throw new Error('GITHUB_PERSONAL_ACCESS_TOKEN environment variable is required');\n+}\n+\n+const octokit = new Octokit({\n+  auth: GITHUB_TOKEN,\n+});\n+\n+// Create an MCP server\n+const server = new McpServer({\n+  name: \"github-server\",\n+  version: \"0.1.0\"\n+});\n+\n+// Add a tool for getting PR reviews\n+server.tool(\n+  \"get_pr_reviews\",\n+  {\n+    owner: z.string().describe(\"Repository owner\"),\n+    repo: z.string().describe(\"Repository name\"),\n+    pull_number: z.number().describe(\"Pull request number\"),\n+  },\n+  async ({ owner, repo, pull_number }) => {\n+    try {\n+      // Get PR reviews\n+      const { data: reviews } = await octokit.pulls.listReviews({\n+        owner,\n+        repo,\n+        pull_number,\n+      });\n+\n+      // Get PR comments\n+      const { data: comments } = await octokit.pulls.listReviewComments({\n+        owner,\n+        repo,\n+        pull_number,\n+      });\n+\n+      // Get PR details\n+      const { data: pr } = await octokit.pulls.get({\n+        owner,\n+        repo,\n+        pull_number,\n+      });\n+\n+      const result = {\n+        pr: {\n+          number: pr.number,\n+          title: pr.title,\n+          state: pr.state,\n+          merged: pr.merged,\n+          mergeable: pr.mergeable,\n+          mergeable_state: pr.mergeable_state,\n+          head: {\n+            sha: pr.head.sha,\n+            ref: pr.head.ref,\n+          },\n+          base: {\n+            ref: pr.base.ref,\n+          },\n+          created_at: pr.created_at,\n+          updated_at: pr.updated_at,\n+        },\n+        reviews: reviews.map(review => ({\n+          id: review.id,\n+          user: review.user?.login,\n+          body: review.body,\n+          state: review.state,\n+          commit_id: review.commit_id,\n+          submitted_at: review.submitted_at,\n+        })),\n+        comments: comments.map(comment => ({\n+          id: comment.id,\n+          user: comment.user?.login,\n+          body: comment.body,\n+          path: comment.path,\n+          position: comment.position,\n+          commit_id: comment.commit_id,\n+          created_at: comment.created_at,\n+        })),\n+      };\n+\n+      return {\n+        content: [\n+          {\n+            type: \"text\",\n+            text: JSON.stringify(result, null, 2),\n+          },\n+        ],\n+      };\n+    } catch (error) {\n+      return {\n+        content: [\n+          {\n+            type: \"text\",\n+            text: `GitHub API error: ${error.message}`,\n+          },\n+        ],\n+        isError: true,\n+      };\n+    }\n+  }\n+);\n+\n+// Start receiving messages on stdin and sending messages on stdout\n+const transport = new StdioServerTransport();\n+await server.connect(transport);\n+console.error('GitHub MCP server running on stdio');\n\\ No newline at end of file"},{"sha":"b8f7f85e084535ba4304b32369075920d6c8325a","filename":"scripts/background.js","status":"modified","additions":9,"deletions":9,"changes":18,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fbackground.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fbackground.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/scripts%2Fbackground.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -1449,17 +1449,17 @@ async function handleSavePage(sendResponse) {\n                     performanceOptimizer = new PerformanceOptimizer({\n                         enableCache: true,\n                         enableBatching: true,\n-                        enableMetrics: true\n+                        enableMetrics: true,\n+                        cacheMaxSize: 500,  // å¢åŠ ç·©å­˜å¤§å°ä»¥æ”¯æŒæ›´å¤šé é¢å…ƒç´ \n+                        cacheTTL: 600000    // 10åˆ†é˜ TTL\n                     });\n                     \n-                    // é åŠ è¼‰é—œéµé¸æ“‡å™¨\n-                    const criticalSelectors = [\n-                        'img[src]', 'img[data-src]', 'img[data-lazy-src]',\n-                        'article', 'main', '.content', '.post-content', '.entry-content',\n-                        'link[rel*=\"icon\"]', 'meta[property=\"og:image\"]'\n-                    ];\n-                    performanceOptimizer.preloadSelectors(criticalSelectors);\n-                    console.log('âœ“ PerformanceOptimizer initialized successfully');\n+                    // ä½¿ç”¨æ™ºèƒ½é ç†±åŠŸèƒ½\n+                    performanceOptimizer.smartPrewarm(document).then(prewarmResult => {\n+                        console.log('âœ“ PerformanceOptimizer initialized successfully with smart prewarming');\n+                    }).catch(error => {\n+                        console.warn('âš ï¸ Smart prewarming failed:', error);\n+                    });\n                 } else {\n                     console.warn('âš ï¸ PerformanceOptimizer not available, using fallback queries');\n                 }"},{"sha":"b228288a187fb6fe8941ed7970709375c5a7e4e9","filename":"scripts/content.js","status":"modified","additions":8,"deletions":9,"changes":17,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fcontent.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fcontent.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/scripts%2Fcontent.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -1,5 +1,7 @@\n // This script is injected into the active tab.\n \n+/* global PerformanceOptimizer, ImageUtils, batchProcess, ErrorHandler */\n+\n (async function () {\n     try {\n         // åˆå§‹åŒ–æ€§èƒ½å„ªåŒ–å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n@@ -9,17 +11,14 @@\n                 performanceOptimizer = new PerformanceOptimizer({\n                     enableCache: true,\n                     enableBatching: true,\n-                    enableMetrics: true\n+                    enableMetrics: true,\n+                    cacheMaxSize: 500,  // å¢åŠ ç·©å­˜å¤§å°ä»¥æ”¯æŒæ›´å¤šé é¢å…ƒç´ \n+                    cacheTTL: 600000    // 10åˆ†é˜ TTL\n                 });\n \n-                // é åŠ è¼‰é—œéµé¸æ“‡å™¨\n-                const criticalSelectors = [\n-                    'img[src]', 'img[data-src]', 'img[data-lazy-src]',\n-                    'article', 'main', '.content', '.post-content', '.entry-content',\n-                    '.node__content', '.field--name-field-image', '.field--name-field-body'\n-                ];\n-                performanceOptimizer.preloadSelectors(criticalSelectors);\n-                console.log('âœ“ PerformanceOptimizer initialized in content script');\n+                // ä½¿ç”¨æ™ºèƒ½é ç†±åŠŸèƒ½\n+                const prewarmResult = await performanceOptimizer.smartPrewarm(document);\n+                console.log('âœ“ PerformanceOptimizer initialized in content script with smart prewarming');\n             } else {\n                 console.warn('âš ï¸ PerformanceOptimizer not available in content script, using fallback queries');\n             }"},{"sha":"9966a1880d9a7660c349c4308914bd09fdd088ae","filename":"scripts/highlighter-v2.js","status":"modified","additions":9,"deletions":2,"changes":11,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fhighlighter-v2.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fhighlighter-v2.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/scripts%2Fhighlighter-v2.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -2,7 +2,7 @@\n // v2.5.0 - ä¸ä¿®æ”¹DOMçµæ§‹çš„æ¨™è¨»å¯¦ç¾\n (function() {\n     // ä½¿ç”¨ä¾†è‡ª utils.js çš„å…±äº«å‡½æ•¸\n-    const { normalizeUrl, StorageUtil, Logger } = window;\n+    const { normalizeUrl, StorageUtil } = window;\n \n     /**\n      * æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æŒ CSS Custom Highlight API\n@@ -1285,6 +1285,7 @@\n         toolbar.querySelector('#close-highlight-v2').addEventListener('click', originalHide, { once: true });\n         \n         // ç›£æ§ toolbar æ˜¯å¦è¢«ç§»é™¤ï¼Œè‹¥è¢«ç§»é™¤å‰‡è‡ªå‹•é‡æ–°æ›è¼‰\n+        // å»ºç«‹ MutationObserver ä¸¦åœ¨å…¨åŸŸä¿ç•™å¼•ç”¨ï¼Œé¿å…è¢« GC\n         const mo = new MutationObserver(() => {\n             if (!document.body.contains(toolbar)) {\n                 try {\n@@ -1296,6 +1297,7 @@\n         });\n         try {\n             mo.observe(document.body, { childList: true, subtree: true });\n+            // æ³¨æ„ï¼šç¨å¾Œåœ¨ window.notionHighlighter ç”Ÿæˆå¾Œï¼ŒæœƒæŠŠ mo æ›åˆ° _observer ä¸Š\n             window.addEventListener('unload', () => mo.disconnect(), { once: true });\n         } catch (e) {\n             console.warn('MutationObserver åˆå§‹åŒ–å¤±æ•—:', e);\n@@ -1605,6 +1607,7 @@\n         });\n \n         // å…¨å±€å¼•ç”¨\n+        // ä¿ç•™ observer èˆ‡ç›£è½å™¨ç¶å®šç‹€æ…‹æ–¼å…¨åŸŸå°è±¡ï¼Œé¿å…è¢« GC æˆ–é‡è¤‡ç¶å®š\n         window.notionHighlighter = {\n             manager: manager,\n             toolbar: toolbar,\n@@ -1641,7 +1644,11 @@\n                     console.error('éš±è—æ¨™è¨»å·¥å…·æ¬„å¤±æ•—:', e);\n                 }\n             },\n-            collectHighlights: () => manager.collectHighlightsForNotion()\n+            collectHighlights: () => manager.collectHighlightsForNotion(),\n+            _observer: mo,\n+            _listenerBound: () => listenerBound,\n+            _bindDeleteListener: bindDeleteListener,\n+            _unbindDeleteListener: unbindDeleteListener\n         };\n \n         console.log('âœ… æ¨™è¨»å·¥å…·å·²åˆå§‹åŒ–');"},{"sha":"4ee9626f8e91a2c0538fee8682065f3e6bfdd161","filename":"scripts/performance/AdaptivePerformanceManager.js","status":"added","additions":237,"deletions":0,"changes":237,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fperformance%2FAdaptivePerformanceManager.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fperformance%2FAdaptivePerformanceManager.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/scripts%2Fperformance%2FAdaptivePerformanceManager.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -0,0 +1,237 @@\n+/**\n+ * è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨\n+ * æ ¹æ“šé é¢å’Œç³»çµ±æ€§èƒ½å‹•æ…‹èª¿æ•´å„ªåŒ–ç­–ç•¥\n+ */\n+const L = (typeof window !== 'undefined' && window.Logger) ? window.Logger : console;\n+class AdaptivePerformanceManager {\n+    /**\n+     * å‰µå»ºè‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨å¯¦ä¾‹\n+     * @param {PerformanceOptimizer} performanceOptimizer - æ€§èƒ½å„ªåŒ–å™¨å¯¦ä¾‹\n+     * @param {Object} options - é…ç½®é¸é …\n+     */\n+    constructor(performanceOptimizer, options = {}) {\n+        this.performanceOptimizer = performanceOptimizer;\n+        this.options = {\n+            performanceThreshold: 100, // æ€§èƒ½åŸºæº–ç·šï¼ˆmsï¼‰\n+            batchSizeAdjustmentFactor: 0.1, // æ‰¹è™•ç†å¤§å°èª¿æ•´å› å­\n+            cacheSizeAdjustmentFactor: 0.05, // ç·©å­˜å¤§å°èª¿æ•´å› å­\n+            ...options\n+        };\n+\n+        this.performanceHistory = []; // æ€§èƒ½æ­·å²è¨˜éŒ„\n+        this.currentSettings = {\n+            batchSize: 100,\n+            cacheSize: performanceOptimizer.options.cacheMaxSize,\n+            enableCache: true,\n+            enableBatching: true\n+        };\n+    }\n+\n+    /**\n+     * åˆ†æç•¶å‰é é¢ç‰¹æ€§ï¼Œèª¿æ•´æ€§èƒ½ç­–ç•¥\n+     * @param {Object} pageData - é é¢æ•¸æ“š\n+     * @returns {Promise<Object>} èª¿æ•´å¾Œçš„ç­–ç•¥\n+     */\n+    async analyzeAndAdjust(pageData = {}) {\n+        const startTime = performance.now();\n+        \n+        // åˆ†æé é¢å…§å®¹\n+        const pageAnalysis = this._analyzePageContent(pageData);\n+        \n+        // åˆ†æç³»çµ±æ€§èƒ½\n+        const systemPerformance = await this._analyzeSystemPerformance();\n+        \n+        // åŸºæ–¼åˆ†æçµæœèª¿æ•´ç­–ç•¥\n+        const strategy = this._adjustStrategyBasedOnAnalysis(pageAnalysis, systemPerformance);\n+        \n+        const duration = performance.now() - startTime;\n+        L.info(`ğŸ“Š è‡ªé©æ‡‰æ€§èƒ½åˆ†æå®Œæˆï¼Œè€—æ™‚: ${duration.toFixed(2)}ms`);\n+        \n+        return strategy;\n+    }\n+\n+    /**\n+     * åˆ†æé é¢å…§å®¹ä»¥èª¿æ•´æ€§èƒ½ç­–ç•¥\n+     * @private\n+     */\n+    _analyzePageContent(pageData) {\n+        const analysis = {\n+            elementCount: 0,\n+            imageCount: 0,\n+            textLength: 0,\n+            complexityScore: 0\n+        };\n+\n+        try {\n+            // åˆ†æç•¶å‰æ–‡æª”\n+            analysis.elementCount = document.querySelectorAll('*').length;\n+            analysis.imageCount = document.querySelectorAll('img').length;\n+            analysis.textLength = document?.body?.textContent?.length || 0;\n+            \n+            // è¨ˆç®—è¤‡é›œåº¦åˆ†æ•¸\n+            analysis.complexityScore = \n+                (analysis.elementCount / 1000) + \n+                (analysis.imageCount * 0.1) + \n+                (analysis.textLength / 10000);\n+        } catch (error) {\n+            L.warn('é é¢å…§å®¹åˆ†æå¤±æ•—:', error);\n+        }\n+\n+        return analysis;\n+    }\n+\n+    /**\n+     * åˆ†æç³»çµ±æ€§èƒ½\n+     * @private\n+     */\n+    async _analyzeSystemPerformance() {\n+        const performanceData = {\n+            memoryUsage: null,\n+            cpuLoad: null,\n+            networkCondition: 'good', // 'good', 'average', 'poor'\n+            performanceScore: 0\n+        };\n+\n+        try {\n+            // ç²å–å…§å­˜ä½¿ç”¨æƒ…æ³\n+            if (typeof performance !== 'undefined' && performance.memory) {\n+                performanceData.memoryUsage = {\n+                    used: performance.memory.usedJSHeapSize,\n+                    total: performance.memory.totalJSHeapSize,\n+                    limit: performance.memory.jsHeapSizeLimit,\n+                    usageRatio: performance.memory.usedJSHeapSize / performance.memory.totalJSHeapSize\n+                };\n+            }\n+\n+            // åŸ·è¡Œç°¡å–®çš„æ€§èƒ½æ¸¬è©¦\n+            const testStartTime = performance.now();\n+            const testArray = new Array(10000);\n+            for (let i = 0; i < 10000; i++) {\n+                testArray[i] = i * 2;\n+            }\n+            const testDuration = performance.now() - testStartTime;\n+            \n+            performanceData.performanceScore = testDuration;\n+            \n+            // åŸºæ–¼æ¸¬è©¦çµæœè©•ä¼°æ€§èƒ½\n+            if (testDuration < 10) {\n+                performanceData.networkCondition = 'good';\n+            } else if (testDuration < 50) {\n+                performanceData.networkCondition = 'average';\n+            } else {\n+                performanceData.networkCondition = 'poor';\n+            }\n+            \n+        } catch (error) {\n+            L.warn('ç³»çµ±æ€§èƒ½åˆ†æå¤±æ•—:', error);\n+        }\n+\n+        return performanceData;\n+    }\n+\n+    /**\n+     * æ ¹æ“šåˆ†æçµæœèª¿æ•´ç­–ç•¥\n+     * @private\n+     */\n+    _adjustStrategyBasedOnAnalysis(pageAnalysis, systemPerformance) {\n+        let newSettings = { ...this.currentSettings };\n+\n+        // æ ¹æ“šé é¢è¤‡é›œåº¦èª¿æ•´ç·©å­˜å¤§å°\n+        if (pageAnalysis.complexityScore > 10) {\n+            // è¤‡é›œé é¢ -> å¢åŠ ç·©å­˜å¤§å°\n+            newSettings.cacheSize = Math.min(\n+                Math.floor(this.performanceOptimizer.options.cacheMaxSize * 1.5),\n+                2000 // æœ€å¤§ç·©å­˜é™åˆ¶\n+            );\n+        } else if (pageAnalysis.complexityScore < 2) {\n+            // ç°¡å–®é é¢ -> æ¸›å°‘ç·©å­˜å¤§å°ä»¥ç¯€çœå…§å­˜\n+            newSettings.cacheSize = Math.floor(this.performanceOptimizer.options.cacheMaxSize * 0.7);\n+        }\n+\n+        // æ ¹æ“šç³»çµ±æ€§èƒ½èª¿æ•´æ‰¹è™•ç†å¤§å°\n+        if (systemPerformance.performanceScore < 20) {\n+            // é«˜æ€§èƒ½ç³»çµ± -> å¢åŠ æ‰¹è™•ç†å¤§å°\n+            newSettings.batchSize = Math.min(\n+                Math.floor(this.currentSettings.batchSize * 1.2),\n+                500 // æœ€å¤§æ‰¹è™•ç†å¤§å°\n+            );\n+        } else if (systemPerformance.performanceScore > 50) {\n+            // ä½æ€§èƒ½ç³»çµ± -> æ¸›å°‘æ‰¹è™•ç†å¤§å°\n+            newSettings.batchSize = Math.max(\n+                Math.floor(this.currentSettings.batchSize * 0.6),\n+                10 // æœ€å°æ‰¹è™•ç†å¤§å°\n+            );\n+        }\n+\n+        // æ ¹æ“šå…§å­˜ä½¿ç”¨ç‡æ±ºå®šæ˜¯å¦å•Ÿç”¨æŸäº›åŠŸèƒ½\n+        if (systemPerformance.memoryUsage && \n+            systemPerformance.memoryUsage.usageRatio > 0.8) {\n+            // å…§å­˜ä½¿ç”¨ç‡é«˜ -> é™åˆ¶æŸäº›åŠŸèƒ½\n+            newSettings.enableCache = false; // é€™å¯èƒ½ä¸æ˜¯æœ€ä½³åšæ³•ï¼Œåƒ…ä½œç¤ºä¾‹\n+        }\n+\n+        // æ›´æ–°ç•¶å‰è¨­ç½®\n+        this.currentSettings = newSettings;\n+\n+        // æ‡‰ç”¨æ–°è¨­ç½®åˆ°æ€§èƒ½å„ªåŒ–å™¨\n+        this._applySettingsToOptimizer();\n+\n+        L.info('ğŸ”„ è‡ªé©æ‡‰æ€§èƒ½ç­–ç•¥èª¿æ•´å®Œæˆ:', newSettings);\n+        L.info('ğŸ“Š é é¢åˆ†æ:', pageAnalysis);\n+        L.info('ğŸ“Š ç³»çµ±æ€§èƒ½:', systemPerformance);\n+\n+        return {\n+            settings: newSettings,\n+            pageAnalysis,\n+            systemPerformance\n+        };\n+    }\n+\n+    /**\n+     * å°‡èª¿æ•´å¾Œçš„è¨­ç½®æ‡‰ç”¨åˆ°æ€§èƒ½å„ªåŒ–å™¨\n+     * @private\n+     */\n+    _applySettingsToOptimizer() {\n+        if (this.performanceOptimizer) {\n+            // æ›´æ–°ç·©å­˜å¤§å°\n+            this.performanceOptimizer.options.cacheMaxSize = this.currentSettings.cacheSize;\n+            \n+            // é€™è£¡å¯ä»¥æ·»åŠ æ›´å¤šè¨­ç½®çš„å‹•æ…‹æ›´æ–°é‚è¼¯\n+            L.info(`ğŸ”§ å·²å°‡æ–°çš„æ€§èƒ½è¨­ç½®æ‡‰ç”¨åˆ°å„ªåŒ–å™¨:`, this.currentSettings);\n+        }\n+    }\n+\n+    /**\n+     * å‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°\n+     * @param {number} newBatchSize - æ–°çš„æ‰¹è™•ç†å¤§å°\n+     */\n+    adjustBatchSize(newBatchSize) {\n+        this.currentSettings.batchSize = Math.max(1, Math.min(1000, newBatchSize));\n+        L.info(`ğŸ”„ æ‰¹è™•ç†å¤§å°èª¿æ•´ç‚º: ${newBatchSize}`);\n+    }\n+\n+    /**\n+     * å‹•æ…‹èª¿æ•´ç·©å­˜å¤§å°\n+     * @param {number} newCacheSize - æ–°çš„ç·©å­˜å¤§å°\n+     */\n+    adjustCacheSize(newCacheSize) {\n+        this.currentSettings.cacheSize = Math.max(50, Math.min(2000, newCacheSize));\n+        this.performanceOptimizer.options.cacheMaxSize = this.currentSettings.cacheSize;\n+        L.info(`ğŸ”„ ç·©å­˜å¤§å°èª¿æ•´ç‚º: ${newCacheSize}`);\n+    }\n+\n+    /**\n+     * ç²å–ç•¶å‰æ€§èƒ½ç­–ç•¥\n+     * @returns {Object} ç•¶å‰ç­–ç•¥è¨­ç½®\n+     */\n+    getCurrentStrategy() {\n+        return { ...this.currentSettings };\n+    }\n+}\n+\n+// å°å‡ºé¡\n+if (typeof module !== 'undefined' && module.exports) {\n+    module.exports = { AdaptivePerformanceManager };\n+} else if (typeof window !== 'undefined') {\n+    window.AdaptivePerformanceManager = AdaptivePerformanceManager;\n+}\n\\ No newline at end of file"},{"sha":"959774379bbce0a7fe49a19d8161de97072dcfad","filename":"scripts/performance/PerformanceOptimizer.js","status":"modified","additions":426,"deletions":38,"changes":464,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fperformance%2FPerformanceOptimizer.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/scripts%2Fperformance%2FPerformanceOptimizer.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/scripts%2Fperformance%2FPerformanceOptimizer.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -2,6 +2,7 @@\n  * æ€§èƒ½å„ªåŒ–å™¨\n  * æä¾› DOM æŸ¥è©¢ç·©å­˜ã€æ‰¹è™•ç†éšŠåˆ—å’Œæ€§èƒ½ç›£æ§åŠŸèƒ½\n  */\n+const L = (typeof window !== 'undefined' && window.Logger) ? window.Logger : console;\n class PerformanceOptimizer {\n     /**\n      * å‰µå»ºæ€§èƒ½å„ªåŒ–å™¨å¯¦ä¾‹\n@@ -15,6 +16,11 @@ class PerformanceOptimizer {\n             cacheMaxSize: 100,\n             batchDelay: 16, // ä¸€å€‹å‹•ç•«å¹€çš„æ™‚é–“\n             metricsInterval: 5000, // 5ç§’æ”¶é›†ä¸€æ¬¡æŒ‡æ¨™\n+            cacheTTL: 300000, // 5åˆ†é˜ TTL\n+            prewarmSelectors: [ // é è¨­çš„é ç†±é¸æ“‡å™¨\n+                'img[src]', 'img[data-src]', 'article', 'main', '.content', '.post-content', '.entry-content'\n+            ],\n+            enableAdaptive: false, // æ˜¯å¦å•Ÿç”¨è‡ªé©æ‡‰åŠŸèƒ½\n             ...options\n         };\n \n@@ -23,9 +29,14 @@ class PerformanceOptimizer {\n         this.cacheStats = {\n             hits: 0,\n             misses: 0,\n-            evictions: 0\n+            evictions: 0,\n+            prewarms: 0 // é ç†±è¨ˆæ•¸\n         };\n \n+        // é ç†±ç›¸é—œå±¬æ€§\n+        this.prewarmedSelectors = new Set();\n+        this.prewarmTimeout = null;\n+\n         // æ‰¹è™•ç†éšŠåˆ—\n         this.batchQueue = [];\n         this.batchTimer = null;\n@@ -44,12 +55,60 @@ class PerformanceOptimizer {\n             averageProcessingTime: 0\n         };\n \n+        // è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†\n+        this.adaptiveManager = null;\n+        if (this.options.enableAdaptive) {\n+            this._initAdaptiveManager();\n+        }\n+\n         // åˆå§‹åŒ–æ€§èƒ½ç›£æ§\n         if (this.options.enableMetrics) {\n             this._initMetricsCollection();\n         }\n     }\n \n+    /**\n+     * åˆå§‹åŒ–è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨\n+     * @private\n+     */\n+    _initAdaptiveManager() {\n+        try {\n+            if (typeof AdaptivePerformanceManager !== 'undefined') {\n+                this.adaptiveManager = new AdaptivePerformanceManager(this, {\n+                    performanceThreshold: 100,\n+                    batchSizeAdjustmentFactor: 0.1\n+                });\n+                L.info('ğŸ¤– è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨å·²åˆå§‹åŒ–');\n+            } else {\n+                L.warn('âš ï¸ AdaptivePerformanceManager not available, adaptive features disabled');\n+            }\n+        } catch (error) {\n+            L.error('âŒ åˆå§‹åŒ–è‡ªé©æ‡‰ç®¡ç†å™¨å¤±æ•—:', error);\n+        }\n+    }\n+\n+    /**\n+     * å•Ÿç”¨è‡ªé©æ‡‰æ€§èƒ½å„ªåŒ–\n+     */\n+    enableAdaptiveOptimization() {\n+        if (!this.adaptiveManager) {\n+            this.options.enableAdaptive = true;\n+            this._initAdaptiveManager();\n+        }\n+    }\n+\n+    /**\n+     * åŸ·è¡Œè‡ªé©æ‡‰æ€§èƒ½èª¿æ•´\n+     * @param {Object} pageData - é é¢æ•¸æ“š\n+     */\n+    async adaptiveAdjustment(pageData = {}) {\n+        if (!this.adaptiveManager) {\n+            return null;\n+        }\n+\n+        return await this.adaptiveManager.analyzeAndAdjust(pageData);\n+    }\n+\n     /**\n      * ç·©å­˜çš„ DOM æŸ¥è©¢\n      * @param {string} selector - CSS é¸æ“‡å™¨\n@@ -74,12 +133,14 @@ class PerformanceOptimizer {\n             \n             const cached = this.queryCache.get(cacheKey);\n             \n-            // é©—è­‰ç·©å­˜çš„å…ƒç´ æ˜¯å¦ä»åœ¨ DOM ä¸­\n-            if (this._validateCachedElements(cached.result)) {\n+            // æª¢æŸ¥ç·©å­˜æ˜¯å¦éæœŸ\n+            const isExpired = Date.now() - cached.timestamp > this.options.cacheTTL;\n+            \n+            if (!isExpired && this._validateCachedElements(cached.result)) {\n                 this._recordQueryTime(startTime);\n                 return cached.result;\n             } else {\n-                // ç·©å­˜å¤±æ•ˆï¼Œç§»é™¤\n+                // ç·©å­˜éæœŸæˆ–å¤±æ•ˆï¼Œç§»é™¤\n                 this.queryCache.delete(cacheKey);\n             }\n         }\n@@ -92,19 +153,14 @@ class PerformanceOptimizer {\n         \n         // ç·©å­˜çµæœ\n         if (result) {\n-            // å¦‚æœç·©å­˜å·²æ»¿ï¼Œç§»é™¤æœ€èˆŠçš„é …ç›®\n-            if (this.queryCache.size >= this.options.cacheMaxSize) {\n-                const firstKey = this.queryCache.keys().next().value;\n-                if (firstKey) {\n-                    this.queryCache.delete(firstKey);\n-                    this.cacheStats.evictions++;\n-                }\n-            }\n+            // ç¶­è­·ç·©å­˜å¤§å°é™åˆ¶\n+            this._maintainCacheSizeLimit(cacheKey);\n             \n             this.queryCache.set(cacheKey, {\n                 result: result,\n                 timestamp: Date.now(),\n-                selector: selector\n+                selector: selector,\n+                ttl: this.options.cacheTTL\n             });\n         }\n \n@@ -229,7 +285,8 @@ class PerformanceOptimizer {\n             cache: {\n                 ...this.cacheStats,\n                 size: this.queryCache.size,\n-                hitRate: this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses) || 0\n+                hitRate: this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses) || 0,\n+                prewarmCount: this.prewarmedSelectors.size\n             },\n             batch: {\n                 ...this.batchStats\n@@ -323,17 +380,212 @@ class PerformanceOptimizer {\n         return false;\n     }\n \n+    /**\n+     * é ç†±é¸æ“‡å™¨ç·©å­˜\n+     * @param {Array} selectors - è¦é ç†±çš„ CSS é¸æ“‡å™¨æ•¸çµ„\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡ï¼Œé»˜èªç‚º document\n+     * @returns {Promise<Array>} é ç†±çµæœ\n+     */\n+    async preloadSelectors(selectors, context = document) {\n+        if (!this.options.enableCache || !selectors || !Array.isArray(selectors)) {\n+            return [];\n+        }\n+\n+        L.info(`ğŸ”¥ é–‹å§‹é ç†± ${selectors.length} å€‹é¸æ“‡å™¨...`);\n+        \n+        // ä½¿ç”¨æ‰¹è™•ç†æ–¹å¼é ç†±é¸æ“‡å™¨\n+        const results = [];\n+        \n+        for (const selector of selectors) {\n+            if (this.prewarmedSelectors.has(selector)) {\n+                continue; // å·²é ç†±éï¼Œè·³é\n+            }\n+            \n+            try {\n+                // åŸ·è¡ŒæŸ¥è©¢ä¸¦å°‡çµæœå­˜å…¥ç·©å­˜\n+                const result = this.cachedQuery(selector, context);\n+                \n+                if (result) {\n+                    results.push({\n+                        selector: selector,\n+                        count: result.length || (result.nodeType ? 1 : 0),\n+                        cached: true\n+                    });\n+                    \n+                    this.cacheStats.prewarms++;\n+                    this.prewarmedSelectors.add(selector);\n+                    \n+                    L.info(`âœ“ é ç†±æˆåŠŸ: ${selector} (${results[results.length - 1].count} å€‹å…ƒç´ )`);\n+                }\n+            } catch (error) {\n+                L.warn(`âš ï¸ é ç†±é¸æ“‡å™¨å¤±æ•—: ${selector}`, error);\n+                \n+                if (typeof ErrorHandler !== 'undefined') {\n+                    ErrorHandler.logError({\n+                        type: 'preload_error',\n+                        context: `preloading selector: ${selector}`,\n+                        originalError: error,\n+                        timestamp: Date.now()\n+                    });\n+                }\n+                \n+                results.push({\n+                    selector: selector,\n+                    error: error.message,\n+                    cached: false\n+                });\n+            }\n+        }\n+        \n+        L.info(`ğŸ”¥ é ç†±å®Œæˆ: ${results.filter(r => r.cached).length}/${selectors.length} å€‹é¸æ“‡å™¨å·²é ç†±`);\n+        return results;\n+    }\n+\n+    /**\n+     * æ™ºèƒ½é ç†± - åŸºæ–¼ç•¶å‰é é¢å…§å®¹è‡ªå‹•é ç†±ç›¸é—œé¸æ“‡å™¨\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡ï¼Œé»˜èªç‚º document\n+     * @returns {Promise<Array>} é ç†±çµæœ\n+     */\n+    async smartPrewarm(context = document) {\n+        const startTime = performance.now();\n+        \n+        // åŸºæ–¼ç•¶å‰é é¢åˆ†æï¼Œå‹•æ…‹ç”Ÿæˆé ç†±é¸æ“‡å™¨\n+        const dynamicSelectors = this._analyzePageForPrewarming(context);\n+        \n+        // åˆä½µé…ç½®ä¸­çš„é è¨­é¸æ“‡å™¨å’Œå‹•æ…‹ç”Ÿæˆçš„é¸æ“‡å™¨\n+        const allSelectors = [...new Set([...this.options.prewarmSelectors, ...dynamicSelectors])];\n+        \n+        const results = await this.preloadSelectors(allSelectors, context);\n+        \n+        const duration = performance.now() - startTime;\n+        L.info(`ğŸ§  æ™ºèƒ½é ç†±å®Œæˆï¼Œè€—æ™‚: ${duration.toFixed(2)}ms`);\n+        \n+        return results;\n+    }\n+\n+    /**\n+     * åŸºæ–¼ç•¶å‰é é¢å…§å®¹åˆ†æï¼Œå‹•æ…‹ç”Ÿæˆé ç†±é¸æ“‡å™¨\n+     * @private\n+     */\n+    _analyzePageForPrewarming(context) {\n+        const selectors = [];\n+        \n+        // æª¢æŸ¥é é¢çµæ§‹ï¼Œç”Ÿæˆå¯èƒ½çš„é¸æ“‡å™¨\n+        if (context.querySelector('article')) {\n+            selectors.push('article h1', 'article h2', 'article h3', 'article p', 'article img');\n+        }\n+        \n+        if (context.querySelector('[role=\"main\"]')) {\n+            selectors.push('[role=\"main\"] *');\n+        }\n+        \n+        // æª¢æŸ¥æ˜¯å¦æœ‰å¸¸è¦‹çš„ CMS é¡å\n+        const cmsPatterns = ['.entry-content', '.post-content', '.article-content', '.content-area'];\n+        cmsPatterns.forEach(pattern => {\n+            if (context.querySelector(pattern)) {\n+                selectors.push(`${pattern} p`, `${pattern} img`, `${pattern} h1`, `${pattern} h2`, `${pattern} h3`);\n+            }\n+        });\n+        \n+        return selectors;\n+    }\n+\n+    /**\n+     * ç¶­è­·ç·©å­˜å¤§å°é™åˆ¶ï¼Œå¯¦ç¾ LRU ç­–ç•¥\n+     * @private\n+     */\n+    _maintainCacheSizeLimit(newKey) {\n+        if (this.queryCache.size < this.options.cacheMaxSize) {\n+            return; // å°šæœªé”åˆ°æœ€å¤§å¤§å°ï¼Œç„¡éœ€æ¸…ç†\n+        }\n+\n+        // å¦‚æœé”åˆ°æœ€å¤§å¤§å°ï¼Œç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„é …ç›®\n+        const firstKey = this.queryCache.keys().next().value;\n+        if (firstKey && firstKey !== newKey) {\n+            this.queryCache.delete(firstKey);\n+            this.cacheStats.evictions++;\n+        }\n+    }\n+\n+    /**\n+     * æ¸…ç†éæœŸçš„ç·©å­˜é …ç›®\n+     * @param {Object} options - æ¸…ç†é¸é …\n+     * @returns {number} æ¸…ç†çš„é …ç›®æ•¸é‡\n+     */\n+    clearExpiredCache(options = {}) {\n+        const { force = false, maxAge = this.options.cacheTTL } = options;\n+        let clearedCount = 0;\n+\n+        // å¦‚æœå¼·åˆ¶æ¸…ç†ï¼Œå‰‡æ¸…ç†æ‰€æœ‰ç·©å­˜\n+        if (force) {\n+            clearedCount = this.queryCache.size;\n+            this.queryCache.clear();\n+            return clearedCount;\n+        }\n+\n+        // å¦å‰‡åªæ¸…ç†éæœŸçš„ç·©å­˜\n+        const now = Date.now();\n+        for (const [key, cached] of this.queryCache.entries()) {\n+            if (now - cached.timestamp > maxAge) {\n+                this.queryCache.delete(key);\n+                clearedCount++;\n+            }\n+        }\n+\n+        return clearedCount;\n+    }\n+\n+    /**\n+     * å¼·åˆ¶åˆ·æ–°ç‰¹å®šé¸æ“‡å™¨çš„ç·©å­˜\n+     * @param {string|Array} selectors - è¦åˆ·æ–°çš„é¸æ“‡å™¨æˆ–é¸æ“‡å™¨æ•¸çµ„\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡\n+     * @param {Object} options - æŸ¥è©¢é¸é …\n+     */\n+    refreshCache(selectors, context = document, options = {}) {\n+        const selectorList = Array.isArray(selectors) ? selectors : [selectors];\n+        \n+        for (const selector of selectorList) {\n+            const cacheKey = this._generateCacheKey(selector, context, options);\n+            if (this.queryCache.has(cacheKey)) {\n+                // åŸ·è¡Œæ–°çš„æŸ¥è©¢ä¸¦æ›´æ–°ç·©å­˜\n+                const result = this._performQuery(selector, context, options);\n+                \n+                if (result) {\n+                    this.queryCache.set(cacheKey, {\n+                        result: result,\n+                        timestamp: Date.now(),\n+                        selector: selector,\n+                        ttl: this.options.cacheTTL\n+                    });\n+                } else {\n+                    // å¦‚æœæ–°æŸ¥è©¢æ²’æœ‰çµæœï¼Œå‰‡åˆªé™¤ç·©å­˜\n+                    this.queryCache.delete(cacheKey);\n+                }\n+            }\n+        }\n+    }\n+\n     /**\n      * å®‰æ’æ‰¹è™•ç†\n      * @private\n      */\n     _scheduleBatchProcessing() {\n         if (this.batchTimer) return;\n \n-        this.batchTimer = setTimeout(() => {\n-            this._processBatch();\n-            this.batchTimer = null;\n-        }, this.options.batchDelay);\n+        // ä½¿ç”¨ requestAnimationFrame é€²è¡Œæ›´å„ªåŒ–çš„èª¿åº¦\n+        // å¦‚æœæ”¯æŒ requestIdleCallbackï¼Œå‰‡å„ªå…ˆä½¿ç”¨å®ƒ\n+        if (typeof requestIdleCallback !== 'undefined') {\n+            this.batchTimer = requestIdleCallback(() => {\n+                this._processBatch();\n+                this.batchTimer = null;\n+            }, { timeout: this.options.batchDelay });\n+        } else {\n+            // å›é€€åˆ° setTimeout\n+            this.batchTimer = setTimeout(() => {\n+                this._processBatch();\n+                this.batchTimer = null;\n+            }, this.options.batchDelay);\n+        }\n     }\n \n     /**\n@@ -343,26 +595,70 @@ class PerformanceOptimizer {\n     _processBatch() {\n         if (this.batchQueue.length === 0) return;\n \n+        // å‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°ï¼Œæ ¹æ“šéšŠåˆ—å¤§å°æ±ºå®šæ˜¯å¦åˆ†æ‰¹è™•ç†\n+        const maxBatchSize = this._calculateOptimalBatchSize();\n+        const currentBatch = this.batchQueue.length > maxBatchSize \n+            ? this.batchQueue.splice(0, maxBatchSize) \n+            : [...this.batchQueue];\n+        \n+        this.batchQueue = this.batchQueue.length > maxBatchSize \n+            ? this.batchQueue \n+            : [];\n+\n         const startTime = performance.now();\n-        const currentBatch = [...this.batchQueue];\n-        this.batchQueue = [];\n \n         // æ›´æ–°æ‰¹è™•ç†çµ±è¨ˆ\n         this.batchStats.totalBatches++;\n         this.batchStats.totalItems += currentBatch.length;\n         this.batchStats.averageBatchSize = this.batchStats.totalItems / this.batchStats.totalBatches;\n \n-        // è™•ç†æ¯å€‹æ‰¹è™•ç†é …ç›®\n-        currentBatch.forEach(item => {\n+        // åˆ†æ‰¹è™•ç†ä»¥é¿å…é˜»å¡ UI\n+        this._processBatchItems(currentBatch, startTime);\n+    }\n+\n+    /**\n+     * è¨ˆç®—æœ€ä½³æ‰¹è™•ç†å¤§å°\n+     * @private\n+     */\n+    _calculateOptimalBatchSize() {\n+        // æ ¹æ“šéšŠåˆ—å¤§å°å’Œæ­·å²æ€§èƒ½æ•¸æ“šå‹•æ…‹èª¿æ•´\n+        const queueLength = this.batchQueue.length;\n+        \n+        if (queueLength === 0) return 100; // é»˜èªå¤§å°\n+        \n+        // å¦‚æœéšŠåˆ—å¾ˆé•·ï¼Œä½¿ç”¨è¼ƒå¤§çš„æ‰¹è™•ç†ä»¥æé«˜æ•ˆç‡\n+        if (queueLength > 500) return 200;\n+        if (queueLength > 200) return 150;\n+        if (queueLength > 50) return 100;\n+        \n+        // å¦‚æœéšŠåˆ—è¼ƒçŸ­ï¼Œä½¿ç”¨è¼ƒå°çš„æ‰¹è™•ç†ä»¥ä¿æŒéŸ¿æ‡‰æ€§\n+        return 50;\n+    }\n+\n+    /**\n+     * åˆ†æ‰¹è™•ç†é …ç›®ä»¥é¿å…é˜»å¡ UI\n+     * @private\n+     */\n+    _processBatchItems(items, startTime, index = 0, results = []) {\n+        const chunkSize = 10; // æ¯æ¬¡è™•ç†çš„é …ç›®æ•¸é‡\n+        const endIndex = Math.min(index + chunkSize, items.length);\n+\n+        // è™•ç†ç•¶å‰å¡Š\n+        for (let i = index; i < endIndex; i++) {\n+            const item = items[i];\n             try {\n                 if (item.type === 'dom') {\n                     // DOM æ“ä½œæ‰¹è™•ç†\n-                    const results = item.operations.map(op => op());\n-                    item.resolve(results);\n+                    const result = item.operations.map(op => op());\n+                    item.resolve(result);\n+                    results.push(result);\n                 } else {\n-                    // åœ–ç‰‡è™•ç†æ‰¹è™•ç†\n-                    const results = item.images.map(item.processor);\n-                    item.resolve(results);\n+                    // åœ–ç‰‡è™•ç†æ‰¹è™•ç†æˆ–å…¶ä»–è™•ç†\n+                    const result = Array.isArray(item.images) \n+                        ? item.images.map(img => item.processor(img))\n+                        : [item.processor()]; // è™•ç†å–®å€‹é …ç›®\n+                    item.resolve(result);\n+                    results.push(result);\n                 }\n             } catch (error) {\n                 if (typeof ErrorHandler !== 'undefined') {\n@@ -375,13 +671,27 @@ class PerformanceOptimizer {\n                 }\n                 item.resolve([]);\n             }\n-        });\n+        }\n \n-        // è¨˜éŒ„è™•ç†æ™‚é–“\n-        const processingTime = performance.now() - startTime;\n-        this.metrics.totalProcessingTime += processingTime;\n-        this.metrics.batchOperations++;\n-        this.metrics.averageProcessingTime = this.metrics.totalProcessingTime / this.metrics.batchOperations;\n+        // å¦‚æœé‚„æœ‰æ›´å¤šé …ç›®ï¼Œå®‰æ’ä¸‹ä¸€å¡Šè™•ç†\n+        if (endIndex < items.length) {\n+            // ä½¿ç”¨ requestAnimationFrame æˆ– setTimeout ä¾†è®“å‡ºæ§åˆ¶æ¬Š\n+            if (typeof requestAnimationFrame !== 'undefined') {\n+                requestAnimationFrame(() => {\n+                    this._processBatchItems(items, startTime, endIndex, results);\n+                });\n+            } else {\n+                setTimeout(() => {\n+                    this._processBatchItems(items, startTime, endIndex, results);\n+                }, 0);\n+            }\n+        } else {\n+            // æ‰€æœ‰é …ç›®å·²å®Œæˆè™•ç†\n+            const processingTime = performance.now() - startTime;\n+            this.metrics.totalProcessingTime += processingTime;\n+            this.metrics.batchOperations++;\n+            this.metrics.averageProcessingTime = this.metrics.totalProcessingTime / this.metrics.batchOperations;\n+        }\n     }\n \n     /**\n@@ -393,16 +703,65 @@ class PerformanceOptimizer {\n         \n         for (let i = 0; i < items.length; i += batchSize) {\n             const batch = items.slice(i, i + batchSize);\n-            const batchPromises = batch.map(processor);\n-            const batchResults = await Promise.allSettled(batchPromises);\n             \n-            results.push(...batchResults.map(result => \n-                result.status === 'fulfilled' ? result.value : { error: result.reason }\n-            ));\n+            // ä½¿ç”¨å‹•æ…‹æ‰¹è™•ç†å¤§å°èª¿æ•´\n+            const dynamicBatchSize = this._adjustBatchSizeForPerformance(batch.length);\n+            if (dynamicBatchSize < batch.length) {\n+                // å¦‚æœå‹•æ…‹å¤§å°å°æ–¼ç•¶å‰æ‰¹æ¬¡ï¼Œé€²è¡Œç´°åˆ†\n+                for (let j = 0; j < batch.length; j += dynamicBatchSize) {\n+                    const subBatch = batch.slice(j, j + dynamicBatchSize);\n+                    const subBatchPromises = subBatch.map(processor);\n+                    const subBatchResults = await Promise.allSettled(subBatchPromises);\n+                    \n+                    results.push(...subBatchResults.map(result => \n+                        result.status === 'fulfilled' ? result.value : { error: result.reason }\n+                    ));\n+                    \n+                    // åœ¨æ‰¹æ¬¡ä¹‹é–“æä¾›çŸ­æš«å»¶é²ä»¥ä¿æŒ UI éŸ¿æ‡‰\n+                    await this._yieldToMain();\n+                }\n+            } else {\n+                const batchPromises = batch.map(processor);\n+                const batchResults = await Promise.allSettled(batchPromises);\n+                \n+                results.push(...batchResults.map(result => \n+                    result.status === 'fulfilled' ? result.value : { error: result.reason }\n+                ));\n+            }\n         }\n         \n         return results;\n     }\n+    \n+    /**\n+     * æ ¹æ“šæ€§èƒ½å‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°\n+     * @private\n+     */\n+    _adjustBatchSizeForPerformance(currentSize) {\n+        // å¦‚æœæœ‰æ€§èƒ½æ­·å²æ•¸æ“šï¼Œæ ¹æ“šæ­·å²æ€§èƒ½èª¿æ•´å¤§å°\n+        if (this.metrics.averageProcessingTime && this.metrics.averageProcessingTime > 100) {\n+            // å¦‚æœå¹³å‡è™•ç†æ™‚é–“éé•·ï¼Œæ¸›å°‘æ‰¹æ¬¡å¤§å°\n+            return Math.max(1, Math.floor(currentSize * 0.7));\n+        } else if (this.metrics.averageProcessingTime && this.metrics.averageProcessingTime < 10) {\n+            // å¦‚æœè™•ç†å¾ˆå¿«ï¼Œå¯ä»¥å¢åŠ æ‰¹æ¬¡å¤§å°\n+            return Math.min(500, currentSize * 1.5);\n+        }\n+        return currentSize;\n+    }\n+    \n+    /**\n+     * è®“å‡ºæ§åˆ¶æ¬Šçµ¦ä¸»ç·šç¨‹ä»¥ä¿æŒéŸ¿æ‡‰æ€§\n+     * @private\n+     */\n+    _yieldToMain() {\n+        return new Promise(resolve => {\n+            if (typeof requestIdleCallback !== 'undefined') {\n+                requestIdleCallback(() => resolve());\n+            } else {\n+                setTimeout(() => resolve(), 1);  // çµ¦ç€è¦½å™¨æ©Ÿæœƒè™•ç†å…¶ä»–ä»»å‹™\n+            }\n+        });\n+    }\n \n     /**\n      * è¨˜éŒ„æŸ¥è©¢æ™‚é–“\n@@ -460,6 +819,35 @@ class PerformanceOptimizer {\n         }\n         return null;\n     }\n+\n+    /**\n+     * æ ¹æ“šç•¶å‰ç³»çµ±è² è¼‰èª¿æ•´æ€§èƒ½åƒæ•¸\n+     */\n+    async adjustForSystemLoad() {\n+        // ç²å–ç•¶å‰æ€§èƒ½æŒ‡æ¨™\n+        const stats = this.getStats();\n+        \n+        // æ ¹æ“šç·©å­˜å‘½ä¸­ç‡èª¿æ•´ç­–ç•¥\n+        if (stats.cache.hitRate < 0.3) {\n+            // ç·©å­˜å‘½ä¸­ç‡ä½ï¼Œå¯èƒ½éœ€è¦å¢åŠ ç·©å­˜å¤§å°æˆ–æ¸…ç†ç­–ç•¥\n+            L.info('ğŸ“Š ç·©å­˜å‘½ä¸­ç‡è¼ƒä½ï¼Œè€ƒæ…®èª¿æ•´ç·©å­˜ç­–ç•¥');\n+        }\n+        \n+        // æ ¹æ“šå¹³å‡è™•ç†æ™‚é–“èª¿æ•´æ‰¹è™•ç†å¤§å°\n+        if (stats.metrics.averageProcessingTime > 50) {\n+            // è™•ç†æ™‚é–“éé•·ï¼Œæ¸›å°‘æ‰¹è™•ç†å¤§å°\n+            L.info('â° è™•ç†æ™‚é–“éé•·ï¼Œå‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°');\n+            if (this.adaptiveManager) {\n+                this.adaptiveManager.adjustBatchSize(Math.floor(this.currentSettings.batchSize * 0.8));\n+            }\n+        }\n+        \n+        // å®šæœŸæ¸…ç†éæœŸç·©å­˜\n+        const expiredCount = this.clearExpiredCache();\n+        if (expiredCount > 0) {\n+            L.info(`ğŸ§¹ æ¸…ç†äº† ${expiredCount} å€‹éæœŸçš„ç·©å­˜é …ç›®`);\n+        }\n+    }\n }\n \n // å‰µå»ºé»˜èªå¯¦ä¾‹"},{"sha":"ae23657e7f56aa3dc12e55db5af113c8459e246a","filename":"tests/helpers/performance.testable.js","status":"modified","additions":357,"deletions":14,"changes":371,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/tests%2Fhelpers%2Fperformance.testable.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/tests%2Fhelpers%2Fperformance.testable.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/tests%2Fhelpers%2Fperformance.testable.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -20,6 +20,11 @@ class PerformanceOptimizer {\n             cacheMaxSize: 1000,\n             batchDelay: 16, // ä¸€å€‹å‹•ç•«å¹€çš„æ™‚é–“\n             metricsInterval: 5000, // 5ç§’æ”¶é›†ä¸€æ¬¡æŒ‡æ¨™\n+            cacheTTL: 300000, // 5åˆ†é˜ TTL\n+            prewarmSelectors: [ // é è¨­çš„é ç†±é¸æ“‡å™¨\n+                'img[src]', 'img[data-src]', 'article', 'main', '.content', '.post-content', '.entry-content'\n+            ],\n+            enableAdaptive: false, // æ˜¯å¦å•Ÿç”¨è‡ªé©æ‡‰åŠŸèƒ½\n             ...options\n         };\n         \n@@ -28,21 +33,71 @@ class PerformanceOptimizer {\n         this.cacheStats = {\n             hits: 0,\n             misses: 0,\n-            evictions: 0\n+            evictions: 0,\n+            prewarms: 0 // é ç†±è¨ˆæ•¸\n         };\n+\n+        // é ç†±ç›¸é—œå±¬æ€§\n+        this.prewarmedSelectors = new Set();\n+        this.prewarmTimeout = null;\n         \n         // æ‰¹è™•ç†éšŠåˆ—\n         this.batchQueue = [];\n         this.batchTimer = null;\n         this.processingBatch = false;\n+        this.batchStats = {\n+            totalBatches: 0,\n+            totalItems: 0,\n+            averageBatchSize: 0\n+        };\n         \n         // æ€§èƒ½æŒ‡æ¨™\n         this.metrics = {\n             domQueries: 0,\n             cacheHits: 0,\n             batchOperations: 0,\n             averageQueryTime: 0,\n-            totalQueryTime: 0\n+            totalQueryTime: 0,\n+            totalProcessingTime: 0,\n+            averageProcessingTime: 0\n+        };\n+\n+        // è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†\n+        this.adaptiveManager = null;\n+        if (this.options.enableAdaptive) {\n+            this._initAdaptiveManager();\n+        }\n+    }\n+\n+    /**\n+     * åˆå§‹åŒ–è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨\n+     * @private\n+     */\n+    _initAdaptiveManager() {\n+        // åœ¨æ¸¬è©¦ç’°å¢ƒä¸­ä¸å¯¦ç¾è¤‡é›œçš„è‡ªé©æ‡‰é‚è¼¯\n+        console.log('ğŸ¤– è‡ªé©æ‡‰æ€§èƒ½ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼ˆæ¸¬è©¦ç’°å¢ƒï¼‰');\n+    }\n+\n+    /**\n+     * å•Ÿç”¨è‡ªé©æ‡‰æ€§èƒ½å„ªåŒ–\n+     */\n+    enableAdaptiveOptimization() {\n+        if (!this.adaptiveManager) {\n+            this.options.enableAdaptive = true;\n+            this._initAdaptiveManager();\n+        }\n+    }\n+\n+    /**\n+     * åŸ·è¡Œè‡ªé©æ‡‰æ€§èƒ½èª¿æ•´\n+     * @param {Object} pageData - é é¢æ•¸æ“š\n+     */\n+    async adaptiveAdjustment(pageData = {}) {\n+        // åœ¨æ¸¬è©¦ç’°å¢ƒä¸­è¿”å›åŸºæœ¬çµæœ\n+        return {\n+            settings: { ...this.currentSettings },\n+            pageAnalysis: { elementCount: 0, imageCount: 0, textLength: 0, complexityScore: 0 },\n+            systemPerformance: { memoryUsage: null, cpuLoad: null, networkCondition: 'good', performanceScore: 0 }\n         };\n     }\n \n@@ -62,9 +117,19 @@ class PerformanceOptimizer {\n         \n         // æª¢æŸ¥ç·©å­˜\n         if (this.queryCache.has(cacheKey)) {\n-            this.cacheStats.hits++;\n-            this.metrics.cacheHits++;\n-            return this.queryCache.get(cacheKey).result;\n+            const cached = this.queryCache.get(cacheKey);\n+            \n+            // æª¢æŸ¥ç·©å­˜æ˜¯å¦éæœŸ\n+            const isExpired = Date.now() - cached.timestamp > this.options.cacheTTL;\n+            \n+            if (!isExpired) {\n+                this.cacheStats.hits++;\n+                this.metrics.cacheHits++;\n+                return cached.result;\n+            } else {\n+                // ç·©å­˜éæœŸï¼Œç§»é™¤\n+                this.queryCache.delete(cacheKey);\n+            }\n         }\n \n         // åŸ·è¡ŒæŸ¥è©¢\n@@ -138,12 +203,171 @@ class PerformanceOptimizer {\n         });\n     }\n \n+    /**\n+     * é ç†±é¸æ“‡å™¨ç·©å­˜\n+     * @param {Array} selectors - è¦é ç†±çš„ CSS é¸æ“‡å™¨æ•¸çµ„\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡ï¼Œé»˜èªç‚º document\n+     * @returns {Promise<Array>} é ç†±çµæœ\n+     */\n+    async preloadSelectors(selectors, context = document) {\n+        if (!this.options.enableCache || !selectors || !Array.isArray(selectors)) {\n+            return [];\n+        }\n+\n+        console.log(`ğŸ”¥ é–‹å§‹é ç†± ${selectors.length} å€‹é¸æ“‡å™¨...`);\n+        \n+        // ä½¿ç”¨æ‰¹è™•ç†æ–¹å¼é ç†±é¸æ“‡å™¨\n+        const results = [];\n+        \n+        for (const selector of selectors) {\n+            if (this.prewarmedSelectors.has(selector)) {\n+                continue; // å·²é ç†±éï¼Œè·³é\n+            }\n+            \n+            try {\n+                // åŸ·è¡ŒæŸ¥è©¢ä¸¦å°‡çµæœå­˜å…¥ç·©å­˜\n+                const result = this.cachedQuery(selector, context);\n+                \n+                if (result) {\n+                    results.push({\n+                        selector: selector,\n+                        count: Array.isArray(result) ? result.length : (result.nodeType ? 1 : 0),\n+                        cached: true\n+                    });\n+                    \n+                    this.cacheStats.prewarms++;\n+                    this.prewarmedSelectors.add(selector);\n+                    \n+                    console.log(`âœ“ é ç†±æˆåŠŸ: ${selector} (${results[results.length - 1].count} å€‹å…ƒç´ )`);\n+                }\n+            } catch (error) {\n+                console.warn(`âš ï¸ é ç†±é¸æ“‡å™¨å¤±æ•—: ${selector}`, error);\n+                \n+                results.push({\n+                    selector: selector,\n+                    error: error.message,\n+                    cached: false\n+                });\n+            }\n+        }\n+        \n+        console.log(`ğŸ”¥ é ç†±å®Œæˆ: ${results.filter(r => r.cached).length}/${selectors.length} å€‹é¸æ“‡å™¨å·²é ç†±`);\n+        return results;\n+    }\n+\n+    /**\n+     * æ™ºèƒ½é ç†± - åŸºæ–¼ç•¶å‰é é¢å…§å®¹è‡ªå‹•é ç†±ç›¸é—œé¸æ“‡å™¨\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡ï¼Œé»˜èªç‚º document\n+     * @returns {Promise<Array>} é ç†±çµæœ\n+     */\n+    async smartPrewarm(context = document) {\n+        const startTime = performance.now();\n+        \n+        // åŸºæ–¼ç•¶å‰é é¢åˆ†æï¼Œå‹•æ…‹ç”Ÿæˆé ç†±é¸æ“‡å™¨\n+        const dynamicSelectors = this._analyzePageForPrewarming(context);\n+        \n+        // åˆä½µé…ç½®ä¸­çš„é è¨­é¸æ“‡å™¨å’Œå‹•æ…‹ç”Ÿæˆçš„é¸æ“‡å™¨\n+        const allSelectors = [...new Set([...this.options.prewarmSelectors, ...dynamicSelectors])];\n+        \n+        const results = await this.preloadSelectors(allSelectors, context);\n+        \n+        const duration = performance.now() - startTime;\n+        console.log(`ğŸ§  æ™ºèƒ½é ç†±å®Œæˆï¼Œè€—æ™‚: ${duration.toFixed(2)}ms`);\n+        \n+        return results;\n+    }\n+\n+    /**\n+     * åŸºæ–¼ç•¶å‰é é¢å…§å®¹åˆ†æï¼Œå‹•æ…‹ç”Ÿæˆé ç†±é¸æ“‡å™¨\n+     * @private\n+     */\n+    _analyzePageForPrewarming(context) {\n+        const selectors = [];\n+        \n+        // æª¢æŸ¥é é¢çµæ§‹ï¼Œç”Ÿæˆå¯èƒ½çš„é¸æ“‡å™¨\n+        if (context.querySelector('article')) {\n+            selectors.push('article h1', 'article h2', 'article h3', 'article p', 'article img');\n+        }\n+        \n+        if (context.querySelector('[role=\"main\"]')) {\n+            selectors.push('[role=\"main\"] *');\n+        }\n+        \n+        // æª¢æŸ¥æ˜¯å¦æœ‰å¸¸è¦‹çš„ CMS é¡å\n+        const cmsPatterns = ['.entry-content', '.post-content', '.article-content', '.content-area'];\n+        cmsPatterns.forEach(pattern => {\n+            if (context.querySelector(pattern)) {\n+                selectors.push(`${pattern} p`, `${pattern} img`, `${pattern} h1`, `${pattern} h2`, `${pattern} h3`);\n+            }\n+        });\n+        \n+        return selectors;\n+    }\n+\n+    /**\n+     * æ¸…ç†éæœŸçš„ç·©å­˜é …ç›®\n+     * @param {Object} options - æ¸…ç†é¸é …\n+     * @returns {number} æ¸…ç†çš„é …ç›®æ•¸é‡\n+     */\n+    clearExpiredCache(options = {}) {\n+        const { force = false, maxAge = this.options.cacheTTL } = options;\n+        let clearedCount = 0;\n+\n+        // å¦‚æœå¼·åˆ¶æ¸…ç†ï¼Œå‰‡æ¸…ç†æ‰€æœ‰ç·©å­˜\n+        if (force) {\n+            clearedCount = this.queryCache.size;\n+            this.queryCache.clear();\n+            return clearedCount;\n+        }\n+\n+        // å¦å‰‡åªæ¸…ç†éæœŸçš„ç·©å­˜\n+        const now = Date.now();\n+        for (const [key, cached] of this.queryCache.entries()) {\n+            if (now - cached.timestamp > maxAge) {\n+                this.queryCache.delete(key);\n+                clearedCount++;\n+            }\n+        }\n+\n+        return clearedCount;\n+    }\n+\n+    /**\n+     * å¼·åˆ¶åˆ·æ–°ç‰¹å®šé¸æ“‡å™¨çš„ç·©å­˜\n+     * @param {string|Array} selectors - è¦åˆ·æ–°çš„é¸æ“‡å™¨æˆ–é¸æ“‡å™¨æ•¸çµ„\n+     * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡\n+     * @param {Object} options - æŸ¥è©¢é¸é …\n+     */\n+    refreshCache(selectors, context = document, options = {}) {\n+        const selectorList = Array.isArray(selectors) ? selectors : [selectors];\n+        \n+        for (const selector of selectorList) {\n+            const cacheKey = this._generateCacheKey(selector, context, options);\n+            if (this.queryCache.has(cacheKey)) {\n+                // åŸ·è¡Œæ–°çš„æŸ¥è©¢ä¸¦æ›´æ–°ç·©å­˜\n+                const result = this._performQuery(selector, context, options);\n+                \n+                if (result) {\n+                    this.queryCache.set(cacheKey, {\n+                        result: result,\n+                        timestamp: Date.now(),\n+                        selector: selector,\n+                        ttl: this.options.cacheTTL\n+                    });\n+                } else {\n+                    // å¦‚æœæ–°æŸ¥è©¢æ²’æœ‰çµæœï¼Œå‰‡åˆªé™¤ç·©å­˜\n+                    this.queryCache.delete(cacheKey);\n+                }\n+            }\n+        }\n+    }\n+\n     /**\n      * é åŠ è¼‰é—œéµé¸æ“‡å™¨\n      * @param {Array} selectors - é¸æ“‡å™¨æ•¸çµ„\n      * @param {Element} context - æŸ¥è©¢ä¸Šä¸‹æ–‡\n      */\n-    preloadSelectors(selectors, context = document) {\n+    preloadSelectorsOld(selectors, context = document) {\n         if (!this.options.enableCache) return;\n \n         // ä½¿ç”¨ setTimeout æ¨¡æ“¬ requestIdleCallback\n@@ -175,10 +399,28 @@ class PerformanceOptimizer {\n         this.cacheStats = {\n             hits: 0,\n             misses: 0,\n-            evictions: 0\n+            evictions: 0,\n+            prewarms: 0\n         };\n     }\n \n+    /**\n+     * ç¶­è­·ç·©å­˜å¤§å°é™åˆ¶ï¼Œå¯¦ç¾ LRU ç­–ç•¥\n+     * @private\n+     */\n+    _maintainCacheSizeLimit(newKey) {\n+        if (this.queryCache.size < this.options.cacheMaxSize) {\n+            return; // å°šæœªé”åˆ°æœ€å¤§å¤§å°ï¼Œç„¡éœ€æ¸…ç†\n+        }\n+\n+        // å¦‚æœé”åˆ°æœ€å¤§å¤§å°ï¼Œç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„é …ç›®\n+        const firstKey = this.queryCache.keys().next().value;\n+        if (firstKey && firstKey !== newKey) {\n+            this.queryCache.delete(firstKey);\n+            this.cacheStats.evictions++;\n+        }\n+    }\n+\n     /**\n      * ç²å–æ€§èƒ½çµ±è¨ˆ\n      * @returns {Object} æ€§èƒ½çµ±è¨ˆä¿¡æ¯\n@@ -193,17 +435,22 @@ class PerformanceOptimizer {\n                 size: this.queryCache.size,\n                 maxSize: this.options.cacheMaxSize,\n                 hitRate: `${cacheHitRate}%`,\n+                prewarmCount: this.prewarmedSelectors.size,\n                 ...this.cacheStats\n             },\n             batch: {\n                 queueSize: this.batchQueue.length,\n                 processing: this.processingBatch,\n-                totalOperations: this.metrics.batchOperations\n+                totalOperations: this.metrics.batchOperations,\n+                ...this.batchStats\n             },\n             queries: {\n                 total: this.metrics.domQueries,\n                 averageTime: `${this.metrics.averageQueryTime.toFixed(2)}ms`,\n                 totalTime: `${this.metrics.totalQueryTime.toFixed(2)}ms`\n+            },\n+            metrics: {\n+                ...this.metrics\n             }\n         };\n     }\n@@ -258,21 +505,21 @@ class PerformanceOptimizer {\n                 result: result,\n                 timestamp: Date.now(),\n                 queryTime: queryTime,\n-                accessCount: 1\n+                accessCount: 1,\n+                ttl: this.options.cacheTTL\n             });\n             return;\n         }\n \n-        // æª¢æŸ¥ç·©å­˜å¤§å°é™åˆ¶ï¼ˆæ–°éµï¼‰\n-        if (this.queryCache.size >= this.options.cacheMaxSize) {\n-            this._evictOldestCache();\n-        }\n+        // ç¶­è­·ç·©å­˜å¤§å°é™åˆ¶\n+        this._maintainCacheSizeLimit(key);\n \n         this.queryCache.set(key, {\n             result: result,\n             timestamp: Date.now(),\n             queryTime: queryTime,\n-            accessCount: 1\n+            accessCount: 1,\n+            ttl: this.options.cacheTTL\n         });\n     }\n \n@@ -322,6 +569,11 @@ class PerformanceOptimizer {\n         this.batchQueue.length = 0;\n \n         try {\n+            // æ›´æ–°æ‰¹è™•ç†çµ±è¨ˆ\n+            this.batchStats.totalBatches++;\n+            this.batchStats.totalItems += currentBatch.length;\n+            this.batchStats.averageBatchSize = this.batchStats.totalItems / this.batchStats.totalBatches;\n+\n             // æŒ‰é¡å‹åˆ†çµ„è™•ç†\n             const imagesBatch = currentBatch.filter(item => item.type === 'images');\n             const domBatch = currentBatch.filter(item => item.type === 'dom');\n@@ -354,6 +606,52 @@ class PerformanceOptimizer {\n         }\n     }\n \n+    /**\n+     * åˆ†æ‰¹è™•ç†æ•¸çµ„\n+     * @private\n+     */\n+    async _processInBatches(items, batchSize, processor) {\n+        const results = [];\n+        \n+        for (let i = 0; i < items.length; i += batchSize) {\n+            const batch = items.slice(i, i + batchSize);\n+            const batchPromises = batch.map(processor);\n+            const batchResults = await Promise.allSettled(batchPromises);\n+            \n+            results.push(...batchResults.map(result => \n+                result.status === 'fulfilled' ? result.value : { error: result.reason }\n+            ));\n+        }\n+        \n+        return results;\n+    }\n+    \n+    /**\n+     * æ ¹æ“šæ€§èƒ½å‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°\n+     * @private\n+     */\n+    _adjustBatchSizeForPerformance(currentSize) {\n+        // å¦‚æœæœ‰æ€§èƒ½æ­·å²æ•¸æ“šï¼Œæ ¹æ“šæ­·å²æ€§èƒ½èª¿æ•´å¤§å°\n+        if (this.metrics.averageProcessingTime && this.metrics.averageProcessingTime > 100) {\n+            // å¦‚æœå¹³å‡è™•ç†æ™‚é–“éé•·ï¼Œæ¸›å°‘æ‰¹æ¬¡å¤§å°\n+            return Math.max(1, Math.floor(currentSize * 0.7));\n+        } else if (this.metrics.averageProcessingTime && this.metrics.averageProcessingTime < 10) {\n+            // å¦‚æœè™•ç†å¾ˆå¿«ï¼Œå¯ä»¥å¢åŠ æ‰¹æ¬¡å¤§å°\n+            return Math.min(500, currentSize * 1.5);\n+        }\n+        return currentSize;\n+    }\n+    \n+    /**\n+     * è®“å‡ºæ§åˆ¶æ¬Šçµ¦ä¸»ç·šç¨‹ä»¥ä¿æŒéŸ¿æ‡‰æ€§\n+     * @private\n+     */\n+    _yieldToMain() {\n+        return new Promise(resolve => {\n+            setTimeout(() => resolve(), 1);  // çµ¦ç€è¦½å™¨æ©Ÿæœƒè™•ç†å…¶ä»–ä»»å‹™\n+        });\n+    }\n+\n     /**\n      * æ¸¬é‡å‡½æ•¸åŸ·è¡Œæ™‚é–“\n      * @param {Function} fn - è¦æ¸¬é‡çš„å‡½æ•¸\n@@ -381,6 +679,51 @@ class PerformanceOptimizer {\n         console.info(`Performance: ${name} took ${(endTime - startTime).toFixed(2)}ms`);\n         return result;\n     }\n+\n+    /**\n+     * è¨ˆç®—æœ€ä½³æ‰¹è™•ç†å¤§å°\n+     * @private\n+     */\n+    _calculateOptimalBatchSize() {\n+        // æ ¹æ“šéšŠåˆ—å¤§å°å’Œæ­·å²æ€§èƒ½æ•¸æ“šå‹•æ…‹èª¿æ•´\n+        const queueLength = this.batchQueue.length;\n+        \n+        if (queueLength === 0) return 100; // é»˜èªå¤§å°\n+        \n+        // å¦‚æœéšŠåˆ—å¾ˆé•·ï¼Œä½¿ç”¨è¼ƒå¤§çš„æ‰¹è™•ç†ä»¥æé«˜æ•ˆç‡\n+        if (queueLength > 500) return 200;\n+        if (queueLength > 200) return 150;\n+        if (queueLength > 50) return 100;\n+        \n+        // å¦‚æœéšŠåˆ—è¼ƒçŸ­ï¼Œä½¿ç”¨è¼ƒå°çš„æ‰¹è™•ç†ä»¥ä¿æŒéŸ¿æ‡‰æ€§\n+        return 50;\n+    }\n+\n+    /**\n+     * æ ¹æ“šç•¶å‰ç³»çµ±è² è¼‰èª¿æ•´æ€§èƒ½åƒæ•¸\n+     */\n+    async adjustForSystemLoad() {\n+        // ç²å–ç•¶å‰æ€§èƒ½æŒ‡æ¨™\n+        const stats = this.getPerformanceStats();\n+        \n+        // æ ¹æ“šç·©å­˜å‘½ä¸­ç‡èª¿æ•´ç­–ç•¥\n+        if (stats.cache.hitRate < 0.3) {\n+            // ç·©å­˜å‘½ä¸­ç‡ä½ï¼Œå¯èƒ½éœ€è¦å¢åŠ ç·©å­˜å¤§å°æˆ–æ¸…ç†ç­–ç•¥\n+            console.log('ğŸ“Š ç·©å­˜å‘½ä¸­ç‡è¼ƒä½ï¼Œè€ƒæ…®èª¿æ•´ç·©å­˜ç­–ç•¥');\n+        }\n+        \n+        // æ ¹æ“šå¹³å‡è™•ç†æ™‚é–“èª¿æ•´æ‰¹è™•ç†å¤§å°\n+        if (this.metrics.averageProcessingTime > 50) {\n+            // è™•ç†æ™‚é–“éé•·ï¼Œæ¸›å°‘æ‰¹è™•ç†å¤§å°\n+            console.log('â° è™•ç†æ™‚é–“éé•·ï¼Œå‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°');\n+        }\n+        \n+        // å®šæœŸæ¸…ç†éæœŸç·©å­˜\n+        const expiredCount = this.clearExpiredCache();\n+        if (expiredCount > 0) {\n+            console.log(`ğŸ§¹ æ¸…ç†äº† ${expiredCount} å€‹éæœŸçš„ç·©å­˜é …ç›®`);\n+        }\n+    }\n }\n \n module.exports = { PerformanceOptimizer };\n\\ No newline at end of file"},{"sha":"95f96f25aa7c85f5d51949cf02738cc65b211c41","filename":"tests/unit/performance/PerformanceOptimizerAdvanced.test.js","status":"added","additions":274,"deletions":0,"changes":274,"blob_url":"https://github.com/cowcfj/save-to-notion/blob/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/tests%2Funit%2Fperformance%2FPerformanceOptimizerAdvanced.test.js","raw_url":"https://github.com/cowcfj/save-to-notion/raw/a00f4f4ece242ae05b3e35d5e62db9fb46a69bac/tests%2Funit%2Fperformance%2FPerformanceOptimizerAdvanced.test.js","contents_url":"https://api.github.com/repos/cowcfj/save-to-notion/contents/tests%2Funit%2Fperformance%2FPerformanceOptimizerAdvanced.test.js?ref=a00f4f4ece242ae05b3e35d5e62db9fb46a69bac","patch":"@@ -0,0 +1,274 @@\n+/**\n+ * PerformanceOptimizer é€²éšåŠŸèƒ½æ¸¬è©¦\n+ * æ¸¬è©¦æ–°å¢çš„ç·©å­˜é ç†±ã€TTL æ©Ÿåˆ¶ã€æ‰¹è™•ç†å„ªåŒ–å’Œè‡ªé©æ‡‰åŠŸèƒ½\n+ */\n+\n+// æ¨¡æ“¬ DOM ç’°å¢ƒ\n+const { JSDOM } = require('jsdom');\n+const dom = new JSDOM(`\n+<!DOCTYPE html>\n+<html>\n+<head><title>Test</title></head>\n+<body>\n+    <div class=\"test-container\">\n+        <img src=\"test1.jpg\" alt=\"Test 1\">\n+        <img src=\"test2.jpg\" alt=\"Test 2\">\n+        <article>\n+            <h1>Article Title</h1>\n+            <p>Test paragraph 1</p>\n+            <p>Test paragraph 2</p>\n+            <img class=\"article-img\" src=\"article.jpg\" alt=\"Article image\">\n+        </article>\n+        <main>\n+            <p>Main content paragraph</p>\n+            <img class=\"main-img\" src=\"main.jpg\" alt=\"Main image\">\n+        </main>\n+        <a href=\"#test\">Test link</a>\n+    </div>\n+</body>\n+</html>\n+`);\n+\n+// è¨­ç½®å…¨å±€è®Šé‡\n+global.document = dom.window.document;\n+global.window = dom.window;\n+global.performance = {\n+    now: () => Date.now(),\n+    memory: {\n+        usedJSHeapSize: 1000000,\n+        totalJSHeapSize: 2000000,\n+        jsHeapSizeLimit: 4000000\n+    }\n+};\n+\n+// ç¢ºä¿ DOM æŸ¥è©¢æ–¹æ³•å¯ç”¨\n+global.document.querySelector = dom.window.document.querySelector.bind(dom.window.document);\n+global.document.querySelectorAll = dom.window.document.querySelectorAll.bind(dom.window.document);\n+\n+// å¼•å…¥æ€§èƒ½å„ªåŒ–å™¨\n+const { PerformanceOptimizer } = require('../../helpers/performance.testable');\n+\n+describe('PerformanceOptimizer é€²éšåŠŸèƒ½æ¸¬è©¦', () => {\n+    let optimizer;\n+\n+    beforeEach(() => {\n+        optimizer = new PerformanceOptimizer({\n+            enableCache: true,\n+            enableBatching: true,\n+            enableMetrics: true,\n+            cacheMaxSize: 100,\n+            cacheTTL: 300000 // 5åˆ†é˜ TTL\n+        });\n+    });\n+\n+    describe('TTL æ©Ÿåˆ¶å’Œç·©å­˜ç®¡ç†', () => {\n+        test('æ‡‰è©²æ”¯æŒ TTL æ©Ÿåˆ¶', () => {\n+            const selector = 'img';\n+            \n+            // ç¬¬ä¸€æ¬¡æŸ¥è©¢ï¼Œçµæœæœƒè¢«ç·©å­˜\n+            const result1 = optimizer.cachedQuery(selector, document);\n+            expect(result1).toBeDefined();\n+\n+            // é©—è­‰çµæœå·²ç·©å­˜\n+            const stats = optimizer.getPerformanceStats();\n+            expect(stats.cache.size).toBeGreaterThan(0);\n+\n+            // æª¢æŸ¥ç·©å­˜å°è±¡æ˜¯å¦åŒ…å« TTL ä¿¡æ¯\n+            const cacheKeys = Array.from(optimizer.queryCache.keys());\n+            if (cacheKeys.length > 0) {\n+                const cachedItem = optimizer.queryCache.get(cacheKeys[0]);\n+                expect(cachedItem).toHaveProperty('timestamp');\n+                expect(cachedItem).toHaveProperty('ttl');\n+            }\n+        });\n+\n+        test('æ‡‰è©²æ¸…ç†éæœŸç·©å­˜', () => {\n+            const selector = 'p';\n+            \n+            // æ·»åŠ é …ç›®åˆ°ç·©å­˜\n+            optimizer.cachedQuery(selector, document);\n+            expect(optimizer.getPerformanceStats().cache.size).toBeGreaterThan(0);\n+\n+            // æ‰‹å‹•è¨­ç½®ä¸€å€‹éæœŸçš„ç·©å­˜é …ç›®\n+            const expiredKey = 'expired_test_key';\n+            optimizer.queryCache.set(expiredKey, {\n+                result: 'test_result',\n+                timestamp: Date.now() - 400000, // 5åˆ†é˜å‰ï¼Œå·²éæœŸ\n+                ttl: 300000\n+            });\n+\n+            // æ¸…ç†éæœŸç·©å­˜\n+            const clearedCount = optimizer.clearExpiredCache();\n+            \n+            // æ‡‰è©²è‡³å°‘æ¸…ç†ä¸€å€‹éæœŸé …ç›®\n+            expect(clearedCount).toBeGreaterThanOrEqual(1);\n+            \n+            // å¦‚æœæ¸…ç†äº†é …ç›®ï¼Œå‰‡ç•¶å‰ç·©å­˜å¤§å°æ‡‰å°æ–¼æˆ–ç­‰æ–¼åŸå§‹å¤§å°\n+            const finalStats = optimizer.getPerformanceStats();\n+            expect(finalStats.cache.size).toBeGreaterThanOrEqual(0);\n+        });\n+\n+        test('æ‡‰è©²å¼·åˆ¶åˆ·æ–°ç‰¹å®šé¸æ“‡å™¨ç·©å­˜', () => {\n+            const selector = 'a';\n+            \n+            // åˆå§‹æŸ¥è©¢\n+            const result1 = optimizer.cachedQuery(selector, document);\n+            expect(result1).toBeDefined();\n+\n+            // åˆ·æ–°ç·©å­˜\n+            optimizer.refreshCache(selector);\n+\n+            // å†æ¬¡æŸ¥è©¢ï¼Œé›–ç„¶ç·©å­˜è¢«åˆ·æ–°ï¼Œä½†çµæœæ‡‰è©²ç›¸åŒ\n+            const result2 = optimizer.cachedQuery(selector, document);\n+            expect(result2).toBeDefined();\n+        });\n+\n+        test('æ‡‰è©²ç¶­è­·ç·©å­˜å¤§å°é™åˆ¶', () => {\n+            // å‰µå»ºä¸€å€‹å°å®¹é‡çš„å„ªåŒ–å™¨\n+            const smallOptimizer = new PerformanceOptimizer({\n+                cacheMaxSize: 2,\n+                cacheTTL: 300000\n+            });\n+\n+            // æ·»åŠ è¶…éé™åˆ¶çš„æŸ¥è©¢\n+            smallOptimizer.cachedQuery('img');\n+            smallOptimizer.cachedQuery('p');\n+            smallOptimizer.cachedQuery('a');  // é€™æ‡‰è©²è§¸ç™¼ LRU é©…é€\n+\n+            const stats = smallOptimizer.getPerformanceStats();\n+            expect(stats.cache.size).toBeLessThanOrEqual(2);\n+        });\n+    });\n+\n+    describe('ç·©å­˜é ç†±åŠŸèƒ½', () => {\n+        test('æ‡‰è©²é ç†±é¸æ“‡å™¨', async () => {\n+            const selectors = ['img', 'p', 'article'];\n+            \n+            // é ç†±é¸æ“‡å™¨\n+            const results = await optimizer.preloadSelectors(selectors);\n+            \n+            expect(Array.isArray(results)).toBe(true);\n+            expect(results.length).toBe(selectors.length);\n+            \n+            // é©—è­‰é ç†±è¨ˆæ•¸å¢åŠ \n+            const stats = optimizer.getPerformanceStats();\n+            expect(stats.cache.prewarms).toBeGreaterThan(0);\n+            expect(stats.cache.hitRate).toBeDefined();\n+        });\n+\n+        test('æ‡‰è©²é€²è¡Œæ™ºèƒ½é ç†±', async () => {\n+            // åŸ·è¡Œæ™ºèƒ½é ç†±\n+            const results = await optimizer.smartPrewarm(document);\n+            \n+            expect(Array.isArray(results)).toBe(true);\n+            expect(results.length).toBeGreaterThanOrEqual(0);\n+            \n+            // ç¢ºä¿ä¸€äº›é¸æ“‡å™¨è¢«é ç†±\n+            const stats = optimizer.getPerformanceStats();\n+            expect(stats.cache.prewarms).toBeGreaterThanOrEqual(0);\n+            \n+            // é©—è­‰é ç†±é¸æ“‡å™¨è¨ˆæ•¸\n+            expect(stats.cache.prewarmCount).toBeGreaterThanOrEqual(0);\n+        });\n+\n+        test('æ‡‰è©²é¿å…é‡è¤‡é ç†±ç›¸åŒé¸æ“‡å™¨', async () => {\n+            const selector = 'img';\n+            \n+            // ç¬¬ä¸€æ¬¡é ç†±\n+            const result1 = await optimizer.preloadSelectors([selector]);\n+            \n+            // ç¬¬äºŒæ¬¡é ç†±ç›¸åŒçš„é¸æ“‡å™¨\n+            const result2 = await optimizer.preloadSelectors([selector]);\n+            \n+            // ç¬¬äºŒæ¬¡é ç†±ä¸æ‡‰ç”¢ç”Ÿæ–°çš„é ç†±è¨ˆæ•¸\n+            const stats = optimizer.getPerformanceStats();\n+            expect(stats.cache.prewarms).toBeGreaterThanOrEqual(0);\n+        });\n+    });\n+\n+    describe('æ”¹é€²çš„æ‰¹è™•ç†ç³»çµ±', () => {\n+        test('æ‡‰è©²å‹•æ…‹è¨ˆç®—æœ€ä½³æ‰¹è™•ç†å¤§å°', () => {\n+            // æ¸¬è©¦ä¸åŒçš„éšŠåˆ—å¤§å°\n+            const size0 = optimizer._calculateOptimalBatchSize.call(optimizer);\n+            expect(size0).toBe(100); // é»˜èªå¤§å°\n+\n+            // æ¨¡æ“¬ä¸åŒéšŠåˆ—é•·åº¦\n+            optimizer.batchQueue = new Array(10);\n+            const size1 = optimizer._calculateOptimalBatchSize.call(optimizer);\n+            expect(size1).toBe(50); // ä¸­ç­‰å¤§å°\n+\n+            optimizer.batchQueue = new Array(300);\n+            const size2 = optimizer._calculateOptimalBatchSize.call(optimizer);\n+            expect(size2).toBe(150); // è¼ƒå¤§\n+\n+            optimizer.batchQueue = new Array(600);\n+            const size3 = optimizer._calculateOptimalBatchSize.call(optimizer);\n+            expect(size3).toBe(200); // æœ€å¤§\n+        });\n+\n+        test('æ‡‰è©²æ”¯æŒéé˜»å¡æ‰¹è™•ç†', async () => {\n+            const items = Array.from({ length: 25 }, (_, i) => ({ id: i, value: `item${i}` }));\n+            const processor = (item) => ({ ...item, processed: true });\n+\n+            // ä½¿ç”¨æ‰¹è™•ç†è™•ç†é …ç›®\n+            const results = await optimizer._processInBatches(items, 10, processor);\n+\n+            expect(results).toHaveLength(25);\n+            expect(results.every(r => r.processed)).toBe(true);\n+        });\n+\n+        test('æ‡‰è©²æ ¹æ“šæ€§èƒ½å‹•æ…‹èª¿æ•´æ‰¹è™•ç†å¤§å°', () => {\n+            const originalSize = 50;\n+\n+            // æ¨¡æ“¬ä½æ€§èƒ½å ´æ™¯\n+            optimizer.metrics.averageProcessingTime = 200; // é«˜è™•ç†æ™‚é–“\n+            const adjustedSize1 = optimizer._adjustBatchSizeForPerformance.call(optimizer, originalSize);\n+            expect(adjustedSize1).toBeLessThan(originalSize);\n+\n+            // æ¨¡æ“¬é«˜æ€§èƒ½å ´æ™¯\n+            optimizer.metrics.averageProcessingTime = 5; // ä½è™•ç†æ™‚é–“\n+            const adjustedSize2 = optimizer._adjustBatchSizeForPerformance.call(optimizer, originalSize);\n+            expect(adjustedSize2).toBeGreaterThan(originalSize);\n+        });\n+    });\n+\n+    describe('è‡ªé©æ‡‰æ€§èƒ½åŠŸèƒ½', () => {\n+        test('æ‡‰è©²åˆå§‹åŒ–è‡ªé©æ‡‰ç®¡ç†å™¨', () => {\n+            // å‰µå»ºå¸¶æœ‰è‡ªé©æ‡‰åŠŸèƒ½çš„å„ªåŒ–å™¨\n+            const adaptiveOptimizer = new PerformanceOptimizer({\n+                enableCache: true,\n+                enableBatching: true,\n+                enableMetrics: true,\n+                enableAdaptive: true\n+            });\n+\n+            // æª¢æŸ¥æ˜¯å¦åˆå§‹åŒ–äº†è‡ªé©æ‡‰ç®¡ç†å™¨\n+            // ç”±æ–¼ AdaptivePerformanceManager å¯èƒ½ä¸å­˜åœ¨æ–¼æ¸¬è©¦ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘æ¸¬è©¦å®ƒçš„å­˜åœ¨æ€§\n+            expect(adaptiveOptimizer).toBeDefined();\n+        });\n+\n+        test('æ‡‰è©²åˆ†æé é¢å…§å®¹', () => {\n+            const analysis = optimizer._analyzePageForPrewarming(document);\n+            expect(Array.isArray(analysis)).toBe(true);\n+            \n+            // æ‡‰è©²åŒ…å«ä¸€äº›åŸºæ–¼æ–‡æª”çµæ§‹çš„é¸æ“‡å™¨\n+            expect(analysis.length).toBeGreaterThanOrEqual(0);\n+        });\n+\n+        test('æ‡‰è©²è®“å‡ºæ§åˆ¶æ¬Šçµ¦ä¸»ç·šç¨‹', async () => {\n+            // æ¸¬è©¦è®“å‡ºæ§åˆ¶æ¬ŠåŠŸèƒ½\n+            const result = await optimizer._yieldToMain.call(optimizer);\n+            expect(result).toBeUndefined(); // setTimeout(resolve) è¿”å› undefined\n+        });\n+    });\n+\n+    describe('ç³»çµ±è² è¼‰èª¿æ•´', () => {\n+        test('æ‡‰è©²æ ¹æ“šç³»çµ±è² è¼‰èª¿æ•´æ€§èƒ½åƒæ•¸', async () => {\n+            // æ¨¡æ“¬ä¸åŒæ€§èƒ½å ´æ™¯ä¸¦æ¸¬è©¦èª¿æ•´\n+            optimizer.metrics.averageProcessingTime = 100; // å‡è¨­è™•ç†æ™‚é–“è¼ƒé•·\n+            \n+            // æ¸¬è©¦èª¿æ•´åŠŸèƒ½ä¸æ‹‹å‡ºéŒ¯èª¤\n+            await expect(optimizer.adjustForSystemLoad()).resolves.not.toThrow();\n+        });\n+    });\n+});\n\\ No newline at end of file"}]