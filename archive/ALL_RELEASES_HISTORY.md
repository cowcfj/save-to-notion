# 🎉 Notion Smart Clipper v2.1 發布說明

## 🚀 重大更新：智能標記系統

這個版本帶來了全新的智能標記功能，讓你可以在保存的網頁上進行標記，並實時同步到 Notion！

## ✨ 新功能

### 📝 多顏色標記系統
- **4種標記顏色**：黃色、綠色、藍色、紅色
- **直觀操作**：選中文字即可標記
- **靈活管理**：雙擊標記可刪除單個標記

### 🔄 實時同步功能
- **即時同步**：點擊「同步」按鈕將標記保存到 Notion
- **智能更新**：多次標記會正確更新，不會重複
- **狀態追蹤**：清晰的同步狀態提示

### 💾 持久化存儲
- **自動保存**：標記狀態自動保存到本地
- **頁面恢復**：重新訪問頁面時自動恢復標記
- **跨會話保持**：關閉瀏覽器後標記依然存在

### 🛠️ 智能狀態管理
- **自動檢測**：檢測 Notion 頁面是否被刪除
- **智能清除**：頁面被刪除時自動清除本地標記狀態
- **手動重置**：提供手動清除標記的選項

## 🔧 技術改進

### 📊 增強調試功能
- 詳細的控制台日誌輸出
- 完整的操作過程追蹤
- 便於問題定位和排查

### 🎯 優化用戶體驗
- 更直觀的操作界面
- 清晰的狀態提示
- 完善的錯誤處理

### 🔒 穩定性提升
- 改進的 API 錯誤處理
- 更好的邊界條件處理
- 增強的容錯機制

## 📖 使用指南

### 開始標記
1. 保存網頁到 Notion
2. 點擊「📝 Start Highlighting」
3. 選擇標記顏色
4. 選中文字進行標記

### 同步標記
1. 完成標記後點擊「同步」
2. 標記會自動添加到 Notion 頁面
3. 多次標記會正確更新內容

### 管理標記
- **刪除單個標記**：雙擊標記
- **清除所有標記**：點擊「🗑️ Clear Highlights」
- **查看標記數量**：工具欄顯示當前標記數

## 🧪 測試場景

我們已經完成了全面的測試：

✅ **多次標記同步**：第一次、第二次標記都能正確同步  
✅ **自動狀態清除**：Notion 頁面被刪除時自動清除標記  
✅ **手動標記管理**：手動清除功能正常工作  

## 🔄 升級說明

從 v2.0 升級到 v2.1：
1. 下載最新版本文件
2. 在 Chrome 擴展管理頁面重新載入擴展
3. 現有的保存功能不受影響
4. 新的標記功能立即可用

## 🎯 下一步計劃

- 批量操作功能
- 更多標記樣式選項
- 標記導出功能
- 協作標記功能

---

**感謝使用 Notion Smart Clipper！** 🙏

如有問題或建議，歡迎在 GitHub 上提交 Issue。# Release Notes — v2.2

Date: 2025-09-20

Highlights
- URL normalization for all storage keys: strips fragments, removes common tracking params (utm_*, gclid, fbclid), trims non-root trailing slash.
- Dynamic highlight restore injection: removed global content_script; background injects `scripts/highlight-restore.js` only when highlights exist for the page.
- Automatic migration: legacy `localStorage` highlights are migrated to `chrome.storage.local` on page load if needed, then restored.
- Permissions tightened: removed unused `identity` from `manifest.json`.

Developer Notes
- Keys now use `saved_<normalizedUrl>` and `highlights_<normalizedUrl>`.
- Background listens to `tabs.onUpdated` and performs detection/migration then injection.
- highlight persistence prioritizes `chrome.storage.local` with legacy fallback.

Verification Checklist
- Update from v2.1: open a page with old highlights → auto-migrated and restored.
- Create/edit/delete highlights → persist via `chrome.storage.local` across reloads.
- Delete associated Notion page → local saved state and highlights cleared.
# Notion Smart Clipper v2.3.0 發布說明

## 🎉 重大更新：代碼架構重構與核心功能修復

這是一個重要的維護版本，專注於修復核心功能問題和重構代碼架構，為未來的功能開發奠定穩固基礎。

### 🔥 主要功能修復

#### ✅ 標記狀態保存修復
- **問題**：頁面重新整理後標記會丟失
- **解決**：重構標記保存和恢復機制
- **結果**：標記現在能可靠地在頁面重新載入後恢復

#### ✅ 單個標記刪除修復  
- **問題**：從存儲恢復的標記無法透過雙擊刪除
- **解決**：為所有標記（包括恢復的）添加事件監聽器
- **結果**：所有標記現在都支援雙擊刪除功能

### 🏗️ 代碼架構重構

#### 統一腳本注入管理
- 新增 `ScriptInjector` 類統一管理所有腳本注入操作
- 標準化錯誤處理和日誌記錄
- 簡化複雜的腳本注入邏輯

#### 共享工具模組
- 建立 `scripts/utils.js` 共享工具模組
- 消除跨文件的代碼重複
- 統一 URL 標準化和存儲操作

#### 現代化異步處理
- 將所有回調函數重構為 `async/await` 模式  
- 消除"回調地獄"，提高代碼可讀性
- 改善錯誤處理流程

### 📈 效能和穩定性提升

- **更可靠的標記恢復**：優化時序和錯誤處理
- **更快的腳本注入**：減少重複操作和等待時間
- **更好的錯誤處理**：統一的異常管理和日誌記錄
- **更高的代碼品質**：消除技術債務，提升可維護性

### 🛡️ 向後兼容性

- 完全保持現有功能和用戶體驗
- 支援舊版本數據自動遷移
- 無需重新配置，升級後即可使用

### 🔧 開發者改進

- **模組化架構**：更容易添加新功能
- **統一的 API**：一致的函數命名和錯誤處理
- **完整的日誌**：便於問題診斷和除錯
- **清晰的代碼結構**：提高團隊協作效率

### 📋 完整功能列表

✅ 網頁內容智能提取和保存到 Notion  
✅ 頁面標記工具（4種顏色）  
✅ 標記保存和自動恢復  
✅ 單個標記刪除（雙擊）  
✅ 批量標記清除  
✅ 標記同步到 Notion 頁面  
✅ 圖片自動上傳  
✅ 頁面狀態管理  
✅ 多種存儲後備機制  

### 🚀 未來展望

這次重構為未來的功能開發建立了穩固的基礎：
- 更容易添加新的標記功能
- 更簡單的第三方服務整合
- 更高效的性能優化
- 更強大的錯誤恢復機制

---

## 安裝和使用

1. 下載最新版本的擴展檔案
2. 在 Chrome 中載入解包的擴展程式
3. 配置 Notion API 金鑰和資料庫 ID
4. 開始使用增強的標記和保存功能！

感謝所有用戶的反饋和耐心測試！🙏# 🚀 Notion Smart Clipper v2.4.8 發布說明

**發布日期：** 2025年9月29日  
**版本類型：** 功能增強和問題修復  
**重要程度：** 推薦更新

---

## 🎯 本次更新重點

### ✨ **全新雙重標記刪除系統**
完全重構了文本標記的刪除功能，提供兩種靈活的刪除方式，徹底解決了之前雙擊刪除的各種問題。

---

## 🔥 **主要新功能**

### 🖱️ **改進的雙擊刪除**
- **徹底修復選中問題**：解決之前雙擊只選中部分字符的問題
- **可靠的事件處理**：防止刪除功能失效
- **智能文本選擇清除**：避免誤選操作
- **確認對話框**：防止意外刪除

### ⌘ **全新 Ctrl/Cmd + 點擊快速刪除**
- **快速操作**：按住 `Ctrl`(Windows) 或 `Cmd`(Mac) + 點擊標記
- **無需確認**：直接刪除，適合頻繁標記操作
- **跨平台兼容**：自動適配 Windows 和 Mac
- **不影響正常操作**：普通點擊和文本選擇完全正常

---

## 🛠️ **技術改進**

### 🎨 **用戶體驗優化**
- **智能提示**：tooltip 清楚說明兩種刪除方式
- **操作隔離**：各種點擊事件互不干擾
- **文本選擇保護**：普通操作不會被標記功能影響

### 🔧 **代碼架構優化**
- **統一事件處理**：所有標記類型使用相同的刪除邏輯
- **跨組件兼容**：包括簡單標記、複雜標記和備用系統
- **錯誤處理增強**：更可靠的DOM操作和狀態管理

---

## 🎯 **使用指南**

### 📝 **兩種刪除方式**

#### 方式一：雙擊刪除（推薦日常使用）
1. 雙擊任何標記文本
2. 確認刪除對話框
3. 標記被移除

#### 方式二：Ctrl/Cmd + 點擊（推薦快速操作）
1. 按住 `Ctrl`(Windows) 或 `Cmd`(Mac)
2. 點擊標記文本
3. 標記立即被移除（無需確認）

### 💡 **使用建議**
- **日常閱讀**：使用雙擊刪除，有確認步驟更安全
- **批量整理**：使用 Ctrl/Cmd + 點擊，操作更快速
- **正常操作**：普通點擊和文本選擇完全不受影響

---

## 📈 **性能改進**

- **事件處理優化**：減少不必要的事件監聽器
- **DOM操作改進**：更安全的標記元素操作
- **內存使用優化**：及時清理事件和DOM引用

---

## 🔧 **修復的問題**

### 解決的用戶反饋問題
- ✅ 修復雙擊刪除時只選中部分字符的問題
- ✅ 修復雙擊刪除功能失效的問題  
- ✅ 修復標記後文本無法正常選擇的問題
- ✅ 修復不同刪除方式相互衝突的問題

### 技術問題修復
- ✅ 統一所有標記創建點的事件處理
- ✅ 改進事件委託和清理機制
- ✅ 修復跨元素標記的刪除兼容性
- ✅ 優化錯誤處理和調試信息

---

## 🔄 **升級說明**

### 自動升級
- 現有標記會自動獲得新的刪除功能
- 無需重新標記內容
- 設置和數據完全保留

### 兼容性
- ✅ Chrome 88+
- ✅ 所有現有功能保持不變
- ✅ 向後兼容之前版本的標記數據

---

## 🎉 **下一步計劃**

### 近期計劃（v2.5.x）
- 自動跨元素標記（無需先進行單元素標記）
- 多顏色標記管理界面
- 標記導出和分享功能

### 長期規劃
- 標記同步到雲端
- 協作標記功能
- AI 智能標記建議

---

## 📞 **技術支持**

- **GitHub Issues：** [報告問題](https://github.com/cowcfj/save-to-notion/issues)
- **功能建議：** [提交建議](https://github.com/cowcfj/save-to-notion/discussions)
- **使用幫助：** 查看擴展內的幫助文檔

---

## 🙏 **感謝**

感謝所有用戶的反饋和測試，特別是對標記刪除功能問題的詳細報告，這幫助我們完善了整個系統。

---

**🌟 喜歡這個擴展嗎？請在 [GitHub](https://github.com/cowcfj/save-to-notion) 給我們一個星星！**

**📝 遇到問題或有建議？歡迎 [提交 Issue](https://github.com/cowcfj/save-to-notion/issues/new)！**# 🔧 Notion Smart Clipper v2.4.9 修復版本

**發布日期：** 2025年10月1日  
**版本類型：** 錯誤修復  
**重要程度：** 推薦更新

---

## 🐛 **主要修復**

### 🚨 **修復 Notion API 文本長度限制錯誤**

**問題描述：**
- 在保存某些包含超長段落的網頁時，會出現錯誤：
  ```
  Failed to save: body failed validation: 
  body.children[1].paragraph.rich_text[0].text.content.length 
  should be ≤ 2000, instead was 2262.
  ```

**根本原因：**
- Notion API 限制單個 `rich_text` 區塊最多只能包含 2000 個字符
- 原代碼直接將整個段落文本放入單個區塊，未檢查長度限制

**解決方案：**
- ✅ 新增 `splitTextForHighlight()` 函數，智能分割超長文本
- ✅ 優先在標點符號處分割（句號、問號、驚嘆號、換行符）
- ✅ 如無合適標點，在空格處分割
- ✅ 確保分割後的片段至少達到原長度的 50%，避免過度碎片化

---

## 🔧 **技術改進**

### 📝 **文本分割邏輯**

#### **分割優先級：**
1. **雙換行符** (`\n\n`) - 自然段落分隔
2. **單換行符** (`\n`) - 行分隔
3. **中文標點** (`。？！`) - 句子結束
4. **英文標點** (`. ? !`) - 句子結束
5. **空格** (` `) - 詞語分隔
6. **強制分割** - 最後手段，在 2000 字符處強制分割

#### **分割策略：**
- 避免在單詞中間分割
- 確保每個片段至少有原長度的 50%
- 自動過濾空字符串
- 保留原文格式和完整性

### 🎯 **修復範圍**

#### **1. 內容保存功能**
```javascript
// convertHtmlToNotionBlocks() 函數中
case 'P':
    if (textContent) {
        // 新增：將長段落分割成多個段落
        const paragraphChunks = splitTextForHighlight(textContent, 2000);
        paragraphChunks.forEach(chunk => {
            blocks.push({
                object: 'block',
                type: 'paragraph',
                paragraph: {
                    rich_text: [{ type: 'text', text: { content: chunk } }]
                }
            });
        });
    }
    break;
```

#### **2. 標題處理**
```javascript
case 'H1': case 'H2': case 'H3':
    if (textContent) {
        // 新增：標題也需要處理長度限制
        const headingChunks = splitTextForHighlight(textContent, 2000);
        headingChunks.forEach((chunk, index) => {
            // 第一個片段保持為標題，後續片段降級為段落
            blocks.push({
                object: 'block',
                type: index === 0 ? `heading_${node.nodeName[1]}` : 'paragraph',
                ...
            });
        });
    }
    break;
```

#### **3. 標記同步功能**
```javascript
highlights.forEach((highlight, index) => {
    // 新增：處理超長標記文本
    const textChunks = splitTextForHighlight(highlight.text, 2000);
    
    textChunks.forEach((chunk, chunkIndex) => {
        highlightBlocks.push({
            object: 'block',
            type: 'paragraph',
            paragraph: {
                rich_text: [{
                    type: 'text',
                    text: { content: chunk },
                    annotations: {
                        color: highlight.color
                    }
                }]
            }
        });
    });
});
```

---

## ✅ **測試驗證**

### 📋 **測試場景**
- ✅ 保存包含超長段落（2000+ 字符）的網頁
- ✅ 標記超長文本片段並同步到 Notion
- ✅ 處理包含特殊字符的長文本
- ✅ 驗證分割後的文本完整性

### 🎯 **測試結果**
- ✅ 成功保存之前失敗的網頁（如 https://www.filmcritics.org.hk/zh-hant/node/3446）
- ✅ 文本內容完整，無丟失
- ✅ 分割位置合理，閱讀體驗良好
- ✅ 標記功能正常，顏色保留

---

## 🔄 **升級說明**

### 自動升級
- Chrome Web Store 會自動更新到 v2.4.9
- 無需重新配置，所有設定保留
- 向後兼容，不影響現有功能

### 手動安裝
1. 下載 `notion-smart-clipper-v2.4.9.zip`
2. 解壓縮到本地目錄
3. Chrome 擴展管理頁面載入解壓後的文件夾

---

## 📊 **影響範圍**

### ✅ **已修復**
- 保存超長段落內容時的錯誤
- 標記超長文本時的同步失敗
- Notion API 驗證錯誤

### ⚠️ **副作用**
- 超長段落會被自動分割成多個段落
- 超長標題會被分割，後續部分降級為段落
- 對於 99% 的正常使用場景無影響

---

## 🎉 **下一步計劃**

按照 PROJECT_ROADMAP.md 繼續開發 v2.5.x 功能：
- 保存後提供打開頁面鏈接
- 按鈕顯示保存狀態
- 擷取網站 Icon
- 商店更新說明彈出

---

**🔧 這是一個重要的修復版本，解決了保存特定網頁時的致命錯誤。建議所有用戶更新！**

**📝 問題報告：** [GitHub Issues](https://github.com/cowcfj/save-to-notion/issues)  
**📖 使用說明：** 查看擴展內的 help.html# Notion Smart Clipper v2.4.0 發布說明

🗓️ **發布日期**: 2024年9月24日  
🏷️ **版本**: v2.4.0  
📦 **大小**: ~80KB  

## 🎯 本次更新重點

這個版本專注於**數據管理和性能優化**，回應用戶對於數據安全性和擴展性能的關切。

### 🌟 主要新功能

#### 📊 **完整的數據監控系統**
- **實時存儲監控**: 可視化顯示當前存儲使用情況
- **詳細統計信息**: 標記頁面數、總標記數、配置項目數
- **智能警告系統**: 自動提醒存儲使用率和性能建議
- **使用情況分析**: 幫助用戶了解數據增長趨勢

#### ⚡ **智能數據優化功能**
- **數據重整優化**: 
  - 壓縮數據結構，節省 10-30% 存儲空間
  - 重建索引，提升載入速度 20-50%
  - 整理數據碎片，改善響應時間
  - **保證**: 保留所有標記內容，只優化結構

- **安全清理系統**:
  - 只清理空白無用的頁面記錄
  - **明確保證**: 不會影響 Notion 中已保存的任何頁面
  - 清理前預覽功能，完全透明化操作

#### 🛡️ **增強的數據管理**
- **一鍵備份恢復**: 快速導出/導入所有數據
- **數據完整性檢查**: 自動檢測和修復損壞數據
- **智能備份建議**: 基於使用情況的自動提醒

### 🎨 **用戶體驗改進**

#### 🎯 **重新設計的數據管理界面**
- 更直觀的存儲使用情況顯示
- 清晰的功能分類和說明
- 所有操作都有詳細的預覽功能
- 明確區分擴展數據和 Notion 數據的操作範圍

#### 📈 **性能監控增強**
- 實時性能指標顯示
- 智能優化建議系統
- 存儲空間使用效率分析
- 操作前後效果對比

### 🔧 **技術改進**

#### 📊 **存儲容量分析**
根據用戶反饋，我們深入分析了擴展的容量限制：

- **Chrome 存儲限制**: 5MB 總容量
- **最佳體驗範圍**: < 1,000 頁面，每頁 < 20 標記
- **良好體驗範圍**: 1,000-3,000 頁面，每頁 < 15 標記
- **可用體驗範圍**: 3,000-5,000 頁面，每頁 < 10 標記

#### ⚡ **性能優化算法**
- 新增數據壓縮算法，提升存儲效率
- 實現智能索引重建，加快數據查找
- 添加碎片整理功能，改善整體響應速度

### 📋 **用戶指南**

#### 🚀 **如何使用新功能**

1. **查看存儲使用情況**:
   - 進入擴展設定頁面
   - 滾動到「數據管理」區域
   - 查看實時存儲使用情況

2. **執行數據優化**:
   - 點擊「分析優化效果」查看預期改善
   - 確認後點擊「執行數據重整」
   - 系統會自動完成優化並報告結果

3. **安全清理數據**:
   - 勾選「清理空白頁面記錄」
   - 點擊「預覽清理效果」確認範圍
   - 執行清理以釋放存儲空間

#### 🛡️ **數據安全保證**

- ✅ **Chrome 官方保證**: 擴展升級不會丟失 storage.local 數據
- ✅ **雙重備份機制**: 主存儲 + localStorage 備份
- ✅ **手動備份選項**: 用戶可隨時備份和恢復數據
- ✅ **操作透明化**: 所有操作都有預覽和確認步驟

### 🔄 **升級說明**

#### 從 v2.3.0 升級:
- **數據兼容**: 完全兼容，無需任何操作
- **新功能**: 自動啟用，直接使用
- **設定保留**: 所有現有設定和標記都會保留

#### 推薦升級後操作:
1. 執行一次「檢查數據完整性」
2. 查看存儲使用情況
3. 如果使用率較高，考慮執行數據優化

### 📊 **版本統計**

- **新增文件**: 8 個技術文檔和用戶指南
- **修改文件**: 4 個 (manifest.json, options.html, options.css, options.js)
- **代碼增量**: ~300 行新增功能代碼
- **功能增強**: 6 個主要新功能模組

### 🙏 **致謝**

感謝用戶對數據安全性和性能的關注，您的反饋直接推動了這次重要更新。

---

**🔗 下載地址**: [GitHub Releases](https://github.com/cowcfj/save-to-notion/releases/tag/v2.4.0)  
**🐛 問題回報**: [GitHub Issues](https://github.com/cowcfj/save-to-notion/issues)  
**📖 完整文檔**: [使用指南](../README.md)